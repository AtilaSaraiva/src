
######################### SUITE DEFINITIONS ###############

# home
PATHTOHERE = $(shell (exec /bin/pwd))
HOSTFILE   = /home/symes/asterix_hostfile
NPROCS     = 0

std.x: FORCE
	@(${RM} std.x)
	@(if [ ! -x ${PATHTOHERE}/../../../../iwave/demo//model/main/standardmodel.x ] ; then ( cd ${PATHTOHERE}/../../../../iwave/demo/model; /bin/cp ${PROJROOT}/../admin/makefile.boot Makefile; make install; cd ${PATHTOHERE} ); fi)
	@(ln -s ${PATHTOHERE}/../../../../iwave/demo/model/main/standardmodel_elastic.x std.x)

xwave_esg.x: FORCE
	${RM} xwave_esg.x
	if [ ! -x ${PROJROOT}/esg/main/esg.x ] ; then ( cd ${PROJROOT}; make -f MakeBuild; cd ${PATHTOHERE} ); fi
	ln -s ${PROJROOT}/esg/main/esg.x xwave_esg.x

iwave_esg: FORCE
	${RM} iwave_esg.x	
	if [ ! -x ${PROJROOT}/../iwave/esg/main/main.v1.x ] ; then ( cd ${PROJROOT/../iwave}; make -f MakeBuild; cd ${PATHTOHERE} ); fi
	ln -s ${PROJROOT}/../iwave//esg/main/main.v1.x iwave_esg.x

# list of all tests defined in this file
ALLTESTS := test1.su test2.su test3.su test4.su test5.su test6.su test7.su test8.su

# what to do with them
alltests:
	${MAKE} clean;
	for name in ${ALLTESTS} ; do \
	  ${MAKE} $${name} ; \
        done

########################## TEST DEFINITIONS ############################

test%_dn.rsf: std.x tests.er
	./std.x model=$(subst test,,$(subst _dn.rsf,,$@)) hfile=$@ choose=1 d1=10 d2=10 d3=10 n1=80 n2=80 n3=1

test%_dn.rsf@:
	${MAKE} test$(subst test,,$(subst _dn.rsf@,,$@))_dn.rsf

test%_vp.rsf: std.x tests.er
	./std.x model=$(subst test,,$(subst _vp.rsf,,$@)) hfile=$@ choose=2 d1=10 d2=10 d3=10 n1=80 n2=80 n3=1

test%_vp.rsf@:
	${MAKE} test$(subst test,,$(subst _vp.rsf@,,$@))_vp.rsf

test%_vs.rsf: std.x tests.er
	./std.x model=$(subst test,,$(subst _vs.rsf,,$@)) hfile=$@ choose=3 d1=10 d2=10 d3=10 n1=80 n2=80 n3=1

test%_vs.rsf@:
	${MAKE} test$(subst test,,$(subst _vs.rsf@,,$@))_vs.rsf

test%_lambda.rsf: std.x tests.er
	./std.x model=$(subst test,,$(subst _lambda.rsf,,$@)) hfile=$@ choose=4 d1=10 d2=10 d3=10 n1=80 n2=80 n3=1

test%_lambda.rsf@:
	${MAKE} test$(subst test,,$(subst _lambda.rsf@,,$@))_lambda.rsf

test%_mu.rsf: std.x tests.er
	./std.x model=$(subst test,,$(subst _mu.rsf,,$@)) hfile=$@ choose=5 d1=10 d2=10 d3=10 n1=80 n2=80 n3=1

test%_mu.rsf@:
	${MAKE} test$(subst test,,$(subst _mu.rsf@,,$@))_mu.rsf

hdr.su: tests.er
	sunull nt=600 ntr=4800 dt=0.002 | sushw key=sx a=0 c=0 j=60| sushw key=gx a=-400 c=20 j=60 | sushw key=delrt a=0| sushw key=selev a=-40 | sushw key=gelev a=-0 b=-20 c=0 j=60 > $@

hdr1.su: tests.er
	sunull nt=1500 ntr=40 dt=0.002 | sushw key=sx a=400 c=0 j=40| sushw key=gx a=0 b=20 j=40 | sushw key=delrt a=0| sushw key=selev a=-40 | sushw key=gelev a=-20 b=0 c=0 j=40 > $@

mysrc.su: tests.er 
	#./srcGen.sh
	suwaveform type=ricker1 fpeak=5 | sushw key=gelev a=-40 | sushw key=gx a=400 | sugain scale=10000 >> $@

test%.su: hdr.su mysrc.su test%_dn.rsf test%_dn.rsf@ test%_lambda.rsf test%_lambda.rsf@ test%_mu.rsf test%_mu.rsf@ test%.par xwave_esg.x
	mpiexec -n 2 ./xwave_esg.x par=test$(subst test,,$(subst .su,,$@)).par

test%.par: tests.er	
	@(echo INPUT DATA FOR iwave > $@; \
	echo >> $@; \
	echo ------------------------------------------------------------------------>> $@; \
	echo FD:>> $@; \
	echo >> $@; \
	echo "         model = sgn         model designation">> $@; \
	echo "   scheme_phys = 24          scheme (22, 24, 44 - 1D only)">> $@; \
	echo "           cfl = 0.4" >> $@; \
	echo "          cmin = 1.0" >> $@; \
	echo "          cmax = 4.5" >> $@; \
	echo "         fpeak = 0.005        central frequency" >> $@; \
	echo >> $@; \
	echo ------------------------------------------------------------------------ >> $@; \
	echo Model info: >> $@; \
	echo >> $@; \
	echo "        lambda = test$(subst test,,$(subst .par,,$@))_lambda.rsf" >> $@; \
	echo "            mu = test$(subst test,,$(subst .par,,$@))_mu.rsf" >> $@; \
	echo "       density = test$(subst test,,$(subst .par,,$@))_dn.rsf" >> $@; \
	echo >> $@; \
	echo 	------------------------------------------------------------------------ >> $@; \
	echo Source info: >> $@; \
	echo >> $@; \
	echo "      srctype = array" >> $@; \
	echo "       source = mysrc.su" >> $@; \
	echo >> $@; \
	echo ------------------------------------------------------------------------>> $@; \
	echo Trace info:>> $@; \
	echo >> $@; \
	echo "      hdrfile = hdr.su">> $@; \
	echo "     datafile = test$(subst test,,$(subst .par,,$@))_pz.su" >> $@; \
	echo "  datafile_pz = test$(subst test,,$(subst .par,,$@))_pz.su" >> $@; \
	echo " datafile_szx = test$(subst test,,$(subst .par,,$@))_szx.su" >> $@; \
	echo "       movie1 = s0" >> $@;\
	echo >> $@; \
	echo ------------------------------------------------------------------------>> $@; \
	echo PML info:>> $@; \
	echo >> $@; \
	echo "          nl1 = 0.0         z - neg">> $@; \
	echo "          nr1 = 0.5         z - pos">> $@; \
	echo "          nl2 = 0.5         x - neg">> $@; \
	echo "          nr2 = 0.5         x - pos">> $@; \
	echo >> $@; \
	echo MPI info: >> $@; \
	echo >> $@; \
	echo "      mpi_np1 = 2           n_doms along axis 1">> $@; \
	echo "      mpi_np2 = 1           n_doms along axis 2">> $@; \
	echo "      mpi_np3 = 1           n_doms along axis 3">> $@; \
	echo "      partask = 0">> $@; \
	echo >> $@; \
	echo Output info:>> $@; \
	echo >> $@; \
	echo "      dump_pi = 1           dump parallel/dom. decomp info">>$@; \
	echo "     dump_lda = 1           dump grid data for allocated arrays">>$@; \
	echo "     dump_ldc = 1           dump grid data for computational arrays">>$@; \
	echo "    dump_term = 1           dump terminator data">>$@; \
	)



