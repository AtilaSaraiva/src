#!/usr/bin/env python
import sys, os, glob, signal, string

if len(sys.argv) < 2:
    print '''
    Usage: %s [-q] command
    visits lower-case subdirectories and executes command
    -q     quiet (suppress stdout)
    ''' % sys.argv[0]
    sys.exit(0)

########
comm = sys.argv.pop(0)

if comm == "-q":
   verbose = 0
   comm = sys.argv.pop(0)
else:
   verbose = 1

comm = string.join(sys.argv,' ')

sys.stderr.write('Executing "%s"...\n' % comm)

dirs = filter(lambda x: x[-5:] != '_html',
              filter(os.path.isdir,glob.glob('[a-z]*')))

sys.stderr.write(string.join(dirs,'::') + '\n')

child = None

def handler(signum, frame):
    sys.stderr.write('\n%s: aborting...\n' % comm)
    if child:
        os.kill (signal.SIGINT,child)
    sys.exit(-1)

signal.signal(signal.SIGINT,handler) # handle interrupt

def syswait(comm):
    child = os.fork()
    if child:
        (pid,exit) = os.waitpid(child,0)
        child = 0
        return exit
    else:
        os.system(comm)
        os._exit(0)

if not verbose:
    sys.stdout = open("/dev/null","w")

cwd = os.getcwd()
for dir in dirs:
    os.chdir (cwd)
    try:
        os.chdir (dir)
    except:
        sys.stderr.write('\n%s: wrong directory %s...\n' % (comm,dir))
        sys.exit(1)
    os.environ['PWD'] = os.path.join(cwd,dir)
    sys.stderr.write(string.join(['+' * 44,dir,'\n'],' '))
    if comm:
        syswait(comm)
    sys.stderr.write(string.join(['-' * 44,dir,'\n'],' '))

sys.stderr.write('Done.\n')



