import os
import shutil
thispath = os.getcwd()
env = Environment();

####### tools

cmddict = { 
'asg.x' :  '$IWAVE/asg',
'standardmodel.x' : '../model' 
}

def cmdlink(target, source, env):
    for cmd in target:
        cmdpath = os.path.abspath(os.path.expandvars(str(cmddict[str(cmd)])))
        os.system('cd ' + cmdpath + '; scons main/' + str(cmd) + '; cd ' + thispath)
        os.system('ln -s ' + cmdpath + '/main/' + str(cmd) + ' .')
    
env.Command(cmddict.keys(),['SConstruct'],cmdlink)

####### local data

def make_par(target, source, env):
    os.system('ln -s ./Orig/demo.par .')

env.Command(['demo.par'], ['SConstruct'], make_par)

def make_data(target, source, env):
    os.system('sunull nt=1501 ntr=301 dt=0.002 | sushw key=sx a=3300 c=0 j=301| sushw key=gx a=100 b=20 j=301 | sushw key=delrt a=0 | sushw key=selev a=-40 | sushw key=gelev a=-20 > data.su; ./asg.x par=demo.par')

env.Command(['data.su', 'cout0.txt'], ['demo.par', 'hdr.su', 'dn2d_20m.rsf', 'vp2d_20m.rsf', 'wavelet.su', 'SConstruct'], make_data)
   
def make_src(target, source, env):
    os.system('suspike ntr=1 nt=401  offset=0 nspk=1 ix1=1 it1=201 dt=0.002 | sushw key=delrt  a=-400 |sufilter f=0.,2.5,15.0,20.0 amps=0.,1.,1.,0. | sugain scale=1.e6 > wavelet.su')

env.Command(['wavelet.su'],['SConstruct'],make_src)

def hdr_prep(target, source, env):
    os.system('sunull nt=1501 ntr=301 dt=0.002 | sushw key=sx a=3300 c=0 j=301| sushw key=gx a=100 b=20 j=301 | sushw key=delrt a=0| sushw key=selev a=-40 | sushw key=gelev a=-20 > ' + str(target[0]))

env.Command(['hdr.su'],['SConstruct'],hdr_prep)

def mdl_prep(target, source, env):
    os.system('./standardmodel.x par=../model/data/Orig/vp2d_20m.par; ./standardmodel.x par=../model/data/Orig/dn2d_20m.par')

env.Command(['vp2d_20m.rsf', 'vp2d_20m.rsf@', 'dn2d_20m.rsf', 'dn2d_20m.rsf@'],['SConstruct'], mdl_prep);
