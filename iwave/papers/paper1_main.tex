\title{Using IWAVE}
\author{William. W. Symes \thanks{The Rice Inversion Project,
Department of Computational and Applied Mathematics, Rice University,
Houston TX 77251-1892 USA, email {\tt symes@caam.rice.edu}.}}

\maketitle

\begin{abstract}
  IWAVE is a framework for time-domain regular grid finite difference
  and finite element methods. The demonstration package includes
  examples of typical IWAVE use cases, with complete input data. The
  examples are taken from a recent paper on error propagation for
  heterogeneous medium simulation using finite differences, and allow
  the user to replicate illustrations of the interface error effect
  which renders all FD methods effectively first-order accurate.  This
  paper gives a brief tour of the common use cases illustrated in the demonstration package.
\end{abstract}

\section{Introduction}
Domain-specific simulation such as seismic modeling begs for
software re-use via modular design. All applications of this type have
the same structure: static fields are initialized, dynamic fields
updated, output extracted. A modular approach to code architecture is
implicit in this structure.

Further specialization of simulator type offers even more opportunity
for modular design. The general topic of this paper, time-domain
simulation on regular rectangular grids, presents specific openings
for code re-use via abstraction: time steps may have internal
structure which is repeated in a defined pattern, parallelism via
domain decomposition may be computed from stencil shape information
rather than hard-wired into the code, sampling rules for output
buffering are simple to formulate and universal, and external data
formats may be hidden behind uniform interfaces.

The software package described in these pages, IWAVE, takes advantage
of the aforementioned intrinsic modularity. IWAVE is open source
software for finite difference or finite element time-domain
simulation on regular rectangular grids, written exclusively in the
C99 dialect of ISO C. IWAVE is built around a core framework: that is,
a collection of separate software packages which together provide a
set of essential services upon which applications may be built. These
service components completely define the interfaces to which
additional software must be written to formulate a complete
application. Along with the core framework, the current release
contains a complete time-domain acoustic modeling finite difference
application, as well as a basic isotropic elastodynamics application.

The primary purpose of this short paper is to illustrate the use of
IWAVE to calculate synthetic seismograms. To that end, the paper
describes a simple application - 2D synthetic seismogram generation
over a simple structural model of the sedimentary column - and
provides a set of demonstration examples (``demos'') which the reader
may reproduce, along with complete annotation of the files needed for
job specification and sample graphics derived from the results (as
well as commands to produce these graphics).

A secondary purpose is to supply the user with the means to
independently verify some of the claims in the paper by
\cite{SymesVdovina:09}, namely the existance of an error component in
synthetic data derived from strongly heterogeneous models, in addition
to the well-known grid dispersion error. The examples presented here
are essentially the same as those presented in that paper. By
installing IWAVE and running the demonstrations described here, the
reader may reproduce the computational content of \cite[]{SymesVdovina:09}.

IWAVE is both a standalone application, and a component of the
Madagascar software suite:
\begin{verbatim}
http://www.reproducibility.org/wiki/Main_Page
\end{verbatim}
The application and the examples discussed
here (and indeed this paper itself) may be built either independently, or within Madagascar, as
explained in detail below.

The internal details of IWAVE are not discussed here, except insofar
as is necessary to explain the use of the main
commands. \cite{GeoPros:11} briefly describe the structure of the
IWAVE framework, with emphasis on its object-oriented design and the
resulting mechanisms for coupling modeling with optimization packages
to produce inversion applications. The IWAVE project web page 
\begin{verbatim}
http://www.trip.caam.rice.edu/software/iwave/doc/html/index.html.
\end{verbatim}
provides extensive reference material, and further information about
the design.
 

\section{Acoustodynamics}
The IWAVE acoustic package is based on the pressure-velocity form of
acoustodynamics, consisting of two coupled first-order partial
differential equations:
\begin{eqnarray}
\label{awe}
\rho \frac{\partial \bv}{\partial t} &=& - \nabla p \\
\frac{1}{\kappa}\frac{\partial p}{\partial t} &=& -\nabla \cdot \bv + g
\end{eqnarray}
In these equations, $p(\bx,t)$ is the pressure (excess, relative to an
ambient equilibrium pressure), $\bv(\bx,t)$ is the particle velocity,
$\rho(\bx)$ and $\kappa(\bx)$ are the density and particle velocity
respectively. Bold-faced symbols denote vectors; the above formulation
applies in 1, 2, or 3D.

The inhomogeneous term $g$ represents externally supplied energy (a
``source''), via a defect in the acoustic constitutive relation. A
typical example is the {\em isotropic point source}
\[
g(\bx,t) = w(t) \delta(\bx-\bx_s)
\]
at source location $\bx_s$.

\cite{Vir:84} introduced finite difference methods based on this
formulation of acoustodynamics to the active source seismic
community. \cite{Vir:86} extended the technique to elastodynamics, and
\cite{Lev:88} demonstrated the use of higher (than second) order
difference formulas and the consequent improvement in dispersion
error.  IWAVE's acoustic application uses the principles introduced by
these authors to offer a suite of finite difference schemes, all
second order in time and of various orders of accuracy in space.

The bulk modulus and buoyancy (reciprocal density) are the natural
parameters whose grid samplings appear in the difference formulae. I will
display velocity and density instead in the examples below. IWAVE's acoustic application
converts velocity and density to bulk modulus and buoyancy as part of
the problem setup phase; the user may supply any equivalent combination of parameters.

\section{Examples based on a 2D dome model}

This simple 2D model embeds an anticline or dome in an otherwise
undisturbed package of layers. The velocity and density models are
depicted in Figures \ref{fig:vp} and \ref{fig:dn}. These
figures display sampled versions of the models with $\Delta x = \Delta
z = $ 5 m; the model fields are actually given analytically, and can
be sampled at any spatial rate.

\cite{SymesVdovina:09} use this model to illustrate the {\em
  interface error} phenomenon: the tendency, first reported by
\cite{Brown:84}, of all finite difference schemes for wave
propagation to exhibit first order error, regardless of formal order,
for models with material parameter discontinuities. 
Figure \ref{fig:data5m} exhibits a shot gather, computed with a (2,4) (= 2nd order in time,
4th order in space) staggered grid scheme, $\Delta
x = \Delta z = $ 5 m and an appropriate near-optimal time step, acquisition geometry as described in
caption. The same gather computed at different spatial sample rates
seem identical, at first glance, however in fact the sample rate has a considerable effect. Figures
\ref{fig:trace} and \ref{fig:wtrace} compare traces computed from models sampled
at four different spatial rates (20 m to 2.5 m), with proportional
time steps. The scheme used is formally 2nd order
convergent like the original 2nd order scheme suggested by
\cite{Vir:84}, but has better dispersion suppression due to the use of
4th order spatial derivative approximation. Nonetheless,
the figures clearly show the first order error, in the form of a
grid-dependent time shift, predicted by \cite{Brown:84}. 

Generally, even higher order approximation of spatial derivatives
yields less dispersive propagation error, which dominates the finite
difference error for smoothly varying material models. For
discontinuous models, the dispersive component of error is still
improved by use of a higher order spatial derivative approximation,
but the first order interface error eventually dominates as the grids
are refined. Figure \ref{fig:data5m8k} shows the same shot gather as
displayed earlier, with the same spatial and temporal sampling and
acquisition geometry, but computed via the (2,8) (8th order in space)
scheme. The two gather figures are difficult to disinguish. The trace
details (Figures \ref{fig:trace8k}, \ref{fig:wtrace8k}) show clearly
that while the coarse grid simulation is more accurate than the (2,4)
result, but the convergence rate stalls out to 1st order as the grid
as refined, and for fine grids the (2,4) and (2,8) schemes produce
very similar results: dispersion error has been suppressed, and what
remains is due to the presence of model discontinuities.

See
\cite[]{SymesVdovina:09} for more examples, analysis, and discussion.

\section{Creating the examples}
IWAVE builds with SConstruct, either as an
independent package or as part of Madagascar ({\tt
  http://www.reproducibility.org/wiki/Main\_Page}). For instructions on
installing IWAVE (and all other TRIP software) as standalone packages, see 
\begin{verbatim}
http://www.trip.caam.rice.edu/software/admin/doc/html/install.html.
\end{verbatim}
For instructions on installing IWAVE as part of Madagascar, see the
Madagascar web site.

To build the intermediate data and figures for  the examples described
here,,
\begin{itemize}
\item install IWAVE, either within Madagascar or standalone. I will use  {\tt \$TOP} to denote
  the path to the top-level IWAVE directory for the standalone
  version, or to the top-level Madagascar directory.
\item build data and figures: in the standalone version of IWAVE,
\begin{itemize}
  \item {\tt cd \$TOP/demo/data}
\item {\tt scons}
\end{itemize},
or, in the Madagascar version,
\begin{itemize}
\item {\tt cd \$TOP/book/trip/iwave/data}
\item {\tt scons}
\item {\tt scons lock -f madfig.sc}
\end{itemize}
(the last step is necessary only to archive the newly created copies
of the figures - the current Madagascar distribution will arrive with
already-archived figure files)
\item to (re)build this paper, build the figures first. Then in the standalone version,
\begin{itemize}
\item {\tt cd \$TOP/papers}
\item {\tt scons}
\end{itemize} 
or, in the Madagascar version,
\begin{itemize}
\item {\tt cd \$TOP/book/iwave}
\item {\tt scons}
\end{itemize}

\end{itemize}
Note that the finest (2.5 m) grid consists of roughly 10 million
gridpoints. Consequently the modeling runs collectively take a
considerable time, from a minutes to a substantial fraction of an hour
depending on platform,
on a single thred. This example is computationally large enough that
parallelism via domain decomposition is worthwhile. IWAVE is designed
from the ground up to support parallel computation; a companion report
will demonstrate parallel use of IWAVE.

Inspection of the {\tt SConstruct} file in {\tt data} will show that
the modeling tool used is {\tt \$TOP/asg/main/asg.x}, the IWAVE
acoustic modeling command (in Madagascar, this command is referenced
simply as {\tt asg}). Input data is supplied by a parameter file,
described in more detail in the appendix.
The model-building tool {\tt standardmodel} builds the velocity and
density model files, and works the same way - many of the parameter
files in the {\tt data} directory are input for this tool.

Both {\tt asg} and {\tt standardmodel} self-doc in the style of SU or
Madagascar. For {\tt asg}, the self-doc is deprecated; the user should
preferentially consult the web documentation mentioned above.

\section{Acknowledgements}
Development of IWAVE was supported by the SEG Advanced Modeling (SEAM)
project, by the National Science Foundation under awards 0620821 and
0714193, and by the sponsors of The Rice Inversion Project. The IWAVE
project owes a great deal to several open source seismic software
packages (Seismic Un*x, SEPlib, Madagascar), debts which we gratefully
acknowledge. The author wishes to record his special gratitude to
Sergey Fomel, the architect of Madagascar, for his inspiring ideas and
his generous and crucial help in the integration of IWAVE into Madagascar.

\bibliographystyle{seg}
\bibliography{masterref}


