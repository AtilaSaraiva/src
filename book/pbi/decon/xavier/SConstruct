from rsfproj import *

data = {'den': 'density2004.sgy',
        'vel': 'vel2004_.sgy'}

for case in data.keys():
    Fetch(data[case],'xavier')
    Flow([case,'./b'+case,'./h'+case],data[case],
         '''
         segyread tape=$SOURCE read=data
         bfile=${TARGETS[1]} hfile=${TARGETS[2]} |
         put n2=250 n3=125 d1=1.17 d2=10 d3=10 o2=-150 o3=-450
         ''')
    Flow('m'+case,case,'mask min=0')
#    Flow('d'+case,[case,'m'+case],
#         '''
#         dip verb=y rect1=10 rect2=10 rect3=10 memsize=500
#         order=3 mask=${SOURCES[1]} w1=300
#         ''')
    Flow(case+'1',[case,'m'+case],
         '''
         miss3 mask=${SOURCES[1]} rect1=10 rect2=40 rect3=40
         niter=40 verb=y
         ''')

def grey3(byte,color,title,label1):
    return '''
    byte gainpanel=all %s |
    grey3 flat=n frame1=150 frame2=125 frame3=60
    color=%s title="%s" point2=0.75
    label1="%s" label2="In-line (m)" label3="Cross-line (m)"
    ''' % (byte,color,title,label1)

Flow('ai','vel1 den1','add mode=p ${SOURCES[1]}')
Result('xai','ai',
       grey3('pclip=100 allpos=y','j','Acoustic Impedance','Depth (m)'))

Flow('refl','ai vel1',
     '''
     ai2refl | bandpass fhi=0.25 |
     depth2time velocity=${SOURCES[1]} dt=0.0005 |
     ricker1 freq=0.12
     ''')

Flow('modl','refl vel1','time2depth velocity=${SOURCES[1]} dz=1.17')

Result('xrefl','refl',grey3('','G','Convolution Model, 120 Hz','Time (s)'))

Flow('xdip','refl',
     'dip rect1=10 rect2=10 rect3=10 memsize=150 p1=1 w1=300')

Result('xmodl','modl',grey3('','G','Convolution Model, 120 Hz','Depth (m)'))

Flow('slow1','vel1','math output=1/input | transp plane=13')

Flow('data','modl slow1',
     '''
     transp plane=13 |
     sstep2 inv=y slowness=${SOURCES[1]} nw=151 w0=0 dw=6.666667
     verb=y nr=100 dt=0.002
     ''')

Result('xdata','data',
       'transp plane=13 | fft1 inv=y | ' +\
       grey3('','G','Exploding Reflector Data','Time (s)'))

Flow('vel2','vel1','smooth rect1=50 rect2=50 rect3=50 rep=2')

Result('xvel2','vel2',
       grey3('pclip=100 allpos=y bias=4000','j',
             'Smoothed Velocity','Depth (m)'))

Flow('slow2','vel2','math output=1/input | transp plane=13')

Flow('imag','data slow2',
     'sstep2 inv=n slowness=${SOURCES[1]} readwrite=y verb=y nr=100 dt=0.002')

Result('ximag','imag',
       'transp plane=13 |' + \
       grey3('','G','Exploding Reflector Image','Depth (m)'))

End()
