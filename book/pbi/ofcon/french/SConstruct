from rsfproj import *

Fetch('french.asc','french')

Flow('french','french.asc','dd form=native | transp | scale dscale=2')
Result('french',
       '''grey Xcolor=j allpos=y bias=1000 scalebar=n barlabel="Depth (m)"
       screenratio=1
       title="French model"
       ''')

Flow('slice','french',
     '''window n1=1 f1=30 |
     remap1 n1=161 o1=0 d1=51.325 |
     unif2 n1=401 d1=10.265 v00=1,2''')
Result('slice',
       '''grey Xcolor=j allpos=y bias=1 title="2-D slice" label1="Depth (m)"
       screenratio=0.5 screenht=6
       ''')

Flow('cup','slice',
     '''igrad | bandpass flo=0.002 fhi=0.008 |
     transp | bandpass fhi=0.004 | transp | put d1=0.010265
     ''')
Result('cup',
       'grey label1="Time (s)" label2="Midpoint (m)" pclip=99.5 title=Model')

Flow('data','cup',
     '''
     pad n1=601 | halfint inv=y |
     preconstkirch zero=y inv=y h0=0 dh=51.325 nh=61 vel=2000 |
     window
     ''')

Flow('refl','french','window n1=1 f1=30 | remap1 n1=161 o1=0 d1=51.325')
Flow('rdip','refl','smooth rect1=5 | deriv')

Flow('data2','refl rdip',
     '''
     kirmod nt=601 dt=0.010265 vel=2000 dip=${SOURCES[1]}
     h0=-6159 dh=102.65 nh=121 ns=221 s0=-3079.5 ds=51.325 freq=5 |
     put d2=51.325
     ''')
Flow('cmp2','data2','shot2cmp | window min3=0 n3=161 | transp plane=23')

Flow('psdata2','refl rdip',
     '''
     kirmod nt=601 dt=0.010265 vel=2000 vel2=1000 dip=${SOURCES[1]}
     h0=-6159 dh=102.65 nh=121 ns=221 s0=-3079.5 ds=51.325 freq=5 |
     put d2=51.325
     ''')

Flow('nmo','data',
     '''
     transp plane=23 | nmostretch v0=2000 |
     window max1=4.5 | transp plane=23
     ''')
Flow(['hole','mask'],'nmo','shotholes perc=0.9 mask=${TARGETS[1]}')

nmos = []
holes = []
for slice in [0,25,50]:
    offset = int(slice*51.325)
    grey = '''
         window n3=1 f3=%d | 
         grey pclip=99.5 title="h=%d"
         label1="Time (s)" label2="Midpoint (m)"
         ''' % (slice,offset)
    nmo = 'nmo%d' % slice
    hole = 'hole%d' % slice
    Plot(nmo,'nmo',grey)
    Plot(hole,'hole',grey)
    nmos.append(nmo)
    holes.append(hole)
Plot('nmo',nmos,'OverUnderAniso')
Plot('hole',holes,'OverUnderAniso')
Result('data',['nmo','hole'],'SideBySideAniso',vppen='txscale=3')

nmos = []
holes = []
for slice in [124,224,324]:
    time = slice*0.010265
    grey = '''
         window n1=1 f1=%d | 
         grey pclip=99.5 transp=n title="t=%g"
         label1="Midpoint (m)" label2="Offset (m)"
         ''' % (slice,time)
    nmo = 'tnmo%d' % slice
    hole = 'thole%d' % slice
    Plot(nmo,'nmo',grey)
    Plot(hole,'hole',grey)
    nmos.append(nmo)
    holes.append(hole)
Plot('tnmo',nmos,'OverUnderAniso')
Plot('thole',holes,'OverUnderAniso')
Result('tslice',['tnmo','thole'],'SideBySideAniso',vppen='txscale=3')

Flow('fftd','hole',
     '''window f1=40 | stretch rule=L nout=512 |
     fft1 | transp | transp plane=23''')
Flow('fill',['fftd','mask'],
     'window n3=100 | ofilp known=${SOURCES[1]} niter=1000')
Flow('hfill',['fftd','mask'],
     'window n3=100 | ofilp known=${SOURCES[1]} niter=1000 simple=y')

ffts = []
fills = []
for slice in [15,20,25]:
    frec = int(slice*0.410595)
    grey = '''
         window n3=1 f3=%d | real | 
         grey title="frequency=%g" transp=n
         label1="Midpoint (m)" labbel2="Offset (m)"
         ''' % (slice,frec)
    fft = 'fft%d' % slice
    fill = 'fill%d' % slice
    Plot(fft,'fftd',grey)
    Plot(fill,'fill',grey)
    ffts.append(fft)
    fills.append(fill)
Plot('fft',ffts,'OverUnderAniso')
Plot('fill',fills,'OverUnderAniso')
Result('fslice',['fft','fill'],'SideBySideAniso',vppen='txscale=3')

back = '''pad n3=261 | transp plane=23 | transp | fft1 inv=y |
     window n1=512 | stretch rule=L inv=y | pad beg1=40'''

Flow('fild','fill',back)
Flow('hild','hfill',back)

goods = []
bads = []
for slice in [0,25,50]:
    offset = int(slice*51.325)
    grey = '''
    window n3=1 f3=%d | 
    grey pclip=99.5 title="h=%d"
    label1="Time (s)" label2="Midpoint (m)"
    ''' % (slice,offset)
    good = 'good%d' % slice
    bad = 'bad%d' % slice
    Plot(good,'fild',grey)
    Plot(bad,'hild',grey)
    bads.append(bad)
    goods.append(good)
Plot('bad',bads,'OverUnderAniso')
Plot('good',goods,'OverUnderAniso')
Result('all',['bad','good'],'SideBySideAniso',vppen='txscale=3')

Flow('shot','nmo','transp plane=23 | cmp2shot')
Flow('shot1','shot','window n3=1 f3=101')
Flow('shot2','shot','window n3=1 f3=102')
Flow('shot3','shot','window n3=1 f3=103')

clip=1.5

grey = 'grey clip=%g' % clip + ' label2="Offset (m)" crowd1=0.85 title="%s" '

Plot('shot1',grey % 'shot1')
Plot('shot3',grey % 'shot3')

Flow('simp',['shot1','shot3'],'add ${SOURCES[1]} scale=0.5,0.5')
Plot('simp',grey % '(shot1+shot3)/2')

Flow('simperr',['simp','shot2'],'add scale=1,-1 ${SOURCES[1]}')
Plot('simperr',grey % 'error: (shot1+shot3)/2-shot2')
Result('shot3','shot1 shot3 simp simperr','TwoRows')

Flow('shotftd','shot',
     '''window f1=40 | stretch rule=L nout=512 |
     fft1 | transp | transp plane=23''')
Flow('shots','shotftd','window n2=2 f2=101 j2=2')
Flow('shotin','shots','infill | window n2=1 f2=1')
Flow('shotnd','shotin',
     '''
     pad n2=261 | transp | fft1 inv=y |
     window n1=512 | stretch rule=L inv=y | pad beg1=40 
     ''')
Flow('shoterr',['shotnd','shot2'],'add scale=1,-1 ${SOURCES[1]}')

Plot('shotnd',grey % 'Interpolated Shot')
Plot('shoterr',grey % 'Error')
Result('shotin','shotnd shoterr','SideBySideAniso')

###########################################################################
End()
