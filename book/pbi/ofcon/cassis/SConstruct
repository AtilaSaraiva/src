from rsfproj import *

import os
private = {'login':os.environ.get('BEG_LOGIN'),
           'password':os.environ.get('BEG_PASSWORD'),
           'server':os.environ.get('BEG_SERVER')}

Fetch('datacassisAll.su.poscdp','cassis',private)

Flow(['all','head'],'datacassisAll.su.poscdp',
     'segyread tape=$SOURCE tfile=${TARGETS[1]} su=1 endian=0',
     stdin=0)
Flow('cassis0','all','intbin')
Flow('cassis1','cassis0','window f2=196')
Flow('cassis2','cassis0','window n2=196')
Flow('cassis','cassis1 cassis2',
     'cat axis=2 ${SOURCES[1]} | put o3=0 d3=0.0125 label3=offset o2=0.5 d2=0.025 label2=shot')
Flow('cmp','cassis','transp plane=23 memsize=500 | shot2cmp')

mutter = 'slope0=1.3 tgp=0.5'
mutter0 = 'abs=n x0=1 v0=1.5 tp=1'

Flow('vscan','cmp',
     'mutter %s | vscan semblance=y v0=1.5 nv=150 dv=0.02' % mutter)
Flow('vrms','vscan',
     'window max1=3.5 | pad n1=1251 | blindpick rect1=30 rect2=5')
Result('vrms',
       '''window max1=3 min3=2.75 max3=5.5125 |
       grey allpos=y scalebar=y wanttitle=n
       barlabel="NMO velocity (km/s)"
       label1="Time (s)" label2="Midpoint (km)"
       bias=1''')

Flow('nmo',['cmp','vrms'],
     'mutter %s | nmo velocity=${SOURCES[1]} | window max1=3' % mutter)
Flow('nmo0',['cmp','vrms'],
     'nmo velocity=${SOURCES[1]} | window max1=3 | mutter %s' % mutter0)
Flow('stack','nmo','stack')
Result('stack',
       '''window min2=2.75 max2=5.5125 |
       grey title="NMO Stack" label1="Time (s)" label2="Midpoint (km)"
       ''')

Flow('strd','nmo','window f1=50 | stretch rule=L')
Flow('fftd','strd','fft1 | transp plane=13 memsize=500')
Flow('dmod','fftd','finstack')
Flow('dstack','dmod',
     '''transp | fft1 inv=y | window n1=701 |
     stretch rule=L inv=y | pad beg1=50''')
Result('dstack',
       '''window min2=2.75 max2=5.5125 |
       grey title="DMO Stack" label1="Time (s)" label2="Midpoint (km)"
       ''')

Flow('snmo','nmo0','cmp2shot | window min3=0.5 n3=201')
Flow('sfft','snmo',
     '''window f1=50 | stretch rule=L | fft1 |
     transp memsize=500 | transp plane=23 memsize=500''')
Flow('sparse','sfft','window j2=1')
Flow('sback','sparse','infill')
Flow('sdense','sfft','infill eps=0.3')
Flow('snmo2','sback',
     '''transp transp plane=23 memsize=500 | transp memsize=500 |
     fft1 inv=1 | window n1=701 n3=201 | stretch inv=1 rule=L | pad beg1=50''')
Flow('snmo1','sdense',
     '''transp transp plane=23 memsize=500 | transp memsize=500 |
     fft1 inv=1 | window n1=701 | stretch inv=1 rule=L | pad beg1=50''')

Flow(['simp','one','two'],'sparse',
     '''window n2=100 f2=1 > ${TARGETS[1]} &&
     window n2=100 < $SOURCE |
     add ${TARGETS[1]} scale=0.5,0.5 |
     pad n2=101 > ${TARGETS[2]} &&
     interleave axis=2 $SOURCE ${TARGETS[2]} |
     window n2=201
     ''')
Flow('snmo0','simp',
     '''transp transp plane=23 memsize=500 | transp memsize=500 |
     fft1 inv=1 | window n1=701 | stretch inv=1 rule=L | pad beg1=50''')

Flow('diff2',['snmo2','snmo'],'add scale=1,-1 ${SOURCES[1]}')
Flow('diff0',['snmo0','snmo'],'add scale=1,-1 ${SOURCES[1]}')

def shotplot(slice,clip=0.003):
    return '''window n3=1 f3=%d max1=2.25 min1=0.25 |
    grey label1="Time (s)" label2="Offset (km)" title="Shot%d" clip=%g
    ''' % (slice,slice+1,clip)

for shot in [59,69,79,99,109]:
    shots = []
    for slice in range(shot-1,shot+2):
        shoti = 'shot%d' % slice
        shots.append(shoti)
        Plot(shoti,'snmo',shotplot(slice))
    shoti = 'shot%d' % shot
    Result(shoti,shots,'SideBySideAniso')

    shotin = 'shotin%d' % shot
    shoterr = 'shoterr%d' % shot
    simperr = 'simperr%d' % shot
    Plot(shotin,'snmo2',
         shotplot(shot) + ' title="Shot%d Interpolated" ' % (shot+1))
    Plot(shoterr,'diff2',
         shotplot(shot) + ' title="Interpolation Error" ')
    Plot(simperr,'diff0',
         shotplot(shot) +
         ' title="(Shot%d+Shot%d)/2-Shot%d" ' % (shot,shot+2,shot+1))
#    Result(shotin,[shotin,shoterr,simperr],'SideBySideAniso')

Flow('sparsecmp','cassis',
     'window j2=2 | transp plane=23 memsize=500 | shot2cmp')
Flow('backcmp',['snmo2','vrms'],
     'shot2cmp | window n3=582 | pad n1=1251 | inmo velocity=${SOURCES[1]}')
Flow('denscmp',['snmo1','vrms'],
     'shot2cmp | window n3=582 | pad n1=1251 | inmo velocity=${SOURCES[1]}')

def window(slice):
    return '''
    window n3=1 min3=%g max1=3
    ''' % slice    

clip = 0.004
cmpplot = 'grey label1="Time (s)" label2="Offset (km)" clip=%g' % clip

for cmp in [4]:
    cmpi = 'cmp%g' % cmp
    for case in ['','back','sparse','dens']:
        Flow(case+cmpi,case+'cmp',window(cmp))
    Plot(cmpi,cmpplot + '  title="CMP at %g km" ' % cmp)
    Plot('sparse'+cmpi,cmpplot + '  title=Decimated')
    Plot('back'+cmpi,  cmpplot + '  title=Restored')
    Plot('dens'+cmpi,  cmpplot + '  title=Interpolated')
    Plot('err'+cmpi,['back'+cmpi,cmpi],
         'add scale=1,-1 ${SOURCES[1]} | ' + cmpplot + '  title=Error')
#    Result(cmpi,[cmpi,'sparse'+cmpi],'SideBySideAniso')
#    Result('err'+cmpi,['back'+cmpi,'err'+cmpi],'SideBySideAniso')
#    Result('dens'+cmpi,[cmpi,'dens'+cmpi],'SideBySideAniso')

###########################################################################
End()
