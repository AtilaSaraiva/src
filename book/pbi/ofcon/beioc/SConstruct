from rsfproj import *

Fetch('midpts.hh','midpts')

Flow('beidat','midpts.hh','dd form=native | put d2=0.067 o2=0.132')

Flow('beiscn','beidat',
     '''mutter v0=1.4 | vscan semblance=y v0=1.3 nv=48 dv=0.03''')
Flow('beivel','beiscn','blindpick2 eps=10 lam=100 | window')
Result('beivel',
       'grey color=j allpos=y scalebar=y title="RMS velocity" bias=1')

Flow('beinmod',['beidat','beivel'],
     'nmo velocity=${SOURCES[1]} | mutter v0=1.4')
Flow('beistup','beinmod','stack')
Result('beistup','grey title="NMO Stack" ')

Flow('beistrd','beinmod','window f1=15 | logstretch nout=2048')
Flow('beifftd','beistrd','fft1 | transp plane=13')
Flow('beistck','beifftd','finstack')

Flow('beitop','beistup','window n1=15')
Flow('beibot','beistck',
     'transp | fft1 inv=y | window n1=2048 | logstretch inv=y')
Flow('beistkd',['beitop','beibot'],'cat axis=1 ${SOURCES[1]}')
Result('beistkd','grey title="DMO Stack" ')

Flow('beiagc','beistkd','agc rect1=200')
Flow('beidip','beiagc','dip rect1=10 rect2=10')

Flow('beidif','beiagc beidip','pwd dip=${SOURCES[1]}')

Result('beidif','grey title=Diffractions')

Flow('beickx','beidif','pad n2=521 | cosft sign2=1 | spray axis=2 n=1 o=0 d=0.1')
Flow('beivlf','beickx','fourvc nv=100 dv=0.025 v0=0.00001 pad=1024 pad2=2048 | cosft sign3=-1 | window n3=250')

Flow('beifoc','beivlf','focus rect1=50 rect2=3 rect3=5 | math output=1/input')
Flow('beipik','beifoc','blindpick rect1=100 rect2=10')

Result('beipik',
       '''
       window | 
       grey label1="Time(s)" label2="X(ft)" allpos=y title=Velocity color=j scalebar=y
       ''')

Flow('beislc','beivlf beipik','slice pick=${SOURCES[1]}')

Flow('beishot','beinmod','cmp2shot')
Flow('beisfft','beishot',
     '''window f1=15 | logstretch nout=2048 |
     fft1 | transp | transp plane=23''')
Flow('beisfill','beisfft','infill eps=0.3')
Flow('beisdens','beisfill',
     '''transp plane=23 | transp | fft1 inv=y |
     window n1=2048 | logstretch inv=y | pad beg1=15''')
Flow('beidens','beisdens',
     'shot2cmp | window min3=7.705 n3=250 | mutter v0=1.4')
Flow('beistup2','beidens','stack')
Result('beistup2',
       'grey title="NMO Stack after Shot Interpolation" ')

Flow('beinew',['beidens','beivel'],
     'inmo velocity=${SOURCES[1]}')

cmpplot = '''
window n3=1 f3=1 | grey title="%s" label1="Time (s)" label2="Offset (km)"
'''

Plot('before','beidat',cmpplot % 'Before')
Plot('after','beinew',cmpplot % 'After')
Result('beidens',['before','after'],'SideBySideAniso')

Flow('beistrd2','beidens','window f1=15 | logstretch nout=2048')
Flow('beifftd2','beistrd2','fft1 | transp plane=13')
Flow('beistck2','beifftd2','finstack')

Flow('beitop2','beistup2','window n1=15')
Flow('beibot2','beistck2',
     'transp | fft1 inv=y | window n1=2048 | logstretch inv=y')
Flow('beistkd2',['beitop2','beibot2'],'cat axis=1 ${SOURCES[1]}')
Result('beistkd2',
       'grey title="DMO Stack after Shot Interpolation" ')

Plot('beistkd-zoom','beistkd',
     '''window min1=1 max1=2 min2=8 max2=14 |
     grey title="DMO Stack" label1="Time (s)" label2="Midpoint (km)"
     ''')
Plot('beistkd2-zoom','beistkd2',
     '''window min1=1 max1=2 min2=8 max2=14 |
     grey title="DMO Stack after Shot Interpolation"
     label1="Time (s)" label2="Midpoint (km)"
     ''')
Result('beistkd-zoom',['beistkd-zoom','beistkd2-zoom'],'OverUnderAniso')

End()
