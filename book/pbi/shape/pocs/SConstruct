from rsfproj import *

Fetch('mona.img','imgs')
Flow('mona','mona.img',
     '''
     echo n1=512 n2=513 in=$SOURCE data_format=native_uchar |
     dd type=float |
     window f2=1
     ''',stdin=0)

def grey(title,allpos=1):
    return '''
    grey transp=n allpos=%d title="%s"
    color=b screenratio=1 wantaxis=n
    ''' % (allpos,title)

Result('mona',grey('Mona Lisa'))

forw = 'pad beg1=512 end1=512 beg2=512 end2=512 | fft1 | fft3 axis=2'
back = 'fft3 inv=y axis=2 | fft1 inv=y | window f1=512 f2=512 n1=512 n2=512'

Flow('fft','mona',forw)

# Show amplitude and phase

Flow('amp','fft','math output="abs(input)" | ' + back )
Result('amp',grey('Amplitude',0))

Flow('log','fft','math output="log(input)" | sfimag | sfrtoc | ' + back )
Result('log',grey('Phase',0))

# Do POCS iterations

Flow('flog','fft','math output="log(input)" ')

amp = 'abs'
#Flow(amp,log,'math output=1')

for iter in range(1,2):
    sig = 'sig%d' % iter

    # assign phase
    Flow(sig,[amp,'flog'],
         forw + '| math phase=${SOURCES[1]} output="input*exp(phase)" | ' +
         back)



End()
