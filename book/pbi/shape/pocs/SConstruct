from rsfproj import *

Fetch('mona.img','imgs')
Flow('mona','mona.img',
     '''
     echo n1=512 n2=513 in=$SOURCE data_format=native_uchar |
     dd type=float |
     window f2=1 
     ''',stdin=0)

def grey(title,allpos=1):
    return '''
    pad beg2=2 end2=2 beg1=86 end1=86 |
    grey transp=n allpos=%d title="%s"
    color=b screenratio=0.75 wantaxis=n
    ''' % (allpos,title)

Result('mona',grey('Mona Lisa'))

forw = 'fft1 | fft3 axis=2'
back = 'fft3 inv=y axis=2 | fft1 inv=y'

Flow('fft','mona',forw)

# Show amplitude and phase

Flow('abs','fft','math output="abs(input)" ')
Flow('amp','abs',back)
Result('amp',grey('Amplitude',0))

Flow('pha','fft abs','math den=${SOURCES[1]} output=input/den')
Flow('log','pha',back)
Result('log',grey('Phase',0))

# Do POCS iterations

Flow('amp0','abs','math output=1')
Flow('pha0','amp0 pha','math phase=${SOURCES[1]} output="abs(input)*phase" ')
Flow('log0','pha0',back)
Flow('pos0','log0','mask min=0 | dd type=float | add mode=p $SOURCE')
Plot('pos0',grey('Iteration 0'))


old = 'pos0'
pocs = [old]
errs = []
for i in range(1,101):
    new = 'pos%d' % i
    Flow('log'+new,[old,'pha'],forw + \
         '| math phase=${SOURCES[1]} output="abs(input)*phase" |' + back)
    Flow(new,'log'+new,'mask min=0 | dd type=float | add mode=p $SOURCE')
    Plot(new,grey('Iteration %d' % i))
    Flow('err'+new,[new,'mona'],
         '''
         math mona=${SOURCES[1]} output="(input-mona)^2" |
         stack axis=2 norm=n | stack axis=1 norm=n
         ''')
    pocs.append(new)
    errs.append('err'+new)
    old = new

Result('err',errs,
       '''
       cat axis=1 ${SOURCES[1:%d]} |
       math output="sqrt(input)/%d" |
       put o1=1 |
       graph title=Error label1=Iterations       
       ''' % (len(errs),512*512))

Plot('pocs',pocs,'Movie')



End()
