from rsfproj import *

Fetch('mona.img','imgs')
Flow('mona','mona.img',
     '''
     echo n1=512 n2=513 in=$SOURCE data_format=native_uchar |
     dd type=float |
     window f2=1
     ''',stdin=0)

def grey(title,allpos=1):
    return '''
    grey transp=n allpos=%d title="%s"
    color=b screenratio=1 wantaxis=n
    ''' % (allpos,title)

Result('mona',grey('Mona Lisa'))

forw = 'pad beg1=512 end1=512 beg2=512 end2=512 | fft1 | fft3 axis=2'
back = 'fft3 inv=y axis=2 | fft1 inv=y | window f1=512 f2=512 n1=512 n2=512'

Flow('fft','mona',forw)

# Show amplitude and phase

Flow('abs','fft','math output="abs(input)" ')
Flow('amp','abs',back)
Result('amp',grey('Amplitude',0))

Flow('pha','fft abs','math den=${SOURCES[1]} output=input/den')
Flow('log','pha',back)
Result('log',grey('Phase',0))

# Do POCS iterations

Flow('amp0','abs','math output=1')
Flow('pha0','amp0 pha','math phase=${SOURCES[1]} output="abs(input)*phase" ')
Flow('log0','pha0',back)
Flow('pos0','log0','mask min=0 | dd type=float | add mode=p $SOURCE')
Plot('pos0',grey('Interation 0'))

Flow('fft1','pos0',forw)
Flow('pha1','fft1 pha','math phase=${SOURCES[1]} output="abs(input)*phase" ')
Flow('log1','pha1',back)
Flow('pos1','log1','mask min=0 | dd type=float | add mode=p $SOURCE')
Plot('pos1',grey('Interation 1'))

End()
