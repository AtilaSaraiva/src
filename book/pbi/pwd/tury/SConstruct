from rsfproj import *

private = {'login':os.environ.get('BEG_LOGIN'),
           'password':os.environ.get('BEG_PASSWORD'),
           'server':os.environ.get('BEG_SERVER')}

Fetch('gathers.segy','tury',private)
Flow('gath tgath gath.asc gath.bin','gathers.segy',
     '''
     segyread tape=$SOURCE tfile=${TARGETS[1]}
     hfile=${TARGETS[2]} bfile=${TARGETS[3]} |
     put n2=60 n3=4 d2=100 o2=178
     label1=Time unit1=s label2=Offset unit2=m
     ''',stdin=0)

Flow('gath1','gath','stack axis=3') # window n3=1 f3=3')
Flow('off1','tgath',
     '''
     put n2=60 n3=4 d2=100 o2=178 | window n3=1 f3=3 |
     sfdd type=float | sfheadermath output=gx-sx | window
     ''')

Plot('gath1','grey title="CMP Gather" ')

Flow('vscan','gath1','vscan half=n v0=1400 dv=10 nv=161 semblance=y')

Plot('vscan','window min1=1 max1=4 max2=2500 | grey color=j allpos=y title="Semblance Scan" ')

Flow('pick2','vscan',
     'mutter inner=y half=n x0=1400 t0=1.5 v0=140 | pick rect1=50 | window')

Plot('pick2',
     '''
     window min1=1 max1=4 | 
     graph transp=y yreverse=y min2=1400 max2=2500 plotcol=7 plotfat=3
     pad=n wanttitle=n wantaxis=n
     ''')

Plot('vscan2','vscan pick2','Overlay')

Flow('nmo2','gath1 pick2','nmo velocity=${SOURCES[1]} half=n str=0.01')

Plot('nmo2','window min1=1 max1=4 | grey title="Hyperbolic NMO" ')

Result('gath','gath1 vscan2 nmo2','SideBySideAniso')

Flow('mod',None,
     '''
     math n1=3001 n2=19 o2=1 d2=0.5 o1=-10 d1=0.02
     output=x2
     ''')
Flow('mod2','mod','transp | pad beg1=2 | math output="1.5+0.4*x1" ')
Plot('mod2',
     '''
     grey color=j allpos=y title=Model scalebar=y
     barlabel=Velocity barunit=km/s min2=0 max2=20 min1=0 max1=10
     label1=Depth unit1=km label2=Lateral unit2=km
     barreverse=y pclip=100 
     ''')
Plot('mod1','mod',
     '''
     graph yreverse=y pad=n min2=0 max2=10
     plotcol=0 plotfat=20 wantaxis=n wanttitle=n scalebar=y
     ''')
Plot('mod0','mod',
     '''
     graph yreverse=y pad=n min2=0 max2=10
     plotcol=7 plotfat=5 wantaxis=n wanttitle=n scalebar=y
     ''')
Plot('mod','mod2 mod1 mod0','Overlay')
     
Flow('dat','mod',
     '''
     kirmod nt=2001 dt=0.004 freq=10
     ns=1 s0=0 ds=0.5
     nh=241 h0=0 dh=0.05
     vel=1.5 gradz=0.4 type=v
     ''')

Flow('dat2','dat',
     '''
     tpow tpow=1 | costaper nw1=250 | 
     put label1=Time unit1=s label2=Offset unit2=km
     ''')

Plot('dat2','grey title=Data')

Result('dat','mod dat2','SideBySideAniso')

Flow('scan','dat2',
     'vscan v0=1.2 nv=241 dv=0.0125 half=n semblance=y')
Plot('scan2','scan',
     '''
     window min1=0.5 max1=6.5 |
     grey color=j allpos=y title="Semblance Scan"
     ''')

Flow('pick','scan','pick rect1=50 vel0=1.5 | window')
Plot('pick',
     '''
     window min1=0.5 max1=6.5 | 
     graph yreverse=y transp=y pad=n min2=1.2 max2=4.2
     plotcol=7 plotfat=5 wantaxis=n wanttitle=n 
     ''')

Plot('scan','scan2 pick','Overlay')

Flow('nmo','dat2 pick','nmo velocity=${SOURCES[1]} half=n')
Plot('nmo','window min1=0.5 max1=6.5 | grey title=NMO')

Result('nmo','scan nmo','SideBySideAniso')

Flow('nmo0','dat2','nmostretch half=n v0=2')
Plot('nmo0','grey title="Partial NMO" ')

Flow('dip0','nmo0','dip rect1=20 rect2=5')
Plot('dip0','grey title=Slope color=j scalebar=y')

Result('nmo0','nmo0 dip0','SideBySideAniso')

Flow('flt0','nmo0 dip0',
     'flat dip=${SOURCES[1]} eps=0.05 | mutter half=n v0=1.6 t0=-2.3')
Plot('flt0','grey title=Flattened')

Flow('picks npicks','nmo0',
     '''
     window n2=1 |
     envelope | smooth rect1=10 |
     max1 picks=${TARGETS[1]} np=50 |
     window f1=1 n1=21
     ''')

Flow('pick0','dip0','remap1 n1=2200 | pwpick | window n1=2001')
Plot('pick0','pick0 picks',
     'contour cfile=${SOURCES[1]} wantaxis=n wanttitle=n')

Plot('nmopick0','nmo0 pick0','Overlay')

Result('flt0','nmopick0 flt0','SideBySideAniso')
    
End()
