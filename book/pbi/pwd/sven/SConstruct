from rsfproj import *

def velplot(title,label1='Depth',unit1='kft'):
    return '''
    grey color=j allpos=y title="%s" scalebar=y
    barlabel=Velocity barunit=kft/s
    label1=%s unit1=%s label2=Lateral unit2=kft
    barreverse=y pclip=100 
    ''' % (title,label1,unit1)

def graph(transp,o2,d2,n2,col,fat,extra=''):
    return '''
    graph transp=%d yreverse=y pad=n min2=%g max2=%g
    plotcol=%d plotfat=%d wantaxis=n wanttitle=n %s
    ''' % (transp,o2,o2+(n2-1)*d2,col,fat,extra)

def wiggle(title):
    return  '''
    wiggle transp=y yreverse=y poly=y xpos=${SOURCES[1]}
    title="%s" label2="Half-Offset (kft)" zplot=0.5
    wherexlabel=t wheretitle=b
    ''' % title

Flow('modl',None,
     '''
     spike n1=401 o1=-16 d1=0.08
     n2=4 nsp=4 k2=1,2,3,4 mag=1,3,5,7
     ''')
Flow('refl',None,
     '''
     spike n1=401 n2=4 nsp=4 k2=1,2,3,4
     mag=0.0909091,0.1428570,0.1111110,0.2000000
     ''')
Flow('mod1','modl','window min1=0')

Flow('mod2',None,'math n1=150 d1=0.05 output=5+2*x1 n2=401 o2=-16 d2=0.08')
Plot('modl','mod2',velplot('Model'))
Plot('modla','mod1',graph(0,0,0.05,150,0,20,'scalebar=y'))
Plot('modlb','mod1',graph(0,0,0.05,150,7,5,'scalebar=y'))
Result('modl','modl modla modlb','Overlay')

Flow('clean','modl refl',
     '''
     kirmod nt=376 dt=0.004 freq=25 refl=${SOURCES[1]}
     ns=1 s0=0 ds=0.05
     nh=150 h0=0.1 dh=0.05
     vel=5 gradz=2 type=v
     ''')
Flow('data','clean',
     '''
     noise rep=y seed=2004 range=0.0001 |
     ricker1 frequency=25 |
     add $SOURCE 
     ''')
Result('data','grey title=CMP label2=Offset unit2=kft')

Flow('scan','data','vscan half=n semblance=y v0=4 nv=101 dv=0.1')
Result('scan','grey color=j allpos=y title="Velocity Scan" unit2=kft/s')

Flow('pick','scan','pick rect1=40')
Flow('nmo','data pick','nmo velocity=${SOURCES[1]} half=n')
Result('nmo','grey title="Normal Moveout (Hyperbolic)" ')

Flow('dip0','data',
     '''
     math output="%g*x2/x1" |
     mutter half=n v0=50 t0=0.004 tp=0.2
     ''' % (0.05/(0.004*36)))
Flow('dip','data dip0',
     '''
     dip pmin=0 order=1 liter=100 idip=${SOURCES[1]}
     niter=10 rect1=40 rect2=5
     ''')
Result('dip','grey title=Slope scalebar=y clip=4 maxval=4 color=j allpos=y')

Flow('flat','data dip','flat dip=${SOURCES[1]}')
Result('flat','grey title=Flattened')

Flow('pnmo vel','data dip',
     'pnmo half=n dip=${SOURCES[1]} vel=${TARGETS[1]}')
Result('pnmo','grey title="Oriented Normal Moveout (Hyperbolic)" ')

Flow('inp',None,
     '''
     randrefl nr=1000 func=m d1=0.004 tscale=6 |
     window n2=1 max1=6 |
     spray axis=2 n=121 o=-6 d=0.1 |
     math output=input*x2     
     ''')

Result('inp','grey title=Reflectivity')

Flow('vnmo','inp','window n2=1 | math output=4+0.5*x1')

Flow('cmp','inp vnmo',
     '''
     noise rep=y seed=2004 range=0.2 |
     ricker1 |
     add $SOURCE |
     inmo velocity=${SOURCES[1]}
     ''')

Result('cmp','grey title=CMP')

for avo in ('','avo'):
    semb = avo+'semb'
    Flow(semb,'cmp','vscan %ssemblance=y v0=4 dv=0.075 nv=60' % avo)
    Result(semb,
           '''
           grey color=j allpos=y
           label2="Velocity" unit2="kft/s" title="%s Semblance"
           ''' % string.upper(avo))

End()
