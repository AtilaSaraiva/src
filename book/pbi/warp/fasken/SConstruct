from rsfproj import *
import string,math
import warp

data = {
    'pp': 'Pw.sgy',
    'ps': 'Cw.sgy'
    }

time = {
    'pp': int(1.5/0.002),
    'ps': int(2.413/0.002)
    }

line=67
trace=74

Flow('line.asc',None,
     'echo %d 0 %d 4 n1=4 data_format=ascii_float in=$TARGET' %
     (trace,trace))
Plot('line','line.asc',
     '''
     dd form=native | dd type=complex |
     graph min2=0 max2=2.5 min1=17.05 max1=133.5 pad=n wantaxis=n wanttitle=n
     ''')

import os
private = {'login':os.environ.get('BEG_LOGIN'),
           'password':os.environ.get('BEG_PASSWORD'),
           'server':os.environ.get('BEG_SERVER')}

for mode in ['pp','ps']:
    Fetch(data[mode],'fasken',private)
    Flow([mode,'./'+mode+'hhead','./'+mode+'bhead',mode+'head'],data[mode],
         '''segyread tape=$SOURCE
         hfile=${TARGETS[1]} bfile=${TARGETS[2]} tfile=${TARGETS[3]}
         fldr=180 tracf=184 sx=188 sy=193
         ''',stdin=0)
    Flow(mode+'cube',mode,'intbin | window n2=116 n3=132 min2=18 min3=15')
    Result(mode,mode+'cube',
           '''
           byte gainpanel=all |
           grey3 title="%s" flat=n frame1=%d frame2=%d frame3=%d
           point1=0.75 point2=0.75
           label1="Time (s)" label2="In-line" label3="Cross-line"
           ''' % (string.upper(mode),(794,1268)[mode=='ps'],trace-18,line-15))

Result('pp2','ppcube22 line','Overlay')
Result('ps2','pscube2 line','Overlay')

nails = Split('''
1.046 1.788
1.188 1.976
1.396 2.270
1.560 2.492
3.000 4.500
''')  

Flow('nails.asc',None,
     'echo %s n1=2 n2=%d in=$TARGET data_format=ascii_float' %
     (string.join(nails,' '),len(nails)/2))
Flow('nails','nails.asc','dd form=native')
Flow('nreal','nails','window n1=1')
Flow('nimag','nails','window f1=1')
Plot('nails','nreal nimag',
     '''
     cmplx ${SOURCES[:2]} |
     graph min1=0 max1=3 min2=0 max2=4 symbol='o' wanttitle=n
     label1="PP time (s)" label2="PS time (s)" plotcol=5
     symbolsz=15
     ''',stdin=0)

Flow('fit','nails ppcube','linefit pattern=${SOURCES[1]}')
Plot('fit','graph min1=0 max1=3 min2=0 max2=4 title="Line Fit" ')
Result('fnails','fit nails','Overlay')

Flow('fit0','fit',
     '''
     math output=input-x1 |
     spray axis=2 n=116 d=1 o=18 |
     spray axis=3 n=132 d=1 o=15
     ''')

Flow('ppcube2','ppcube','window min1=0.5 max1=2 | costaper nw1=300')

Flow('fit2','fit0','window min1=0.5 max1=2')

warp.warp3('fas','ppcube2','pscube','fit2',
           nx=116,
           ny=132,
           j2=4,
           j3=4,
           tmin=0.5,
           tmax=2,
           inter=2,
           trace=trace,
           line=line,
           o2=18,
           o3=15,
           dt=0.002,
           g0=0.96,
           gmin=1.5,
           gmax=2.5,
           pmin=1,
           ng=51,
           rect1=50,
           rect2=25,
           rect3=25,
           fmin=10,
           fmax=40,
           frect=6,
           frame1=544,
           iter=2,
           clip=3.5)

End()
