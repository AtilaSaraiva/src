from rsfproj import *

import os
private = {'login':os.environ.get('BEG_LOGIN'),
           'password':os.environ.get('BEG_PASSWORD'),
           'server':os.environ.get('BEG_SERVER')}

Fetch('cmp.hh','acig',private)
Flow('cmp','cmp.hh','dd form=native | tpow tpow=2 | mutter v0=1.4 half=n')

def grey(title,other=''):
    return '''
    grey title="%s" labelsz=10 titlesz=12
    label1="Time (s)" label2="Offset (km)" %s
    ''' % (title,other)

Plot('cmp',grey('(a) Data','clip=228'))

# Interpolate near offsets
Flow('cmp0','cmp','window max2=1 | pad beg2=5')
Flow('cmp1','cmp0','reverse which=2 opt=n | cat axis=2 $SOURCE')
Flow('mask0','cmp','math output=1 | window max2=1 | pad beg2=5')
Flow('mask1','mask0','reverse which=2 opt=n | cat axis=2 $SOURCE')
Flow('dip1','cmp1','math output="x2*%g/(x1+0.001)" ' % (0.05/(0.004*1.5*1.5)))
Flow('dip2','cmp1 dip1 mask1',
     'twodip2 eps=100 lam=10 dip1=${SOURCES[1]} mask=${SOURCES[2]} q0=0')
Flow('mis','cmp1 dip2 mask1',
     '''
     planemis2 dip=${SOURCES[1]} mask=${SOURCES[2]} verb=y prec=0 niter=10000
     ''')
Flow('mis2','mis cmp','window min2=0 n2=6 | cat axis=2 ${SOURCES[1]}')
Flow('mis3','mis2','window f2=1 | reverse which=2 opt=n | cat axis=2 $SOURCE')
Plot('mis2','grey title="Near Offsets Interpolated" ')

# Predict multiples
###################
Flow('ccmp','mis2','pad n1=2048 | fft1 | fft3')
Flow('mult','ccmp',
     'add mode=p $SOURCE | fft3 inv=y | fft1 inv=y | window n1=1000')
Plot('mult','window f2=6 | ' + grey('(b) SRME-predicted Multiples'))


shifts = ['shift0']
Flow('shift0','mult','window f2=6')
for s in range(1,15):
    shift = 'shift-%d' % s
    Flow(shift,'mult','window f1=%d f2=6 | pad end1=%d' % (s,s))
    shifts.append(shift)

    shift = 'shift+%d' % s
    Flow(shift,'mult','window n1=%d f2=6 | pad beg1=%d' % (1000-s,s))
    shifts.append(shift)
Flow('shifts',shifts,'cat ${SOURCES[1:%d]}' % len(shifts))

Flow('flt pre','shifts cmp',
     'lpf match=${SOURCES[1]} pred=${TARGETS[1]} rect1=20 rect2=10 niter=400')
Flow('sig','cmp pre','add scale=1,-1 ${SOURCES[1]}')

Plot('flt','window n3=1 | scale dscale=10000 | ' + grey('(c) First Filter Coefficient','color=j scalebar=y'))
Plot('flt2','flt','stack axis=3 norm=n | scale dscale=10000 | ' + grey('(d) Sum of Filter Coefficients','color=j scalebar=y'))

Plot('sig',grey('(a) Estimated Signal','clip=228'))
Plot('pre',grey('(b) Matched Multiples','clip=228'))

Result('pef','cmp mult flt flt2','SideBySideAniso')

# Velocity scans before and after
#################################
for dat in ('cmp','sig'):
    Flow('v'+dat,dat,'vscan semblance=y v0=1 nv=100 dv=0.02 half=n')
    Plot('v'+dat,grey('(%s) Velocity Scan (%s)' % (('c','Data'),('d','Estimated Signal'))[dat=='sig'],
                      'label2="Velocity (km/s)" color=j allpos=y'))

Result('pre','sig pre vcmp vsig','SideBySideAniso')

Flow('flt0','flt','stack axis=2 | stack axis=1')

Result('flt0','dots label1=') 

End()
