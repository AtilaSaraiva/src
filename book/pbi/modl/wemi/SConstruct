from rsfproj import *
import math

#shot1 Xs= 0.152km, depth=0.0762km
#delta shot DXs=0.060906km
#no of shots = 95 
#Receivers from 0.1524km to 5.8887km with spacing of 0.006096km

private = {'login':os.environ.get('BEG_LOGIN'),
           'password':os.environ.get('BEG_PASSWORD'),
           'server':os.environ.get('BEG_SERVER')}

for case in ('vp','vs','rho'):
    bin = case + '.bin'    
    Fetch(bin,'wemi',private)
    Flow('./'+case,bin,
         '''
         echo in=$SOURCE
         n1=875 o1=0 d1=0.003048 label1=z unit1=km
         n2=991 o2=0 d2=0.006096 label2=x unit2=km
         label=%s unit=%s
         data_format=native_float 
         ''' % (('Velocity','km/s'),('Density','gm/cc'))[case=='rho'],
         stdin=0)
    Result(case,'./'+case,
           '''
           grey title=%s color=j allpos=y scalebar=y
           barreverse=y
           ''' % string.capitalize(case))

z0 = 0.170688
dz = 0.003048
nw = 56
nz = 819
z = (nz-1)*dz

x0 = 0
dx = 0.00609606
nx = 991

v0 = 1.60308
vmax = 3.53254
dvdz = (vmax-v0)/z

Flow('vp2','./vp','window f1=%d' % nw)

Flow('inc','vp2',
     'math output="input-(%g+%g*(x1-%g))" ' % (v0,dvdz,z0))


Flow('mask','vp2',
     '''
     deriv | mask max=0 | dd type=float |
     smooth rect1=3 |
     deriv | mask min=0.17 
     ''')

for x in range(2):
    xc = 'x%d' % (x+1)
    Flow(xc,'vp2 mask',
         '''
         math output=%s |
         put n1=1 n2=%d |
         headerwindow mask=${SOURCES[1]} |
         window j2=2
         ''' % (xc,nz*nx))

nsp = 703

Flow('spl','x1 x2',
     '''
     math output=input+%g |
     cat axis=2 ${SOURCES[1]} |
     reverse which=2 |
     sftransp |
     spline n1=%d d1=%g o1=0
     ''' % (3*dz,nsp,dx));

ns = 2

Flow('spl2','spl',
     'remap1 n1=%d d1=%g o1=%g' % (2*ns*nx-1,dx/ns,-nx*dx))
Flow('dip2','spl2','deriv | scale dscale=%g' % (ns/dx))

Plot('vp2',
     '''
     grey title=Vp color=j allpos=y scalebar=y
     barreverse=y 
     ''')
Plot('spl',
     '''
     graph scalebar=y yreverse=y plotfat=2
     plotcol=7 pad=n min2=%g max2=%g min1=%g max1=%g
     wantaxis=n wanttitle=n
     ''' % (z0-0.5*dz,z0+(nz-0.5)*dz,x0-0.5*dx,x0+(nx-0.5)*dx))

Result('edge','vp2 spl','Overlay')

Flow('spl0','spl','math output=input-%g' % (2*dz))
Flow('spl1','spl','math output=input+%g' % (2*dz))

for case in ('vp','vs','rho'):
    for s in ('0','1'):
        Flow(case+s,['./'+case,'spl'+s],
             '''
             window f1=%d n2=%d | transp | slice pick=${SOURCES[1]} | window
             ''' % (nw,nsp))
    Flow('d'+case,[case+'0',case+'1'],
         '''
         math v1=${SOURCES[0]} v2=${SOURCES[1]}
         output="(v2-v1)/(v2+v1)"
         ''')

Flow('ab','vp0 vp1 vs0 vs1',
     '''
     math a1=${SOURCES[0]} a2=${SOURCES[1]} b1=${SOURCES[2]} b2=${SOURCES[3]}
     output="(a1+a2)/(b1+b2)"
     ''')

Flow('refl','dvp drho','add ${SOURCES[1]} | window max1=4.1')
Plot('refl','graph title="AVA Intercept" ')

Flow('rgrad','dvp dvs drho ab',
     '''
     math da=${SOURCES[0]} db=${SOURCES[1]} dr=${SOURCES[2]} ab=${SOURCES[3]}
     output="da - 4.*(2.*db+dr)/(ab*ab)" | window max1=4.1
     ''')
Plot('rgrad','graph title="AVA Gradient" ')

Result('ava','refl rgrad','SideBySideAniso')

Flow('ar','refl','spray axis=3 n=101 o=0 d=0.45')
Flow('ag','rgrad','spray axis=3 n=101 o=0 d=0.45')
Flow('avas','ar ag',
     '''
     math g=${SOURCES[1]} output="input+(sin(%g*x3)^2)*g" |
     transp plane=13
     ''' % (math.pi/180))
Plot('avas',
     '''
     window j3=10 squeeze=n |
     graph min2=-0.11 max2=0.05 title=AVA
     label2=Reflectivity unit2=
     label1=Angle unit1=degrees
     ''')

for ava in ('refl','rgrad'):
    Flow(ava+'2',[ava,'spl2'],
         'pad n1=%d | remap1 pattern=${SOURCES[1]}' % nx)

Flow('shot','spl2 dip2 refl2 rgrad2',
     '''
     kirmod dip=${SOURCES[1]}
     refl=${SOURCES[2]} rgrad2=${SOURCES[3]}
     ns=1  s0=%g ds=%g
     nh=%g h0=%g dh=%g
     nt=1001 dt=0.004 
     freq=20 twod=y
     type=v vel=%g gradz=%g
     ''' % (x0,dx,2*nx-1,-nx*dx,dx,v0,dvdz))

Plot('shot','window min2=0 | grey title="Shot 0" pclip=100')

Flow('shots','spl2 dip2 refl2 rgrad2',
     '''
     kirmod dip=${SOURCES[1]} verb=y
     refl=${SOURCES[2]} rgrad2=${SOURCES[3]}
     ns=%g s0=%g ds=%g
     nh=%g h0=%g dh=%g
     nt=1001 dt=0.004 
     freq=20 twod=y
     type=v vel=%g gradz=%g
     ''' % (nx/10,x0,dx*10,2*nx-1,-nx*dx,dx,v0,dvdz))

Flow('slow','./vp',
     '''
     window n1=%d |
     math output=1/input |
     transp | spray axis=2 n=1 d=%g
     ''' % (nw,dx))
Flow('wvld','shot',
     '''
     fft1 | transp plane=12 | transp plane=23
     ''')
Flow('datm','wvld slow',
     '''
     zomig mode=d inv=n causal=y twoway=n 
     slo=${SOURCES[1]} verb=y tmx=16
     ''')
Flow('shot2','datm','window | transp | fft1 inv=y')

Plot('shot2','window min2=0 | grey title="Redatumed Shot 0" pclip=100')

Result('shot','shot shot2','SideBySideAniso')

End()
