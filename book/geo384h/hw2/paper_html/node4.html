<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">

<!--Converted with LaTeX2HTML 2008 (1.71)
original version by:  Nikos Drakos, CBLU, University of Leeds
* revised and updated by:  Marcus Hennecke, Ross Moore, Herb Swan
* with significant contributions from:
  Jens Lippmann, Marek Rouchal, Martin Wilck and others -->
<HTML>
<HEAD>
<TITLE>Running median and running mean filters</TITLE>
<META NAME="description" CONTENT="Running median and running mean filters">
<META NAME="keywords" CONTENT="paper">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">

<META NAME="Generator" CONTENT="LaTeX2HTML v2008">
<META HTTP-EQUIV="Content-Style-Type" CONTENT="text/css">

<LINK REL="STYLESHEET" HREF="paper.css">

<LINK REL="next" HREF="node5.html">
<LINK REL="previous" HREF="node3.html">
<LINK REL="up" HREF="paper.html">
<LINK REL="next" HREF="node5.html">
</HEAD>

<BODY >
<table align="center" width="100%" cellpadding="0" cellspacing="0">
<tr>
<td>
<A NAME="tex2html52"
  HREF="node5.html">
<IMG WIDTH="32" HEIGHT="32" ALIGN="BOTTOM" BORDER="0" ALT="next"
 SRC="icons/next.png"></A></td>
<td>
<A NAME="tex2html50"
  HREF="paper.html">
<IMG WIDTH="32" HEIGHT="32" ALIGN="BOTTOM" BORDER="0" ALT="up"
 SRC="icons/up.png"></A></td>
<td>
<A NAME="tex2html44"
  HREF="node3.html">
<IMG WIDTH="32" HEIGHT="32" ALIGN="BOTTOM" BORDER="0" ALT="previous"
 SRC="icons/previous.png"></A></td>
<td><img src="icons/left.png" width="16" height="32" border="0"></td><td class="navigation" align="center" width="100%">Homework 2</td><td><img src="icons/right.png" width="16" height="32" border="0"></td>
<td><a href="../paper.pdf"><img src="icons/pdf.png" alt="[pdf]" width="32" height="32" border="0"></a></td>
</tr></table>
<BR>
<B> Next:</B> <A NAME="tex2html53"
  HREF="node5.html">Derivative filters</A>
<B>Up:</B> <A NAME="tex2html51"
  HREF="paper.html">Homework 2</A>
<B> Previous:</B> <A NAME="tex2html45"
  HREF="node3.html">Sorting algorithms</A>
<BR><HR>

<!--End of Navigation Panel-->

<H1><A NAME="SECTION00040000000000000000">
Running median and running mean filters</A>
</H1>

<P>
<P><CENTER>
<A NAME="fig:dem"></A>
<TABLE BORDER=0>
<TR>
<TH WIDTH="40%">
<STRONG><A HREF = "../running/Fig/dem.png">dem</A>
<BR>
Figure 2.</STRONG> Digital elevation map of the 
west Austin area.
<TH rowspan=2>
<IMG SRC = "../running/Fig/dem.png" border="0" width=303 ALT = "dem">

<TR><TH WIDTH="40%">
 <a href="../running/Fig/dem.pdf"><img src="icons/pdf.png" border="0" alt="[pdf]" width="32" height="32"></a> <a href="../running/Fig/dem.png"><img src="icons/viewmag.png" border="0" alt="[png]" width="32" height="32"></a> <a href="../running.html"><img src="icons/configure.png" border="0" alt="[scons]" width="32" height="32"></a>
</TABLE></CENTER></P>

<P>
We return the digital elevation map of the West Austin Area, shown in Figure&nbsp;<A HREF="#fig:dem">2</A>.

<P>
In this exercise, we will separate the data into ``signal'' and
``noise'' by applying running mean and median filters.  The result of
applying a running median filter is shown in
Figure&nbsp;<A HREF="#fig:ave_res">3</A>. Running median effectively smooths the data
by removing local outliers.

<P>
<P><CENTER>
<A NAME="fig:ave_res"></A>
<TABLE BORDER=0>
<TR><TH>
<A NAME="fig:ave"></A>
<IMG SRC = "../running/Fig/ave.png" border="0" width=303 ALT = "ave">
<A NAME="fig:res"></A>
<IMG SRC = "../running/Fig/res.png" border="0" width=303 ALT = "res">

<TR><TH>
<STRONG><A HREF = "../running/Fig/ave.png">ave</A>,<A HREF = "../running/Fig/res.png">res</A>
<BR>
Figure 3.</STRONG> Data separated into
  signal (a) and noise (b) by applying a running median filter.
<TR><TH>
 <a href="../running/Fig/ave.pdf"><img src="icons/pdf.png" border="0" alt="[pdf]" width="32" height="32"></a> <a href="../running/Fig/res.pdf"><img src="icons/pdf.png" border="0" alt="[pdf]" width="32" height="32"></a> <a href="../running/Fig/ave.png"><img src="icons/viewmag.png" border="0" alt="[png]" width="32" height="32"></a> <a href="../running/Fig/res.png"><img src="icons/viewmag.png" border="0" alt="[png]" width="32" height="32"></a> <a href="../running.html"><img src="icons/configure.png" border="0" alt="[scons]" width="32" height="32"></a>
</TABLE>
<BR></CENTER></P>

<P>
The algorithm is implemented in program <TT>running.c</TT>.

<P>

<div><table><tr><td><pre class="code">
<I><FONT COLOR="#B22222">/* Apply running mean or median filter */</FONT></I>

#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&lt;rsf.h&gt;</FONT></B>

<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">float</FONT></B> <B><FONT COLOR="#0000FF">slow_median</FONT></B>(<B><FONT COLOR="#228B22">int</FONT></B> n, <B><FONT COLOR="#228B22">float</FONT></B>* list)
<I><FONT COLOR="#B22222">/* find median by slow sorting, changes list */</FONT></I>
{
    <B><FONT COLOR="#228B22">int</FONT></B> k, k2;
    <B><FONT COLOR="#228B22">float</FONT></B> item1, item2;
    
    <B><FONT COLOR="#A020F0">for</FONT></B> (k=0; k &lt; n; k++) {
	item1 = list[k];

	<I><FONT COLOR="#B22222">/* assume everything up to k is sorted */</FONT></I>
        <B><FONT COLOR="#A020F0">for</FONT></B> (k2=k; k2 &gt; 0; k2-) {
            item2 = list[k2-1];
            <B><FONT COLOR="#A020F0">if</FONT></B> (item1 &gt;= item2) <B><FONT COLOR="#A020F0">break</FONT></B>;
	    list[k2]   = item2;
	}
	list[k2] = item1;
    }
    
    <B><FONT COLOR="#A020F0">return</FONT></B> list[n/2];
}

<B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">main</FONT></B>(<B><FONT COLOR="#228B22">int</FONT></B> argc, <B><FONT COLOR="#228B22">char</FONT></B>* argv[]) 
{
    <B><FONT COLOR="#228B22">int</FONT></B> w1, w2, nw, s1,s2, j1,j2, i1,i2,i3, n1,n2,n3;
    <B><FONT COLOR="#228B22">char</FONT></B> *how;
    <B><FONT COLOR="#228B22">float</FONT></B> **data, **signal, **win;
    sf_file in, out;

    sf_init (argc,argv);
    in = sf_input(<B><FONT COLOR="#BC8F8F">"in"</FONT></B>);
    out = sf_output(<B><FONT COLOR="#BC8F8F">"out"</FONT></B>);

    <I><FONT COLOR="#B22222">/* get data dimensions */</FONT></I>
    <B><FONT COLOR="#A020F0">if</FONT></B> (!sf_histint(in,<B><FONT COLOR="#BC8F8F">"n1"</FONT></B>,&amp;n1)) sf_error(<B><FONT COLOR="#BC8F8F">"No n1="</FONT></B>);
    <B><FONT COLOR="#A020F0">if</FONT></B> (!sf_histint(in,<B><FONT COLOR="#BC8F8F">"n2"</FONT></B>,&amp;n2)) sf_error(<B><FONT COLOR="#BC8F8F">"No n2="</FONT></B>);
    n3 = sf_leftsize(in,2);

    <I><FONT COLOR="#B22222">/* input and output */</FONT></I>
    data = sf_floatalloc2(n1,n2);
    signal = sf_floatalloc2(n1,n2);

    <B><FONT COLOR="#A020F0">if</FONT></B> (!sf_getint(<B><FONT COLOR="#BC8F8F">"w1"</FONT></B>,&amp;w1)) w1=5;
    <B><FONT COLOR="#A020F0">if</FONT></B> (!sf_getint(<B><FONT COLOR="#BC8F8F">"w2"</FONT></B>,&amp;w2)) w2=5;
    <I><FONT COLOR="#B22222">/* sliding window width */</FONT></I>

    nw = w1*w2;
    win = sf_floatalloc2(w1,w2);

    how = sf_getstring(<B><FONT COLOR="#BC8F8F">"how"</FONT></B>); 
    <I><FONT COLOR="#B22222">/* what to compute 
       (fast median, slow median, mean) */</FONT></I>
    <B><FONT COLOR="#A020F0">if</FONT></B> (NULL == how) how=<B><FONT COLOR="#BC8F8F">"fast"</FONT></B>;

    <B><FONT COLOR="#A020F0">for</FONT></B> (i3=0; i3 &lt; n3; i3++) {

	<I><FONT COLOR="#B22222">/* read data plane */</FONT></I>
	sf_floatread(data[0],n1*n2,in);
	
	<B><FONT COLOR="#A020F0">for</FONT></B> (i2=0; i2 &lt; n2; i2++) {
	    s2 = SF_MAX(0,SF_MIN(n2-w2,i2-w2/2-1));
	    <B><FONT COLOR="#A020F0">for</FONT></B> (i1=0; i1 &lt; n1; i1++) {
		s1 = SF_MAX(0,SF_MIN(n1-w1,i1-w1/2-1));

		<I><FONT COLOR="#B22222">/* copy window */</FONT></I>
		<B><FONT COLOR="#A020F0">for</FONT></B> (j2=0; j2 &lt; w2; j2++) {
		    <B><FONT COLOR="#A020F0">for</FONT></B> (j1=0; j1 &lt; w1; j1++) {
			win[j2][j1] = data[s2+j2][s1+j1];
		    }}

		<B><FONT COLOR="#A020F0">switch</FONT></B> (how[0]) {
		    <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#BC8F8F">'f'</FONT></B>: <I><FONT COLOR="#B22222">/* fast median */</FONT></I>
			signal[i2][i1] = 
			    sf_quantile(nw/2,nw,win[0]);
			<B><FONT COLOR="#A020F0">break</FONT></B>;
		    <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#BC8F8F">'s'</FONT></B>: <I><FONT COLOR="#B22222">/* slow median */</FONT></I>
			signal[i2][i1] = 
			    slow_median(nw,win[0]);
			<B><FONT COLOR="#A020F0">break</FONT></B>;
		    <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#BC8F8F">'m'</FONT></B>: <I><FONT COLOR="#B22222">/* mean */</FONT></I>
		    <B><FONT COLOR="#5F9EA0">default</FONT></B>:
			<I><FONT COLOR="#B22222">/* !!! ADD CODE !!! */</FONT></I>
			<B><FONT COLOR="#A020F0">break</FONT></B>;
		}
	    }
	}
	
	<I><FONT COLOR="#B22222">/* write out */</FONT></I>
	sf_floatwrite(signal[0],n1*n2,out);
    }	

    exit(0);
}
</pre></table></div>

<P>

<OL>
<LI>Change directory to <TT>hw2/running</TT>.
</LI>
<LI>Run 
<PRE>
scons view
</PRE>
to reproduce the figures on your screen.
</LI>
<LI>Modify the <TT>running.c</TT> program and the
  <TT>SConstruct</TT> file to compute running mean instead of running
  median. Compare the results.
</LI>
<LI><B>EXTRA CREDIT</B> for improving the efficiency of the
  running median algorithm. Run
<PRE>
scons time.vpl
</PRE>
  to display a figure that compares the efficiency of running median
  computations using the slow sorting from function <TT>median</TT> in
  program <TT>running.c</TT> and the fast quantile algorithm (library
  function <TT>sf_quantile</TT> ). Your goal is to make the algorithm
  even faster. Consider parallelization, reusing previous windows,
  other fast sorting strategies, etc.
</LI>
</OL>

<P>

<div><table><tr><td><pre class="code">
<B><FONT COLOR="#A020F0">from</FONT></B> rsf.proj <B><FONT COLOR="#A020F0">import</FONT></B> *

<I><FONT COLOR="#B22222"># Download data
</FONT></I>Fetch(<B><FONT COLOR="#BC8F8F">'austin-w.HH'</FONT></B>,<B><FONT COLOR="#BC8F8F">'bay'</FONT></B>)

<I><FONT COLOR="#B22222"># Convert format
</FONT></I>Flow(<B><FONT COLOR="#BC8F8F">'dem'</FONT></B>,<B><FONT COLOR="#BC8F8F">'austin-w.HH'</FONT></B>,<B><FONT COLOR="#BC8F8F">'dd form=native'</FONT></B>)

<I><FONT COLOR="#B22222"># Display
</FONT></I><B><FONT COLOR="#A020F0">def</FONT></B> <B><FONT COLOR="#0000FF">plot</FONT></B>(title):
    <B><FONT COLOR="#A020F0">return</FONT></B> <B><FONT COLOR="#BC8F8F">'''
    grey clip=250 allpos=y title="%s" 
    screenratio=1
    '''</FONT></B> % title

Result(<B><FONT COLOR="#BC8F8F">'dem'</FONT></B>,plot(<B><FONT COLOR="#BC8F8F">'Digital Elevation Map'</FONT></B>))

<I><FONT COLOR="#B22222"># Program for running average
</FONT></I>run = Program(<B><FONT COLOR="#BC8F8F">'running.c'</FONT></B>)

w = 30

<I><FONT COLOR="#B22222"># !!! CHANGE BELOW !!!
</FONT></I>Flow(<B><FONT COLOR="#BC8F8F">'ave'</FONT></B>,<B><FONT COLOR="#BC8F8F">'dem %s'</FONT></B> % run[0],
     <B><FONT COLOR="#BC8F8F">'./${SOURCES[1]} w1=%d w2=%d how=fast'</FONT></B> % (w,w))
Result(<B><FONT COLOR="#BC8F8F">'ave'</FONT></B>,plot(<B><FONT COLOR="#BC8F8F">'Signal'</FONT></B>))

<I><FONT COLOR="#B22222"># Difference
</FONT></I>Flow(<B><FONT COLOR="#BC8F8F">'res'</FONT></B>,<B><FONT COLOR="#BC8F8F">'dem ave'</FONT></B>,<B><FONT COLOR="#BC8F8F">'add scale=1,-1 ${SOURCES[1]}'</FONT></B>)
Result(<B><FONT COLOR="#BC8F8F">'res'</FONT></B>,plot(<B><FONT COLOR="#BC8F8F">'Noise'</FONT></B>) + <B><FONT COLOR="#BC8F8F">' allpos=n'</FONT></B>)

<I><FONT COLOR="#B22222">#############################################################
</FONT></I>
<B><FONT COLOR="#A020F0">import</FONT></B> sys

<B><FONT COLOR="#A020F0">if</FONT></B> sys.platform==<B><FONT COLOR="#BC8F8F">'darwin'</FONT></B>:
     gtime = WhereIs(<B><FONT COLOR="#BC8F8F">'gtime'</FONT></B>)
     <B><FONT COLOR="#A020F0">if</FONT></B> <B><FONT COLOR="#A020F0">not</FONT></B> gtime:
          <B><FONT COLOR="#A020F0">print</FONT></B> <B><FONT COLOR="#BC8F8F">"For computing CPU time, please install gtime."</FONT></B>
<B><FONT COLOR="#A020F0">else</FONT></B>:
     gtime = WhereIs(<B><FONT COLOR="#BC8F8F">'gtime'</FONT></B>) <B><FONT COLOR="#A020F0">or</FONT></B> WhereIs(<B><FONT COLOR="#BC8F8F">'time'</FONT></B>)

<I><FONT COLOR="#B22222"># slow or fast
</FONT></I><B><FONT COLOR="#A020F0">for</FONT></B> case <B><FONT COLOR="#A020F0">in</FONT></B> (<B><FONT COLOR="#BC8F8F">'fast'</FONT></B>,<B><FONT COLOR="#BC8F8F">'slow'</FONT></B>):

    ts = []
    ws = []

    time = <B><FONT COLOR="#BC8F8F">'time-'</FONT></B> + case
    wind = <B><FONT COLOR="#BC8F8F">'wind-'</FONT></B> + case

    <I><FONT COLOR="#B22222"># loop over window size
</FONT></I>    <B><FONT COLOR="#A020F0">for</FONT></B> w <B><FONT COLOR="#A020F0">in</FONT></B> range(3,16,2):
        itime = <B><FONT COLOR="#BC8F8F">'%s-%d'</FONT></B> % (time,w)
        ts.append(itime)

        iwind = <B><FONT COLOR="#BC8F8F">'%s-%d'</FONT></B> % (wind,w)
        ws.append(iwind)

        <I><FONT COLOR="#B22222"># measure CPU time
</FONT></I>

        Flow(iwind,None,<B><FONT COLOR="#BC8F8F">'spike n1=1 mag=%d'</FONT></B> % (w*w)) 
        Flow(itime,<B><FONT COLOR="#BC8F8F">'dem %s'</FONT></B> % run[0],
             <B><FONT COLOR="#BC8F8F">'''
             ( (%s -f "%%S %%U"
             ./${SOURCES[1]} &lt; ${SOURCES[0]} 
              w1=%d w2=%d what=%s &gt; /dev/null ) 2&gt;&amp;1 )
              &gt; time.out &amp;&amp;
             (tail -1 time.out; 
              echo in=time0.asc n1=2 data_format=ascii_float)
              &gt; time0.asc &amp;&amp;
             dd form=native &lt; time0.asc | stack axis=1 norm=n
             &gt; $TARGET &amp;&amp;
             /bin/rm time0.asc time.out
             '''</FONT></B> % (gtime,w,w,case),stdin=0,stdout=-1)
        
    Flow(time,ts,<B><FONT COLOR="#BC8F8F">'cat axis=1 ${SOURCES[1:%d]}'</FONT></B> % len(ts))
    Flow(wind,ws,<B><FONT COLOR="#BC8F8F">'cat axis=1 ${SOURCES[1:%d]}'</FONT></B> % len(ws))

    <I><FONT COLOR="#B22222"># complex numbers for plotting
</FONT></I>    Flow(<B><FONT COLOR="#BC8F8F">'c'</FONT></B>+time,[wind,time],
         <B><FONT COLOR="#BC8F8F">'''
         cat axis=2 ${SOURCES[1]} |
         transp |
         dd type=complex
         '''</FONT></B>)

<I><FONT COLOR="#B22222"># Display CPU time
</FONT></I>Plot  (<B><FONT COLOR="#BC8F8F">'time'</FONT></B>,<B><FONT COLOR="#BC8F8F">'ctime-fast ctime-slow'</FONT></B>,
       <B><FONT COLOR="#BC8F8F">'''
       cat axis=1 ${SOURCES[1]} | transp |
       graph dash=0,1 wanttitle=n
       label2="CPU Time" unit2=s
       label1="Window Size" unit1=
       '''</FONT></B>,view=1)

End()
</pre></table></div>

<P>
<HR>
<table align="center" width="100%" cellpadding="0" cellspacing="0">
<tr>
<td>
<A NAME="tex2html52"
  HREF="node5.html">
<IMG WIDTH="32" HEIGHT="32" ALIGN="BOTTOM" BORDER="0" ALT="next"
 SRC="icons/next.png"></A></td>
<td>
<A NAME="tex2html50"
  HREF="paper.html">
<IMG WIDTH="32" HEIGHT="32" ALIGN="BOTTOM" BORDER="0" ALT="up"
 SRC="icons/up.png"></A></td>
<td>
<A NAME="tex2html44"
  HREF="node3.html">
<IMG WIDTH="32" HEIGHT="32" ALIGN="BOTTOM" BORDER="0" ALT="previous"
 SRC="icons/previous.png"></A></td>
<td><img src="icons/left.png" width="16" height="32" border="0"></td><td class="navigation" align="center" width="100%">Homework 2</td><td><img src="icons/right.png" width="16" height="32" border="0"></td>
<td><a href="../paper.pdf"><img src="icons/pdf.png" alt="[pdf]" width="32" height="32" border="0"></a></td>
</tr></table>
<BR>
<B> Next:</B> <A NAME="tex2html53"
  HREF="node5.html">Derivative filters</A>
<B>Up:</B> <A NAME="tex2html51"
  HREF="paper.html">Homework 2</A>
<B> Previous:</B> <A NAME="tex2html45"
  HREF="node3.html">Sorting algorithms</A>

<!--End of Navigation Panel-->
<ADDRESS>
<I> <BR>
2016-09-15</I>
</ADDRESS>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-509367-3");
pageTracker._trackPageview();
</script>
</BODY>
</HTML>
