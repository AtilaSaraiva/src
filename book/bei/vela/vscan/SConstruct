###########################################################################
# STANDARD HEADER
###########################################################################
import sys, os

root = os.environ.get('RSFROOT')
sys.path.append(os.path.join(root,'lib'))

from rsfproj import *
###########################################################################
Book()

Flow('mod',None,
     '''
     spike n1=75 n2=35 d1=0.0533333 d2=0.0242157 o1=0 o2=0.01
     nsp=5 mag=2,1,1,1,1 k1=11,18,33,56,70 k2=28,19,19,19,19
     ''')
Flow('dat','mod','velmod h0=-1 dh=0.141026 nh=40 slowness=y half=n')
Flow('mod2','dat','vscan slowness=y half=n')
Flow('dat2','mod2','velmod slowness=y half=n')

for data in ('mod','dat','mod2','dat2'):
    Plot(data,data,
         '''
         dots gaineach=0 dots=0 seemean=1 strings=0
         constsep=1 overlap=6. transp=1 label1=" "
         ''')
Combine('top','mod dat','SideBySideAniso')
Combine('bot','mod2 dat2','SideBySideAniso')
Combine('velvel','top bot','OverUnderAniso',result=1)

Fetch('midpts.HH','midpts')

Flow('cdp','midpts.HH','window n3=1 j1=2 | dd data_format=native_float')
Flow('mutter','cdp','mutter half=n v0=1.4') 
Flow('veltran','mutter','vscan slowness=y half=n v0=0.3 nv=81 dv=0.005')

sides = ['mutter','veltran']
for case in sides:
    Plot(case,case,'grey wanttitle=n')
Combine('mutvel',sides,'SideBySideAniso',result=1,vppen='txscale=1.5')

Flow('wgmutter','midpts.HH',
     'dd data_format=native_float | mutter half=n v0=1.4')

Flow('wgsmb','wgmutter',
     'vscan slowness=y half=n v0=0.3 nv=81 dv=0.005 semblance=y')
Flow('wgfit','wgsmb','blindpick2 eps=25 lam=25')

def graph(col=7,fat=1):
    return '''
    graph min2=0.3 max2=0.7 pad=n transp=y yreverse=y wanttitle=n
    plotcol=%d plotfat=%d
    ''' % (col,fat)

Flow('fit','wgfit','window n3=1')
Plot('slow',   'fit',graph(1,1))
Plot('fatslow','fit',graph(0,7))
Combine('fit','veltran fatslow slow','Overlay',result=1) 

Flow('wgstack',['wgmutter','wgfit'],
     'nmo velocity=${SOURCES[1]} slowness=y half=n | stack')
Result('wgstack','wgstack','grey title=Stack')

Flow(['agcstack','ref'],'wgstack',
     '''
     math output="abs(input)" |
     smooth rect1=125 > ${TARGETS[1]};
     add mode=d ${SOURCES[0]} ${TARGETS[1]}
     ''')
Result('agcstack','agcstack','grey title="AGC Stack" ')

Flow('weight',['wgsmb','wgfit'],'slice pick=${SOURCES[1]}')
Flow('wgrms','wgfit','window | math output=1/input')
Flow(['wgint','wgrms2'],['wgrms','weight'],
     '''
     dix weight=${SOURCES[1]} vrmsout=${TARGETS[1]}
     rect1=10 rect2=10
     ''')

def velplot(title):
    return '''
    grey color=j wantscalebar=y barlabel="%s (km/s)" allpos=y bias=1.4
    bartype=h wherebarlabel=b wanttitle=n
    ''' % title

Plot('wgrms','wgrms',velplot("RMS velocity"))
Plot('wgint','wgint',velplot("Interval velocity"))
Combine('wgvel','wgrms wgint','SideBySideAniso',result=1)

Plot('wgrms2','wgrms2',velplot("Predicted RMS velocity"))
Combine('wgvel2','wgrms wgrms2','SideBySideAniso',result=1)

def velgraph(title,max):
    return '''
    window n2=1 |
    graph wanttitle=n transp=y yreverse=y label2="%s (km/s)"
    min2=1.4 max2=%g
    ''' % (title,max)

Plot('rms1','wgrms',velgraph("RMS velocity",2.4))
Plot('rms2','wgrms2',velgraph(" ",2.4) + ' dash=1 wantaxis=n')
Combine('rms','rms1 rms2','Overlay')
Plot('int','wgint',velgraph("Interval velocity",3))
Combine('wgvel1','rms int','SideBySideAniso',result=1)

###########################################################################
End()

