from rsf.proj import *
from rsf.recipes.beg import server

segy = 'stack_4500ms.sgy'
Fetch(segy,'ggulch-gxt',server)

Flow('stack tstack stack.asc stack.bin',
     segy,
     '''
     segyread tfile=${TARGETS[1]}
     hfile=${TARGETS[2]} bfile=${TARGETS[3]}
     ''')
Flow('stack3','stack',
     'intbin | put  label2=Inline label3=Crossline')
Flow('gibson-stack','stack3',
     '''
     window min1=0.5 max1=1.5 |
     put o1=500 unit1=ms d1=2.0 d2=33.55 d3=33.55 unit2=m unit3=m o4=0 n4=1 d4=100 label4=offset unit4=m
     ''')
# taper for data cube
Flow ('surface', 'gibson-stack', 'math output="abs(input)" | stack axis=1')
Flow ('mask','surface','taperedge len=21')
Flow ('cube-mask','mask','spray axis=3 n=501 | transp plane=23 | transp')
Flow ('gibson-stack-tpr', 'gibson-stack cube-mask', 'math x=${SOURCES[0]} y=${SOURCES[1]} output="x*y"')

####################################
# 1. DATA PROCESSING
####################################

# velocity model - constant 1000 m/s
Flow ('gibson-velmodel', None, 
	  '''
	  math n1=308 output=1000 |
	  put n1=2 n2=14 n3=11 n4=1 o1=500.0 o2=0.0 o3=0.0 o4=0.0 d1=1000.0 d2=1000.0 d3=1000.0 d4=1000.0 unit1=ms unit2=m unit3=m unit4=m
	  ''')

Flow ('image3 dag3', 'gibson-stack gibson-velmodel',
	  '''
	  tmigda vel=${SOURCES[1]} dag=${TARGETS[1]}
	  is3d=y isDipAz=n hmign=1
	  iyo=3000 iyn=41 iyd=25
	  ixo=1000 ixn=81 ixd=25
	  dipn=81 dipo=-40 dipd=1
	  sdipn=81 sdipo=-40 sdipd=1
	  ''')
Flow ('dag3sq','dag3','mul ${SOURCES[0]}')
Flow ('taper','dag3 dag3sq','crssemb3d dataSq=${SOURCES[1]} xapp=3 yapp=3')

# figs
#Result ('dag3-1','dag3',
#		'''
#	    window f4=20 n4=1 f5=20 n5=1 | put d1=0.001 o1=0.25 unit1=km label1=Depth |
#		byte clip=0.2 | sfgrey3 title='"input gather"'n frame1=220 frame2=40 frame3=40
#		''')
Flow ('taper1','taper','window f4=20 n4=1 f5=20 n5=1')

#Result ('taper1',
#		'''
#		put d1=0.001 o1=0.25 unit1=km label1=Depth |
#		byte bar=bar.rsf bias=0.5 | sfgrey3 allpos=y color=j title='"horizon-consistent filter"' scalebar=y
#		frame1=220 frame2=40 frame3=40
#		''')
Flow ('data-clean','dag3 taper','mul ${SOURCES[1]}')
#Result ('data-clean1','data-clean',
#		'''
#	    window f4=20 n4=1 f5=20 n5=1 | put d1=0.001 o1=0.25 unit1=km label1=Depth |
#		byte clip=0.05 | sfgrey3 title='"filtered gather"' frame1=220 frame2=40 frame3=40
#		''')

Flow ('image-clean','data-clean','stack | stack')

Result ('image3',
		'''
		put d1=0.001 o1=0.25 unit1=km label1=depth label2=inline label3=crossline
		d2=0.025 o2=1 unit2=km
		d3=0.025 o3=3 unit3=km |
		window max1=0.7 |
		sfbyte | 
		sfgrey3 wanttitle=n title='"init image"' frame1=50 frame2=40 frame3=20
		''')
Result ('image-clean',
		'''
		put d1=0.001 o1=0.25 unit1=km label1=depth label2=inline label3=crossline
		d2=0.025 o2=1 unit2=km
		d3=0.025 o3=3 unit3=km |
		window max1=0.7 |
		sfbyte clip=0.005 |
		sfgrey3 wanttitle=n title='"filtered image"' frame1=50 frame2=40 frame3=20
		''')

############

Flow ('image3s dag3s', 'gibson-stack gibson-velmodel',
	  '''
	  tmigda vel=${SOURCES[1]} dag=${TARGETS[1]}
	  is3d=y isDipAz=n hmign=1
	  iyo=3000 iyn=41 iyd=25
	  ixo=1000 ixn=81 ixd=25
	  dipn=21 dipo=-10 dipd=1
	  sdipn=21 sdipo=-10 sdipd=1
	  ''')
Result ('image3s',
		'''
		put d1=0.001 o1=0.25 unit1=km label1=depth label2=inline label3=crossline
		d2=0.025 o2=1 unit2=km
		d3=0.025 o3=3 unit3=km |
		window max1=0.7 |
		sfbyte clip=70 |
		sfgrey3 wanttitle=n title='"short image"' frame1=50 frame2=40 frame3=20
		''')
##############

Flow ('pimage-20-20','dag3','window min2=20 n2=1 min3=20 n3=1')
Result ('pimage-20-20',
		'''
		put d1=0.001 o1=0.25 unit1=km label1=depth label2=inline label3=crossline
		d2=0.025 o2=1 unit2=km
		d3=0.025 o3=3 unit3=km |
		sfbyte | 
		sfgrey3 wanttitle=n title='"init image"' frame1=50 frame2=40 frame3=20
		''')

Flow ('mask-20-20','taper','window min2=20 n2=1 min3=20 n3=1')
Result ('mask-20-20',
		'''
		put d1=0.001 o1=0.25 unit1=km label1=depth label2=inline label3=crossline
		d2=0.025 o2=1 unit2=km
		d3=0.025 o3=3 unit3=km |
		sfbyte | 
		sfgrey3 title='"init image"' frame1=50 frame2=40 frame3=20 
		wanttitle=n color=e maxval=1 minval=0
		''')



Flow ('pimage-20-20-clean','data-clean','window min2=20 n2=1 min3=20 n3=1')
Result ('pimage-20-20-clean',
		'''
		put d1=0.001 o1=0.25 unit1=km label1=depth label2=inline label3=crossline
		d2=0.025 o2=1 unit2=km
		d3=0.025 o3=3 unit3=km |
		sfbyte clip=0.01 | 
		sfgrey3 wanttitle=n title='"clean image"' frame1=50 frame2=40 frame3=20
		''')

End()
