from rsf.proj import *

# Make a reflector model 
Flow('refl',None,
     '''
     math n1=10001 o1=-4 d1=0.001 output="sqrt(1+x1*x1)" 
     ''')
Flow('model','refl',
     '''
     window min1=-3 max1=3 j1=5  |
     unif2 n1=401 d1=0.005 v00=1,2 |
     put label1=Depth unit1=km label2=Lateral unit2=km |
     smooth rect1=3
     ''')

Plot('model',
     '''
     grey allpos=y bias=1 title=Model 
     ''')

padv=50
padh=50
nt=1501
dt=0.004
n1=401
n2=1201


Flow('modelext','model','pad beg1=%d end1=%d beg2=%d end2=%d| math output=0.5'%(padv,padv,padh,padh))


# Compute approximate reflectivity
##################################
Flow('zref','model',
     '''
     depth2time velocity=$SOURCE nt=%d dt=%g |
     ai2refl | ricker1 frequency=10 |
     time2depth velocity=$SOURCE 
     '''%(nt, dt))

Plot('zref',
       '''
     	window min1=0 max1=2 |
       grey title=Reflectivity titlesz=7 labelsz=5
       ''')

Flow('left','zref','window n2=1 | spray n=%d' %padh)
Flow('right','zref','window n2=1 f2=%d | spray n=%d'%(n2-1,padh))
Flow('zrefext','left zref right','cat axis=2 ${SOURCES[1:3]}| pad beg1=%d end1=%d'%(padv,padv))
Result('zrefext','grey title="Extended reflectivity"')

Flow('data','zrefext modelext',
     '''
     rtm2d vel=${SOURCES[1]} 
	n0=%d nt=%d dt=%g adj=n
     '''%(padv,nt,dt))

Result('data',
     '''
     window min2=-2 max2=2 min1=1 max1=4 |
     grey title="Zero-Offset Data" grid=y 
     label1=Time unit1=s label2=Distance unit2=km
     ''')

# For dot-product test, input the following line in the command line:
# sfdottest sfrtm2d mod=zrefext.rsf dat=data.rsf vel=modelext.rsf n0=50 nt=1501 dt=0.004


# ================= reverse-time migration ==================
Flow('image-rtm','data modelext',
     '''
     rtm2d vel=${SOURCES[1]}
	n0=%d nt=%d dt=%g adj=y 
     '''%(padv,nt,dt))

Result('image-rtm',
     '''
     window min1=0 max1=2 |
     put label1=Depth unit1=km label2=Lateral unit2=km |
     grey title="RTM Image" 
     ''')

# sfdottest sfrtm2d mod=image-rtm.rsf dat=data.rsf vel=modelext.rsf n0=50 nt=1501 dt=0.004
# sfconjgrad sfrtm2d mod=zrefext.rsf < data.rsf vel=modelext.rsf n0=50 nt=1501 dt=0.004 niter=8 > invs.rsf


# ============== least-squares migration ====================
Flow('image-lsrtm','data modelext',
     '''
     lsrtm2d vel=${SOURCES[1]}
	n0=%d nt=%d dt=%g niter=8 verb=y
     '''%(padv,nt,dt))

Result('image-lsrtm',
     '''
     window min1=0 max1=2 |
     put label1=Depth unit1=km label2=Lateral unit2=km |
     grey title="LSRTM Image"
     ''')

#Result('comparison','zref image-rtm image-lsrtm','SideBySideAniso')



End()
