from rsf.proj import *

# Make a reflector model 
Flow('refl',None,
     '''
     math n1=10001 o1=-4 d1=0.001 output="sqrt(1+x1*x1)" 
     ''')
Flow('model','refl',
     '''
     window min1=-3 max1=3 j1=5  |
     unif2 n1=401 d1=0.005 v00=1,2 |
     put label1=Depth unit1=km label2=Lateral unit2=km |
     smooth rect1=3
     ''')

Plot('model',
     '''
     window min2=-1 max2=2 |
     grey allpos=y bias=1 title=Model 
     ''')
Plot('refl',
     '''
     graph wanttitle=n wantaxis=n yreverse=y
     min1=-1 max1=2 min2=0 max2=2 
     plotfat=3 plotcol=4 
     ''') 
Result('model','model refl','Overlay')

padv=50
nt=1501
dt=0.004

Flow('modelext','model','pad beg1=%d end1=%d | math output=0.5'%(padv,padv))


# Compute approximate reflectivity
##################################
Flow('zref','model',
     '''
     depth2time velocity=$SOURCE nt=%d dt=%g |
     ai2refl | ricker1 frequency=10 |
     time2depth velocity=$SOURCE 
     '''%(nt, dt))

Plot('zref',
       '''
     	window min2=-1 max2=2 min1=0 max1=2 |
       grey title=Reflectivity titlesz=7 labelsz=5
       ''')
Flow('zrefext','zref','pad beg1=%d end1=%d'%(padv, padv))


Flow('data','zrefext modelext',
     '''
     rtm2d vel=${SOURCES[1]} 
	n0=%d nt=%d dt=%g adj=n
     '''%(padv,nt,dt))

Result('data',
     '''
     window min2=-2 max2=2 min1=1 max1=4 |
     grey title="Zero-Offset Data" grid=y 
     label1=Time unit1=s label2=Distance unit2=km
     ''')

# For dot-product test, input the following line in the command line:
# sfdottest sfrtm2d mod=zrefext.rsf dat=data.rsf vel=modelext.rsf n0=50 nt=1501 dt=0.004


# ================= reverse-time migration ==================
Flow('image-rtm','data modelext',
     '''
     rtm2d vel=${SOURCES[1]}
	n0=%d nt=%d dt=%g adj=y 
     '''%(padv,nt,dt))

Plot('image-rtm',
     '''
     window min2=-1 max2=2 min1=0 max1=2 |
     put label1=Depth unit1=km label2=Lateral unit2=km |
     grey title="RTM Image" 
     ''')



# ============== least-squares migration ====================
Flow('image-lsrtm','data modelext',
     '''
     lsrtm2d vel=${SOURCES[1]}
	n0=%d nt=%d dt=%g niter=8 verb=y
     '''%(padv,nt,dt))

Plot('image-lsrtm',
     '''
     window min2=-1 max2=2 min1=0 max1=2 |
     put label1=Depth unit1=km label2=Lateral unit2=km |
     grey title="LSRTM Image"
     ''')

Result('comparison','zref image-rtm image-lsrtm','SideBySideAniso')



End()
