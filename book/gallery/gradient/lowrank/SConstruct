from rsf.proj import *

sys.path.append('..')
import gradient

gradient.zero_offset('zodata')

Result('zodata','grey title="Zero-Offset" ')

par = gradient.par

Flow('veloc','zodata',
     '''
     window n1=1 | spray axis=1 n=501 o=0 d=0.01 label=Depth unit=km | 
     math output="%(v0)g+%(gradx)g*x2+%(gradz)g*x1" | 
     put label=Velocity unit=km/s
     ''' % par)

Result('veloc','grey color=j allpos=y bias=%(v0)g title="Velocity Model" scalebar=y barreverse=y' % par)

# Lowrank decomposition
Flow('fft','veloc','transp | fft1 | fft3 axis=2 pad=1')
Flow('right left','veloc fft',
     'transp | scale dscale=0.5 | isolr2 seed=2012 dt=0.002 fft=${SOURCES[1]} left=${TARGETS[1]}')

# Zero-offset migration
Flow('zomig','zodata left right',
     '''
     reverse which=1 |
     transp |
     fftexp0 mig=y
     left=${SOURCES[1]} right=${SOURCES[2]}
     nz=501 dz=0.01
     ''')

Result('zomig','window min2=2.5 max2=7.5 | grey title="Zero-Offset Migration" unit2=km')

# Impulse response
Flow('impulse','zodata','spike k1=751 k2=176 | smooth rect1=2 rect2=2 repeat=2')

Flow('impres','impulse left right',
     '''
     reverse which=1 |
     transp |
     fftexp0 mig=y
     left=${SOURCES[1]} right=${SOURCES[2]}
     nz=501 dz=0.01
     ''')

Plot('impres','grey title="Impulse Response" unit2=km')

Plot('theory','veloc',
     '''
     scale dscale=0.5 | eikonal yshot=5 | 
     contour nc=1 c0=1.5 wantaxis=n wanttitle=n plotcol=3 plotfat=3
     ''')

Result('impres','impres theory','Overlay')

End()
