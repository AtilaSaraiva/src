from rsf.proj import *

sys.path.append('..')
import gradient

gradient.zero_offset('zodata')

Result('zodata','grey title="Zero-Offset" ')

par = gradient.par

Flow('veloc','zodata',
     '''
     window n1=1 | spray axis=1 n=501 o=0 d=0.01 label=Depth unit=km | 
     math output="%(v0)g+%(gradx)g*x2+%(gradz)g*x1" |
     put label=Velocity unit=km/s
     ''' % par)

Result('veloc','grey color=j allpos=y bias=%(v0)g title="Velocity Model" scalebar=y barreverse=y' % par)

# half-order derivative
Flow('hzodata','zodata',
     'halfint inv=y adj=y')

# traveltime table
nshot = 8

Flow('yshot',None,'math n1=%d o1=1.5 d1=%g output=x1' % (nshot,7./(nshot-1)))
Flow('szero','yshot','math output=0.')
Flow('shots','szero yshot','cat axis=2 ${SOURCES[1]} ${SOURCES[0]} | transp')

Flow('time tdl tds','veloc shots',
     '''
     put d3=0.02 o3=0. label3= unit3= |
     eikods shotfile=${SOURCES[1]} tdl1=${TARGETS[1]} tds1=${TARGETS[2]} |
     put o4=1.5 d4=%g | window
     ''' % (7./(nshot-1)))

Flow('times','time',
     '''
     transp plane=13 memsize=2048 |
     deriv |
     transp plane=13 memsize=2048 |
     scale dscale=%g
     ''' % ((nshot-1)/7.))

# post-stack migration (Hermite)
Flow('hzodmig','hzodata time tds',
     'kirmig0 table=${SOURCES[1]} deriv=${SOURCES[2]}')

Result('hzodmig',
       'window min2=2.5 max2=7.5 | grey title="Zero Offset Image (Hermite)" label2=Distance label1=Depth unit1=km')

# post-stack migration (linear)
Flow('lzodmig','hzodata time times',
     'kirmig0 type=linear table=${SOURCES[1]} deriv=${SOURCES[2]}')

Result('lzodmig',
       'window min2=2.5 max2=7.5 | grey title="Zero Offset Image (linear)" label2=Distance label1=Depth unit1=km')


# Impulse response
Flow('impulse','zodata','spike k1=751 k2=176 | smooth rect1=2 rect2=2 repeat=2 | halfint inv=y adj=y')

Flow('kimpres','impulse time tds',
     'kirmig0 table=${SOURCES[1]} deriv=${SOURCES[2]}')

Plot('kimpres','grey title="Impulse Response" unit2=km')

Plot('theory','veloc',
     '''
     scale dscale=0.5 | eikonal yshot=5 | 
     contour nc=1 c0=1.5 wantaxis=n wanttitle=n plotcol=3 plotfat=3
     ''')

Result('kimpres','kimpres theory','Overlay')


# Least-squares migration
Flow('lszodmig','hzodata time tds veloc',
     '''
     conjgrad kirmig0 table=${SOURCES[1]} deriv=${SOURCES[2]} mod=${SOURCES[3]} niter=25
     nt=2001 dt=0.002 ns=351 ds=0.02 s0=1.5
     ''')

Result('lszodmig',
       'window min2=2.5 max2=7.5 | grey title="Zero Offset Image (LS)" label2=Distance label1=Depth unit1=km')


End()
