from rsf.proj import *

sys.path.append('..')
import gradient

# Zero-Offset

gradient.zero_offset('zodata')

Result('zodata','grey title="Zero-Offset" ')

par = gradient.par

import math
par['grad'] = math.hypot(par['gradx'],par['gradz'])

Flow('veloc','zodata',
     '''
     window n1=1 | spray axis=1 n=501 o=0 d=0.01 label=Depth unit=km | 
     math output="%(v0)g+%(gradx)g*x2+%(gradz)g*x1" | 
     put label=Velocity unit=km/s
     ''' % par)

Result('veloc','grey color=j allpos=y bias=%(v0)g title="Velocity Model" scalebar=y barreverse=y' % par)

Flow('veltop','veloc','window n1=1 squeeze=n')

Flow('velmig','zodata veltop',
     '''
     window f1=1 |
     math output="(%(v0)g+%(gradx)g*x2)/sqrt(0.5*x1*(%(grad)g*(exp(x1*%(grad)g)+1)/(exp(x1*%(grad)g)-1)-%(gradz)g))" |
     cat ${SOURCES[1]} axis=1 order=2,1 |
     put label=Velocity unit=km/s
     ''' % par)

Result('velmig',
       'grey color=j allpos=y bias=%(v0)g title="Time Migration Velocity" scalebar=y barreverse=y' % par)

nx = 351
x0 = 1.5

Flow('fft','zodata','cosft sign2=1')

Flow('vc','fft','stolt vel=%(v0)g | spray axis=2 n=1 o=0 | fourvc v0=%(v0)g dv=0.01 nv=451' % par,
     split=[2,nx],reduce='cat axis=3')

Flow('mig','vc velmig','cosft sign3=-1 o3=%g | slice pick=${SOURCES[1]}' % x0)

Result('mig','grey title="Zero-Offset Time Migration" ')


# Prestack

gradient.cmps('data')

Flow('coff','data','put d2=0.02 | transp memsize=1000 plane=23')

End()
