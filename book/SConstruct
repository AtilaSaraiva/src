import os, string
import rsf.sftour
import rsf.doc
import rsf.prog

books = '''
bei
gee
'''

reports = '''
cwp
data
geo384w
geo391
jsg
rsf
sep
slim
'''

all =  ARGUMENTS.get('all', 'n')
size = int(ARGUMENTS.get('size', 1024**2))

def publicproj(project):
    '''Check if the project is publicly accessible'''
    global all, size
    os.chdir(project)
    # Skip if no .rsfproj
    if not os.path.isfile('.rsfproj'):
        return False
    # OK if all=y on the command line
    if all == 'y':
        return True
    # OK if no PRIVATE data
    g = {}
    l = {}
    execfile('.rsfproj',g,l)
    if 'PRIVATE' in l['data'] or 'LOCAL' in l['data']:
        return False
    if not 'size' in l:
        return False
    if size > 0 and l['size'] > 0 and l['size'] > size:
        return False
    return True

def progtest(target=None,source=None,env=None):
    cwd = os.getcwd()
    for project in env.get('projects'):
        if publicproj(project):
            print 'Testing in %s' % project
            print '-----------' + '-'*len(project)
            if os.system('scons test'):
                return 1
        os.chdir(cwd)            
    return 0

def www(target=None,source=None,env=None):
    sftour.tour(map(str,source),'scons -Q book.tex www')
    return 0

env = Environment()
env.Command('www',Split(reports),Action(www))

for prog in rsf.doc.progs.keys():
    uses = rsf.doc.progs[prog].uses
    projects = []
    for book in uses.keys():
        for chapter in uses[book].keys():
            projects.extend(map(lambda x: os.path.join(book,chapter,x),
                                uses[book][chapter]))
    env.Command(prog+'.test',None,
                Action(progtest,varlist=['projects']),projects=projects)
    env.Alias('test',prog+'.test')
