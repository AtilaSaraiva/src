from rsfproj import *
import zomig

#################################################################
#
# Get data
#
#################################################################

Fetch('cmps-tp.HH','blake')

Flow('noff','cmps-tp.HH',
     '''
     window f2=47 |
     dd form=native |
     window n2=1024 |
     pad beg1=1000 |
     put label1=t label2=x o3=0 d3=1 label3=
     ''')

Flow('cmp','cmps-tp.HH',
     '''
     window f3=950 n3=1 max1=6 |
     dd form=native |
     reverse which=2 |
     put o2=0.0 d2=1
     ''')

Result('noff',
       '''
       window f1=1000 |
       grey title="Near Offset Section" wheretitle=t pclip=95
       label1="Time (s)" label2="Distance (km)" wherexlabel=b
       ''')

par = {
    'nx':1024,'ox':0,'dx':0.05,
    'nt':1625,'ot':0,'dt':0.004,'kt':1,'ft':0,
    'nz':1200,'oz':0,'dz':0.002,
    #
    'nw':180, 'ow':4, 'jw':1,
    #
    'verb':'y','eps':0.01,'nrmax':5,'dtmax':0.00005,
    'tmx':16,'pmx':0,
    }

par['dw']=par['jw']/((par['nt'])*par['dt'])

## 
 # slowness
 ##
Flow('sss',None,
     '''
     spike nsp=1 mag=1.5
     n1=%(nz)d o1=%(oz)g d1=%(dz)g
     n2=%(nx)d o2=%(ox)g d2=%(dx)g |
     math "output=1/input" |
     put label1=z label2=x label3=y |
     transp plane=12 |
     transp plane=23 |
     put o2=0.0 d2=1 
     ''' % par )
Flow('sdt','sss','window squeeze=n n3=2 j3=400' % par )
Flow('slo','sss','window squeeze=n      f3=400' % par )

## 
 # data
 ##
zomig.wflds ('dat','noff',par)       # surface data
zomig.Adttwo('dtm','dat','sdt',par)  # datumed data

## 
 # migration
 ##

# migration from the surface
zomig.image('iii','sss','dat',par)
Result('iii','window | transp | grey ')

for k in range(-2,3,1):
    s = 'slo' + str(k)  # slowness
    i = 'img' + str(k)  # image

    f = 1 + 0.1*k
    Flow(s,'slo','math "output=input*%g"' % f)

    # migration from the datum
    zomig.image(i,s,'dtm',par)
    Result(i,'window | transp | grey ')

# ------------------------------------------------------------

# ------------------------------------------------------------




End()
