from rsfproj import *
import velcon, stack

Fetch('cmps-tp.HH','blake')
Flow('blake0','cmps-tp.HH',
     'dd form=native | reverse which=2')

Flow('off1',None,'math n1=24 o1=0.4 d1=0.1  output=x1')
Flow('off2',None,'math n1=24 o1=2.8 d1=0.05 output=x1')
Flow('off','off1 off2',
     'cat axis=1 ${SOURCES[1]} | spray axis=2 n=1105 d=0.05 o=0')

Flow('far',None,'spike n1=24')
Flow('zero',None,'spike n1=24 mag=0')
Flow('mask','far zero',
     '''
     interleave axis=1 ${SOURCES[1]} |
     cat axis=1 ${SOURCES[0]} |
     put o1=0.4 d1=0.05 | spray axis=1 n=625 d=0.004 o=4
     ''')

Flow('scan','blake0 off',
     'vscan semblance=y v0=1.4 nv=40 dv=0.01 half=n offset=${SOURCES[1]}')

Flow('vel','scan','pick rect1=40 rect2=40 | window')

def grey(title):
    return '''
    grey title="%s" 
    label1="Time (s)" label2="Lateral (km)"
    ''' % title

def velgrey(title):
    return grey(title) + '''
    color=j scalebar=y bias=1.6
    '''

Result('vel',velgrey('Stacking Velocity'))

Flow('nmo','blake0 vel off',
     'nmo velocity=${SOURCES[1]} half=n offset=${SOURCES[2]}')

Flow('stk','nmo','stack')

Result('stk',grey('NMO Stack'))

Flow('stk2','nmo',
     '''
     logstretch | fft1 |
     transp plane=13 memsize=500 | finstack | transp |
     fft1 inv=y | logstretch inv=y
     ''')

Result('stk2',grey('DMO Stack'))

#velcon.velcon('bei',
#              nv=48,      # continuation steps
#              v0=1.3,     # initial velocity
#              dv=0.025,   # velocity step
#              nx=250,     # lateral dimension
#              padt=1024,  # time padding
#              padt2=2048, # extra time padding
#              padx=521,   # lateral padding
#              v1=1.8,     # other velocity
#              rect1=15,   # vertical smoothing
#              rect2=30)   # lateral  smoothing

End()
       
