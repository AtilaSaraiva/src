from rsfproj import *
import stack

shots = 'shots.hh'

Fetch('shots.hh','frst3')

Flow('shots',shots,'dd form=native')

Flow('midpt',None,
     'math n1=1 n2=440 d2=2 o2=0 n3=440 d3=2 o3=0 output="(x2+x3)/2" ')
Flow('offset','midpt','math output="(x2-x3)/2" ')
Flow('head','offset midpt',
     'cat axis=1 ${SOURCES[1]} | dd type=int | put n3=1 n2=193600')
Flow('cmps','shots head',
     '''
     put n3=1 n2=193600 |
     intbin head=${SOURCES[1]} xkey=0 ykey=1 xmin=-200 xmax=200
     ''')

Flow('cmp1','cmps','window j3=2 j2=2           | put d2=15 o2=-1500 d3=7.5')
Flow('cmp2','cmps','window j3=2 j2=2 f3=1 f2=1 | put d2=15 o2=-1500 d3=7.5')
Flow('cmp','cmp1 cmp2',
     'window n2=200 n3=439 | interleave ${SOURCES[1]}')
Flow('mut','cmp','mutter v0=2200')

Result('cmut','mut','window n3=1 f3=200 | grey title="CMP gather" ')

Flow('chan','cmp','window min3=1500 max3=5500')

stack.stack('chan',
            v0=1800,
            nv=100,
            dv=10,
            nx=534,
            nt=241,
            padx=1025,
            tmin=0.2,
            tmax=0.5,
            rect1=10,
            rect2=10,
            f1=40,
            nout=256)

Flow('vscan','mut','vscan semblance=y v0=1500 dv=20 nv=100')

Result('cvscan','vscan',
       '''
       window n3=1 f3=200 max1=0.5 max2=3000 | 
       grey color=j allpos=y title="Semblance Scan" 
       ''')

Flow('vpick','vscan','pick rect1=10 rect2=10')

Result('cvpick','vpick',
       '''
       window max1=0.5 min3=500 max3=5500 | 
       grey color=j allpos=y bias=2000 title="Stacking Velocity"
       scalebar=y
       ''')

Flow('nmo','mut vpick','nmo velocity=${SOURCES[1]}')

Result('cnmo','nmo','window n3=1 f3=200 | grey title="NMO" ')

Flow('stack','nmo','window max1=0.5 | stack')

Flow('avo','nmo','window max1=0.5 | avo')
Plot('a','avo','window n2=1 | grey title="AVO Intercept" ')
Plot('b','avo','window f2=1 | grey title="AVO Slope" ')
Result('cab','a b','OverUnderAniso')

Result('cstack','stack','window max2=5500 min1=0.2 | grey title="NMO Stack" ')

Flow('strd','nmo','window f1=40 | logstretch nout=256')
Flow('fftd','strd','fft1 | transp plane=13 memsize=500')
Flow('stck','fftd','finstack')

Flow('top','stack','window n1=40')
Flow('bot','stck',
     'transp | fft1 inv=y | window n1=256 | logstretch inv=y | window max1=0.5')
Flow('stkd','top bot','cat axis=1 ${SOURCES[1]}')

Result('cstkd','stkd','window max2=5500 min1=0.2 | grey title="DMO Stack" ')

Flow('vlf0','stkd',
     '''
     pad n2=1025 | cosft sign2=1 | spray axis=2 n=1 o=0 d=15 |
     stolt vel=1500 nf=4 |
     fourvc nv=200 dv=5 v0=1500 |
     cosft sign3=-1 |
     window n3=878
     ''')

Flow('vpick0','vpick','window n1=201')
Flow('mig0','vlf0 vpick0','slice pick=${SOURCES[1]} | window')

Result('cmig0','mig0',
       '''
       window max2=5500 min1=0.2 | grey title="Poststack Migration" color=G
       ''')

Flow('tst','cmp','transp plane=24 memsize=500')
Flow('mig','tst','preconstkirch vel=1500')
Flow('cip','mig','transp plane=24 memsize=500 | halfint inv=1 adj=1')
Flow('ckx','cip','cosft sign3=1')
Flow('vlf','ckx',
     'fourvc nv=100 dv=20 v0=1500 pad=512 pad2=1024 | cosft sign3=-1')
Flow('vlf2','cip',
     '''
     transp plane=23 memsize=500 | 
     fourvc2 nv=100 dv=20 v0=1500 pad=512 pad2=1024 | 
     transp plane=23 memsize=500
     ''')

Flow('pik','vlf2','window max1=0.6 | pick rect1=10 rect2=20 | window')
Result('pik',
       'grey color=j scalebar=y title="Migration Velocity" bias=2000')

Flow('slc','vlf pik','window max1=0.6 | slice pick=${SOURCES[1]} | window')
Result('slc',
       'grey title="Prestack Time Migration" ')

Result('slc0','slc',
       '''
       window max2=5500 min1=0.2 max1=0.5 |
       grey title="Prestack Time Migration" color=G
       ''')

Fetch('vp.hh','frst3')
Flow('vp','vp.hh','dd form=native | window n3=1 f3=140')
Flow('vint','vp','depth2time velocity=$SOURCE nt=500 dt=0.0025 t0=0')
Flow('vrms','vint',
     '''
     add mode=p $SOURCE | causint |
     math output="sqrt(input*0.0025/(x1+0.0025))"
     ''')

Flow('zof','cmp1','window n2=1 min2=0')
Flow('fft1','zof','window f1=40 | logstretch nout=512 | fft1 | transp')
Flow('fin','fft1','fincon h0=0 dh=15 nh=100 all=y')
Flow('off','fin','transp plane=13 | fft1 inv=y | logstretch inv=y')
Flow('off2','off',
     'window f2=1 | reverse which=2 | cat axis=2 $SOURCE | reverse which=2')

Flow('vpick2','vpick','window j3=2')

Flow('mod','off2 vpick2',
     '''
     window n3=439 | pad beg1=40 n1=500 |
     inmo velocity=${SOURCES[1]} | mutter v0=2200
     ''')

Flow('shot',None,
     'math n1=1 n2=201 d2=2 o2=-200 n3=439 d3=1 o3=0 output="x3-x2" ')
Flow('recv','shot','math output="x3+x2" ')
Flow('head2','recv shot',
     'cat axis=1 ${SOURCES[1]} | dd type=int | put n3=1 n2=88239')
Flow('shots2','mod head2',
     '''
     put n3=1 n2=88239 |
     intbin head=${SOURCES[1]} xkey=0 ykey=1 |
     put d2=7.5 d3=7.5 o2=-1500 o3=-1500
     ''')

End()
