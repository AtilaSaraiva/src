from rsfproj import *

stack = 'diffr.CMPstack.su'

private = {'login':os.environ.get('BEG_LOGIN'),
           'password':os.environ.get('BEG_PASSWORD'),
           'server':os.environ.get('BEG_SERVER')}

Fetch(stack,'cassis',private)
Flow('stack tstack',stack,
     '''
     segyread tape=$SOURCE tfile=${TARGETS[1]} su=y endian=0 |
     put label1=Time unit1=s label2=Midpoint unit2=km
     o2=5 d2=0.0125
     ''',stdin=0)

Result('stack','window max1=3 | grey title="Diffractions" ')

Flow('vlf','stack',
     '''
     pad n2=1024 | cosft sign2=1 | 
     stolt vel=1.4 nf=4 | spray axis=2 n=1 o=0 d=1 |
     fourvc nv=200 dv=0.01 v0=1.4 verb=y |
     cosft sign3=-1 | window n3=981
     ''')

Flow('pat','vlf','patch verb=y w=1251,100,200')

Flow('foc','pat',
     '''
     focus dim=3 rect1=100 rect3=20 |
     math output="1/abs(input)" 
     ''')

Flow('bak','foc','patch verb=y inv=y weight=y')
Flow('vel','bak','window max1=3 | pick rect1=20 rect2=20 gate=6 | clip2 lower=1.4')
Flow('vel2','bak','window max1=3 | pick2 smooth=n')

cigs=[]
for cmp in (10,12,14):
    cig = 'cig%d' % cmp
    vel = 'vel%d' % cmp
    foc = 'foc%d' % cmp
    
    Flow(cig,'bak','window n3=1 min3=%d max1=3' % (cmp-5))
    Plot(cig,'grey allpos=y color=j title="Focusing Panel at %d km" ' % cmp)

    Flow(vel,cig,'pick rect1=20 gate=6 | window')
    Plot(vel,
         '''
         graph transp=y yreverse=y min2=1.4 max2=3.39
         plotcol=7 plotfat=20 pad=n wanttitle=n wantaxis=n
         ''')

    Plot(foc,[cig,vel],'Overlay')
    
    cigs.append(foc)
Result('foc',cigs,'SideBySideAniso')

Result('vel',
       '''
       window | put o2=5 |
       grey color=j allpos=y bias=1.4 scalebar=y barreverse=y
       title="Focusing Velocity" 
       ''')

Flow('slc','vlf vel',
     'window max1=3 | slice pick=${SOURCES[1]} | put o3=5')

Result('slc','window | grey title="Migrated Diffractions" ')

End()
