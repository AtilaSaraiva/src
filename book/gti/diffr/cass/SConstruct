from rsfproj import *

private = {'login':os.environ.get('BEG_LOGIN'),
           'password':os.environ.get('BEG_PASSWORD'),
           'server':os.environ.get('BEG_SERVER')}

vel = 'velcassis240x240prep.segy'
dat = 'datacassis240x240prep.segy'

for file in ('vel','data'):
    segy = file+'cassis240x240prep.segy'
    Fetch(segy,'cassis',private)

    Flow([file,'t'+file,'./h'+file,'./b'+file],segy,
         '''
         segyread tape=$SOURCE
         tfile=${TARGETS[1]} hfile=${TARGETS[2]} bfile=${TARGETS[3]}
         ''',stdin=0)

Result('vel',
       '''
       put d2=0.0125 |
       grey color=j allpos=y bias=1450 scalebar=y
       title="Velocity Model" barreverse=y
       label2="Lateral (km)" label1="Depth (km)"
       ''')

Flow('dat','data',
     '''
     intbin xk=tracf yk=fldr |
     put o3=5 d3=0.025 o2=0 d2=0.0125
     ''')

Flow('czo','dat','window n2=1 max1=3.5')

Result('czo',
       'grey title="Zero Offset" label2="Lateral (km)" label1="Time (s)" ')

Flow('cd0','czo','dip rect1=40 rect2=10')

Result('cd0',
       '''
       grey color=j scalebar=y
       title="Zero Offset Slope" 
       label2="Lateral (km)" label1="Time (s)"
       ''')

Flow('cdi0','czo cd0','pwd dip=${SOURCES[1]}')

Result('cdi0',
       'grey title="Diffractions" label2="Lateral (km)" label1="Time (s)" ')

Flow('csi0','czo cd0',
     '''
     pwdsmooth2 dip=${SOURCES[1]} rect1=1 rect2=2 |
     add ${SOURCES[0]} scale=-1,1
     ''')

Result('csi0',
       '''
       grey title="Diffractions (Shaping)"
       label2="Lateral (km)" label1="Time (s)"
       ''')

Flow('shot','dat','window n3=1 f3=210')

Plot('shot',
     '''
     window max1=4 |
     grey title="Original Shot Gather"
     label2="Half-Offset (km)" label1="Time (s)"
     ''')

Flow('cmp','dat',
     '''
     math output=0 |
     interleave $SOURCE axis=3 |
     put d3=0.0125 o3=4.9875 |
     shot2cmp
     ''')

Flow('dat2','cmp',
     '''
     reverse which=2 opt=n memsize=500 |
     window n2=140 |
     cat axis=2 $SOURCE |
     cmp2shot |
     window n3=421 min3=5 j3=2 
     ''')

#Flow('shot2','dat2','window n3=1 f3=210')

Plot('shot2',
     '''
     window max1=4 |
     grey title="Extended Shot Gather"
     label2="Half-Offset (km)" label1="Time (s)"
     ''')

Result('shot','shot shot2','SideBySideAniso')

Flow('rad2','shot2','radon adj=y inv=y spk=n p0=-1.5 np=501 dp=0.006')

Plot('rad2',
     '''
     window max1=4 |
     grey label2="Slope (s/km)" title="Radon Transform"
     label1="Time (s)"
     ''')

Flow('rad','rad2','radon adj=n nx=281 dx=0.0125 ox=-1.75')

Plot('rad',
     '''
     window max1=4 |
     grey title="Shot Reconstruction"
     label2="Half-Offset (km)" label1="Time (s)"
     ''')

Result('rad','rad2 rad','SideBySideAniso')

#Flow('radon','dat2','radon adj=y inv=y spk=n p0=-1.5 np=501 dp=0.006')

for p in (-1,0,1):
    plane = 'plane%d' % p

    pg = 0.5*p
    Flow(plane,'radon','window n2=1 min2=%g' % pg)
    Plot(plane,
         '''
         window max1=3.5 |
         grey title="Plane-Wave Section (p=%g)"
         label2="Source (km)" label1="Time (s)"
         ''' % pg)

    slp = 'slp%d' % p
    Flow(slp,plane,'dip rect1=20 rect2=10 liter=40')

    pwd = 'pwd%d' % p
    Flow(pwd,[plane,slp],'pwd dip=${SOURCES[1]}')
    Plot(pwd,
         '''
         window max1=3.5 |
         grey title="Diffractions (p=%g)"
         label2="Source (km)" label1="Time (s)"
         ''' % pg)

    Result(plane,[plane,pwd],'SideBySideAniso')

Flow('patch','radon','transp memsize=500 plane=23 | patch w=1251,501,50')
Flow('dip','patch','dip rect1=20 rect2=10 rect3=2 liter=40 n4=0 verb=y')
#Flow('dips','dip','patch inv=y weight=y')

Flow('pwd','radon dips',
     '''
     transp memsize=500 plane=23 |
     pwd dip=${SOURCES[1]} n4=0 |
     transp memsize=500 plane=23
     '''
     )

Flow('sbak','pwd','radon adj=n nx=281 dx=0.0125 ox=-1.75')

Flow('sbak2','sbak','window n3=1 f3=210')

Plot('sbak2',
     '''
     window max1=4 |
     grey title="Extracted Diffractions"
     label2="Half-Offset (km)" label1="Time (s)"
     ''')

Result('sbak','shot2 sbak2','SideBySideAniso')

Flow('tback','tdata','intbin xk=tracf yk=fldr head=$SOURCE')

Flow('diffr.segy','sbak tback ./hdata ./bdata',
     '''
     window n2=141 min2=0 |
     segywrite tape=$TARGET
     tfile=${SOURCES[1]} hfile=${SOURCES[2]} bfile=${SOURCES[3]}
     ''',stdout=-1)

End()
