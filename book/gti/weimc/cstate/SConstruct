from rsfproj import *

Flow('mod',None,
     '''
     math n1=1001 n2=5 o2=1 d2=1 o1=0 d1=0.02
     output=x2
     ''')
Flow('mod2','mod',
     'transp | pad beg1=1 | remap1 n1=121 d1=0.05 | math output="1.5+0.3*x1" ')
Plot('mod2',
     '''
     grey color=j allpos=y title=Model scalebar=y
     barlabel=Velocity barunit=km/s min1=0 max1=6
     label1=Depth unit1=km label2=Lateral unit2=km
     barreverse=y pclip=100 
     ''')

Plot('mod1','mod',
     '''
     graph yreverse=y pad=n min2=0 max2=6 
     plotcol=0 plotfat=20 wantaxis=n wanttitle=n scalebar=y
     ''')
Plot('mod0','mod',
     '''
     graph yreverse=y pad=n min2=0 max2=6 
     plotcol=7 plotfat=5 wantaxis=n wanttitle=n scalebar=y
     ''')
Result('mod','mod2 mod1 mod0','Overlay')

Flow('dat','mod',
     '''
     kirmod nt=2001 dt=0.004 freq=10
     ns=1 s0=10 ds=0.5
     nh=401 h0=-10 dh=0.05
     vel=1.5 gradz=0.3 type=v
     ''')
Flow('dat2','dat',
     '''
     tpow tpow=1 |
     put label1=Time unit1=s label2=Offset unit2=km
     ''')

Result('dat','dat2','grey title=Data')

Flow('dat3','mod',
     '''
     kirmod nt=2001 dt=0.004 freq=10
     ns=2 s0=8 ds=4
     nh=401 h0=-10 dh=0.05
     vel=1.5 gradz=0.3 type=v
     ''')

Flow('wav',None,'spike n1=2001 d1=0.004 k1=1 | fft1 | window max1=30')

Flow('slo','mod2','transp | spray axis=2 n=1 d=0.02 | math output=1/input')

Flow('rwfl swfl','dat2 wav',
     '''
     fft1 | window max1=30 |
     spray axis=3 n=1 o=0 d=1 |
     spray axis=5 n=1 o=0 d=1 |
     srsyn nx=1001 dx=0.02 ox=0 wav=${SOURCES[1]} swf=swf.rsf |
     transp plane=12 | transp plane=23 > ${TARGETS[0]} &&
     transp plane=12 < swf.rsf | transp plane=23 > ${TARGETS[1]} &&
     rm swf.rsf
     ''',stdout=-1)

Flow('rwfl3 swfl3','dat3 wav',
     '''
     fft1 | window max1=30 |
     spray axis=3 n=1 o=0 d=1 |
     spray axis=5 n=1 o=0 d=1 |
     srsyn nx=1001 dx=0.02 ox=0 wav=${SOURCES[1]} swf=swf.rsf |
     transp plane=12 | transp plane=23 > ${TARGETS[0]} &&
     transp plane=12 < swf.rsf | transp plane=23 > ${TARGETS[1]} &&
     rm swf.rsf
     ''',stdout=-1)

Flow('rwfl2','rwfl3','stack axis=4 norm=n')
Flow('swfl2','swfl3','stack axis=4 norm=n')

# Migrate and create common-image gathers

Flow('dimage dcigs','swfl rwfl slo',
     '''
     srmig2 slo=${SOURCES[2]} rwf=${SOURCES[1]} cig=${TARGETS[1]}
     itype=o dec=1 deceps=0.1 readwrite=y verb=y 
     ''')

Result('dimage',
       '''
       window | transp |
       grey label1=Depth unit1=km label2=Lateral unit2=km title=Division
       ''')

Flow('dimage2 dcigs2','swfl rwfl slo',
     '''
     srmig2 slo=${SOURCES[2]} rwf=${SOURCES[1]} cig=${TARGETS[1]}
     itype=o dec=3 deceps=0.01 readwrite=y verb=y 
     ''')

Result('dimage2',
       '''
       window | transp |
       grey label1=Depth unit1=km label2=Lateral unit2=km
       title="Rough Division"
       ''')

Flow('image cigs','swfl rwfl slo',
     '''
     srmig2 slo=${SOURCES[2]} rwf=${SOURCES[1]} cig=${TARGETS[1]}
     itype=x nhx=100 nhz=1 hsym=y jcx=1 readwrite=y verb=y 
     ''')

Result('image',
       '''
       window | transp |
       grey label1=Depth unit1=km label2=Lateral unit2=km title=Image
       ''')

Flow('trace','image','window n1=1 min1=8')
Flow('dtrace','dimage','window n1=1 min1=8')
Flow('dtrace2','dimage2','window n1=1 min1=8')

Result('trace','trace dtrace dtrace2',
       '''
       cat axis=2 ${SOURCES[1:3]} |
       dots labels="Correlation:Division:Rough Division" yreverse=y
       label1=Depth unit1=km
       ''')

# Migrate and create common-image gathers

Flow('image2 cigs2','swfl2 rwfl2 slo',
     '''
     srmig2 slo=${SOURCES[2]} rwf=${SOURCES[1]} cig=${TARGETS[1]}
     itype=x nhx=100 nhz=1 hsym=y jcx=1 readwrite=y verb=y 
     ''')

#Result('image2',
#       '''
#       window | transp |
#       grey label1=Depth unit1=km label2=Lateral unit2=km title=Image
#       ''')

rect=(0.05,0.1)

Flow('zero',None,
     '''
     spike mag=0
     n1=121 d1=0.05 o1=0
     n2=200 d2=0.02 o2=-2 n3=1
     n4=1001 d4=0.02 o4=0
     ''')

for case in range(2):
    radius = rect[case]
    for exper in ('',): # '2'):
        image = 'image%d%s' % (case,exper)
        clean = 'clean%d%s' % (case,exper)
        Flow(clean,['cigs'+exper,'zero'],
             '''
             window | transp | transp plane=23 |
             pwdsigk dips=${SOURCES[1]} eps=10
             ''')
        Flow(image,clean,
             '''
             math output="input*exp(-2*x2*x2/%g)" |
             stack axis=2 norm=n |
             window |
             halfint inv=y
             ''' % (radius*radius))
        Result(image,
               '''
               grey label1=Depth unit1=km label2=Lateral unit2=km
               title="Snell Filtering (radius=%g km)"
               ''' % radius)

End()
