from rsfproj import *
from math import *
import string, spmig

# ------------------------------------------------------------
par = {
    'nx':400, 'dx':20,    'ox':0,
    'nz':400, 'dz':5,     'oz':0,
    'nt':4000,'dt':0.004, 'ot':0,
    'nh':400, 'dh':20,    'oh':-1000,
    'ns':1,   'ds':20,    'os':1000, 'fs':0, 'js':1,
    'nw':400, 'jw':1,
    'velp':2000,
    'nhx':40, 'nhz':1,
    'nht':80, 'oht':-0.2, 'dht':0.005,
    'oa':-0.5, 'na':200, 'da':0.01
    }
par['ow']=0.
par['dw']=1./(par['nt']*par['dt'])
# ------------------------------------------------------------
def igrey(custom):
    return '''
    grey labelrot=n title="" pclip=100 grid=n gridcol=5
    %s
    ''' % custom
def igraph(custom):
    return '''
    graph labelrot=n title="" transp=y yreverse=y
    wantaxis=n wantlabels=n
    min2=-0.5 max2=1.5 min1=0 max1=2000
    %s
    ''' % custom

# ------------------------------------------------------------

deg  = (0,15,30,45)
ndeg = len(deg)

# ------------------------------------------------------------
ppan = string.join(map(lambda a: str(
    tan(a*pi/180)
    ),deg),',')
# ------------------------------------------------------------

Flow('dip',None,
     'spike n1=%d d1=%g o1=%g n2=%d nsp=%d k2=%s mag=%s' % 
     (par['nx'],
      par['dx'],
      par['ox'],
      ndeg,
      ndeg,
      string.join(map(str,range(1,1+ndeg)),','),
      string.join(map(lambda a: str(tan(a*pi/180)),deg),',')
      )
     )
Flow('ref','dip','math output="300+input*x1" ')
Plot('ref',
     '''
     graph yreverse=y min2=0 max2=2000 min1=0 max1=2800
     title="" wantaxis=n
     ''')

# wavelet
Flow('wav',None,
     '''
     spike nsp=1 mag=1 k1=1
     n1=%(nt)d d1=%(dt)g o1=0
     ''' % par)

# velocity/slowness
Flow('vel',None,
     '''
     spike nsp=1 mag=1
     n1=%(nz)d d1=%(dz)g o1=%(oz)g
     n2=%(nx)d d2=%(dx)g o2=%(ox)g |
     transp |
     spray axis=2 n=1 o=0 d=1 |
     put label1=x label2=y label3=z
     ''' % par)
Flow('slop','vel','math output=input/%(velp)d' % par)

# dip angle
Flow('dipa',None,
     '''
     spike nsp=4 mag=%s
     n1=%d o1=%g d1=%g
     k1=0,76,141,221 l1=75,140,220,400
     ''' % (ppan,par['nz'],par['oz'],par['dz']))

# PP reflection angles
Flow('ovl',None,
     '''
     spike nsp=4 mag=%s n1=4 k1=1,2,3,4 |
     spray axis=2 n=%d o=%g d=%g |
     transp
     ''' % (ppan,par['nz'],par['oz'],par['dz']))
Plot('ovl','ovl',igraph(''))

# ------------------------------------------------------------

Flow('data','ref dip',
     '''
     kirmod vel=%d vel2=%d dip=${SOURCES[1]}
     nt=%d dt=%g t0=%g     freq=10
     nh=%d dh=%g h0=%g
     ns=%d ds=%g s0=%g |
     tpow tpow=1 |
     window f2=50 | pad beg2=50 |
     put label1=t label2=h
     ''' %
     ( par['velp'],
       par['velp'],
       par['nt'],par['dt'],par['ot'],
       par['nh'],par['dh'],par['oh'],
       par['ns'],par['ds'],par['os'])
     )
Result('data','window max1=8 | grey label1="t(s)" label2="h(m)" title=""')

# migration
spmig.wflds('sou','rec','wav','data',par)
#    Result(rec,rec,'window | real |' + igrey(''))

for TYP in ('x','t'): # imaging condition
    
    # imaging condition parameters
    if(TYP=='x'):
        par['misc']='itype=x nhx=%(nhx)d nhz=1             hsym=y jcx=50' % par
    else:
        par['misc']='itype=t nht=%(nht)d  oht=%(oht)g dht=%(dht)g jcx=50' % par
        
    # migration
    img = 'img' + '-'+TYP
    cig = 'cig' + '-'+TYP
    spmig.imagePW(img,cig,'slop', 'sou','rec',par)
    Plot(img,'window max1=2800 | transp |'
         + igrey('label1="z(m)" label2="x(m)" '))
    Result(img,[img,'ref'],'Overlay')

    off = 'off' + '-'+TYP     # offset CIGs
    ang = 'ang' + '-'+TYP     # angle  CIGs
    
    Flow(off,cig,
         '''
         window squeeze=n n1=1 min1=%(os)g |
         stack |
         transp |
         stack
         ''' % par)
    
    if(TYP=='x'):
        Result(off,off,igrey('label1="z(m)" label2="h(m)" '))

        Flow(ang,off,
             '''
             slant adj=y p0=%(oa)g  np=%(na)d  dp=%(da)g |
             put label2=tan
             ''' % par)

        Plot(ang,igrey('label1="z(m)" label2="tan" '))
        Result(ang,[ang,'ovl'],'Overlay')
    else:
        Result(off,off,igrey('label1="z(m)" label2="t(s)" '))

        vel = 'vel' + '-'+TYP
        Flow(vel,'vel','window n1=1 min1=%(os)g | scale rscale=%(velp)g' % par )

        sls = 'sls' + '-'+TYP
        Flow(sls,off,
             '''
             slant adj=y p0=0 np=200 dp=20
             ''' % par)
        Result(sls,'grey pclip=99')

        Flow(ang,[sls,vel],
             '''
             tshift      a0=%(oa)g  na=%(na)d  da=%(da)g velocity=${SOURCES[1]}
             ''' % par)
        
        Plot(ang,igrey('label1="z(m)" label2="tan" '))
        Result(ang,[ang,'ovl'],'Overlay')

# ------------------------------------------------------------

End()
