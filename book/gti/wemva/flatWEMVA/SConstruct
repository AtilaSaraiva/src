from rsfproj import *
import zomig,sgmig,spmig,pplot

# ------------------------------------------------------------
# PLOTTING
# ------------------------------------------------------------
def igrey(custom):
    return '''
    grey  labelrot=n wantaxis=y wanttitle=y title=""
    pclip=100
    min2=-2000 max2=2000 grid=y gridcol=0 g1num=500 g2num=500
    label1="z (m)" label2="x (m)"
    %s 
    ''' % (custom)
# ------------------------------------------------------------
par = {
    'nz':120,  'dz':5.0,  'oz':0,
    'nx':1000, 'dx':5.0,  'ox':-2500,
    'nt':1000, 'dt':0.004,'ot':0,    'kt':201,
#
    'nw':100, 'ow':1.5, 'jw':1,
#    'nw':20,  'ow':1.5, 'jw':1,
#    'nw':1,   'ow':15,   'jw':1,
#    
    'verb':'y','eps':0.01,'nrmax':1,'dtmax':0.00005,
    'tmx':32,'tmy':0,'pmx':128,'pmy':0,
    'misc':'incore=n',
#
    'nsc':1,
    'ns':1,'fs':0,'js':1
    }
par['zmin']=par['oz']
par['zmax']=par['oz'] + (par['nz']-1) * par['dz']
par['xmin']=par['ox']
par['xmax']=par['ox'] + (par['nx']-1) * par['dx']

par['xpad']=par['nx']/2.
par['xsou']=par['ox'] + par['xpad'] * par['dx']
par['xoff']=          - par['xpad'] * par['dx']

par['dw']= 1/(par['nt']*par['dt'])

# ------------------------------------------------------------
# ------------------------------------------------------------
# VELOCITY/SLOWNESS
# ------------------------------------------------------------
Flow('vel',None,
     '''
     spike nsp=1 mag=1000
     n1=%(nz)d d1=%(dz)g o1=0 |
     spray axis=2 n=%(nx)d o=%(ox)g d=%(dx)g |
     put label1=z label2=x label3=y 
     ''' % par )    
#Result('vel','vel',igrey('title="background velocity"'))
Flow('slo','vel',
     '''
     transp |
     math "output=1/input" |
     spray axis=2 n=1 |
     put label2=y
     ''' % par )

# ------------------------------------------------------------
# WAVELET
# ------------------------------------------------------------

# migration wavelet
Flow('wvl',None,
     '''
     spike nsp=1 mag=1
     n1=%(nt)d d1=%(dt)g o1=0        k1=1
     n2=1      d2=%(dx)g o2=%(xsou)g |
     put label1=t label2=x label3=y
     ''' % par)

# modeling wavelet
Flow('wav',None,
     '''
     spike nsp=1 mag=1
     n1=%(nt)d d1=%(dt)g o1=0        k1=125
     n2=1      d2=%(dx)g o2=%(xsou)g |
     ricker1 frequency=10 |
     put label1=t label2=x label3=y
     ''' % par)
#Result('wav','wav','graph title=" "')

Flow('sou','wav',
     '''
     fft1 |
     window squeeze=n n1=%(nw)d min1=%(ow)g |
     pad beg2=%(xpad)d n2out=%(nx)d |
     put label1=w label2=x label3=y |
     transp memsize=250 plane=12 |
     transp memsize=250 plane=23 
     ''' % par)

# ------------------------------------------------------------
# REFLECTIVITY / IMAGE
# ------------------------------------------------------------
Flow('ref',None,
     '''
     spike nsp=1 mag=1 
     n1=%(nx)d d1=%(dx)g o1=%(ox)g
     n2=%(nz)d d2=%(dz)g o2=%(oz)g k2=100 |
     spray axis=2 n=1 o=0 d=1 |
     put label1=x label2=y label3=z 
     ''' % par )    
Result('ref','ref','window | transp |' + igrey(''))

Flow('img','vel',
     '''
     spike nsp=1 mag=1 
     n1=%(nx)d d1=%(dx)g o1=%(ox)g
     n2=%(nz)d d2=%(dz)g o2=%(oz)g k2=100 |
     transp |
     depth2time velocity=${SOURCES[0]} dt=%(dt)g nt=%(nt)d |
     ricker1 frequency=10 |
     time2depth velocity=${SOURCES[0]} dz=%(dz)g nz=%(nz)d |
     transp |
     spray axis=2 n=1 o=0 d=1 |
     put label1=x label2=y label3=z 
     ''' % par )    
Result('img','img','window | transp |' + igrey(''))

# ------------------------------------------------------------
# DATA/IMAGE (by shot-record modeling)
# ------------------------------------------------------------
spmig.model('modS','slo','sou','ref',par)
Flow('sone','modS',
     '''
     window |
     transp |
     pad beg1=6 n1out=501 |
     fft1 inv=y |
     window f1=125 |
     pad n1out=%(nt)d |
     put o1=0 o2=%(xoff)g o3=%(xsou)g
     ''' % par)
Result('sone','sone','grey pclip=100')

# wavefields
spmig.wflds('dos','dor','wvl','sone',par)
zomig.Cwfone('wos','dos','slo',par) # source
zomig.Awfone('wor','dor','slo',par) # receiver

# migration
spmig.imagePW('imgS','cig','slo','dos','dor',par)
Plot('imgS','imgS','window | transp |'+ igrey('title="img" pclip=99'))

# ------------------------------------------------------------
# DATA/IMAGE (by exploding reflector modeling)
# ------------------------------------------------------------
zomig.model('modZ','slo','img',par)
Flow('zoff','modZ',
     '''
     window |
     transp |
     pad beg1=6 n1out=501 |
     fft1 inv=y |
     put o1=0
     ''' % par)
Result('zoff','zoff','grey pclip=100')

# wavefields
zomig.wflds('doo','zoff',par)
zomig.Awftwo('woo','doo','slo',par)

# migration
zomig.image('imgZ','slo','doo',par)
Plot('imgZ','imgZ','window | transp |' + igrey('title="image" pclip=99'))
# ------------------------------------------------------------

for i in range(3):
    par['xs']=par['nx']/2+i*50 - 10 # x start
    par['xe']=par['nx']/2+i*50 + 10 # x end

    dsl = 'dsl' + str(i)
    Flow(dsl,None,
         '''
         spike nsp=1 mag=0.00005
         n1=%(nz)d d1=%(dz)g o1=%(oz)g k1=039    l1=061
         n2=%(nx)d d2=%(dx)g o2=%(ox)g k2=%(xs)d l2=%(xe)d |
         put label1=z label2=x label3=y |
         smooth rect1=1 rect2=1 |
         transp plane=12 |
         transp plane=23 |
         rtoc
         ''' % par)
    Plot(dsl,dsl,'window | real | transp |'+ igrey('title="dsl" color=F'))

    # WEMVA shot-record
    scatS= 'scatS'+ str(i)
    dimS = 'dimS' + str(i)
    bslS = 'bslS' + str(i)
    spmig.s2i(dsl, dimS,'wos','wor','slo',par) # forward
    spmig.i2s(dimS,bslS,'wos','wor','slo',par) # adjoint

    Plot(dimS,dimS,'window | real | transp |'+ igrey('title="dim" pclip=99'))
    Plot(bslS,bslS,'window | real | transp |'+ igrey('title="bsl" color=F pclip=99'))
    pplot.p2x2(scatS,'imgS',dsl,dimS,bslS,0.5,0.55,-10,-12)

    # WEMVA zero-offset
    scatZ= 'scatZ'+ str(i)
    dimZ = 'dimZ' + str(i)
    bslZ = 'bslZ' + str(i)
    zomig.s2i(dsl ,dimZ,'woo','slo',par) # forward
    zomig.i2s(dimZ,bslZ,'woo','slo',par) # adjoint

    Plot(dimZ,dimZ,'window | real | transp |'+ igrey('title="dim" pclip=99'))
    Plot(bslZ,bslZ,'window | real | transp |'+ igrey('title="bsl" color=F pclip=99'))
    pplot.p2x2(scatZ,'imgZ',dsl,dimZ,bslZ,0.5,0.55,-10,-12)

# ------------------------------------------------------------

par['mx']=par['nx']/2
Flow('dim','dimZ0',
     '''
     window n1=1 f1=%(mx)d |
     spray axis=1 n=%(nx)d o=%(ox)g d=%(dx)g |
     spray axis=2 n=1 o=0 d=1
     ''' % par)
Plot('dim','dim','window | real | transp |'+ igrey('pclip=100'))

Flow('don','dimZ0',
     '''
     window | transp | stack |
     transp plane=12 |
     transp plane=23 |
     put o1=%(ox)g d1=%(dx)g
     ''' % par)

spmig.i2s('dim','bakS','wos','wor','slo',par)
Plot('bakS','bakS','window | real | transp |'+ igrey('color=F pclip=99'))
Result('kerS',['imgS','dim','bakS'],'OverUnderAniso')

zomig.i2s('dim','bakZ','woo','slo',par)
Plot('bakZ','bakZ','window | real | transp |'+ igrey('color=F pclip=99'))
Result('kerZ',['imgZ','dim','bakZ'],'OverUnderAniso')

for j in range(4):
    par['xx']=par['nx']/2+j*50

    dim = 'dim' + str(j)
    Flow(dim,'don','pad beg1=%(xx)d n1out=%(nx)d | put o1=%(ox)d' % par)
    Plot(dim,dim,'window | real | transp |'+ igrey('pclip=100'))

    bakS = 'bakS' + str(j)
    spmig.i2s(dim,bakS,'wos','wor','slo',par)
    Plot(bakS,bakS,'window | real | transp |'+ igrey('color=F pclip=99'))
    kerS = 'kerS' + str(j)
    Result(kerS,['imgS',dim,bakS],'OverUnderAniso')

    bakZ = 'bakZ' + str(j)
    zomig.i2s(dim,bakZ,'woo','slo',par)
    Plot(bakZ,bakZ,'window | real | transp |'+ igrey('color=F pclip=99'))
    kerZ = 'kerZ' + str(j)
    Result(kerZ,['imgZ',dim,bakZ],'OverUnderAniso')


# ------------------------------------------------------------
    
End()
