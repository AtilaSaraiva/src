from rsfproj import *

# ------------------------------------------------------------
# PLOTTING
# ------------------------------------------------------------
def igrey(custom):
    return '''
    grey %s 
    ''' % (custom)
# ------------------------------------------------------------
# MIGRATION parameters
# ------------------------------------------------------------
par = {
    'nw':751, 'ow':0, 'jw':1,
    'nx':1600,'ox':25025,'dx':25, 'xsou':35025, 'psou':400,
    'nz':1201,
    'ZOM':'zomig readwrite=y verb=y inv=n eps=0.01 nr=5 dt=0.00005 tmx=16 pmx=0',
    'CAM':'camig readwrite=y verb=y inv=n eps=0.01 nr=5 dt=0.00005 tmx=16 pmx=0',
    'SPM':'srmig readwrite=y verb=y inv=n eps=0.01 nr=5 dt=0.00005 tx=16 px=0'
    }
# ------------------------------------------------------------


# ------------------------------------------------------------
# from SGY to RSF
# ------------------------------------------------------------
refl = 'sigsbee2a_reflection_coefficients.sgy'
velo = 'sigsbee2a_stratigraphy.sgy'

Fetch(refl,'sigsbee')
Fetch(velo,'sigsbee')

Flow('zrefl tzrefl ./rhead ./brhead',refl,
     '''
     segyread
     tape=$SOURCE
     tfile=${TARGETS[1]}
     hfile=${TARGETS[2]}
     bfile=${TARGETS[3]}
     ''',stdin=0)
Flow('zvelo tzvelo ./vhead ./bvhead',velo,
     '''
     segyread
     tape=$SOURCE
     tfile=${TARGETS[1]}
     hfile=${TARGETS[2]}
     bfile=${TARGETS[3]}
     ''',stdin=0)

# ------------------------------------------------------------
# VELOCITY / SLOWNESS
# ------------------------------------------------------------
Flow('velo','zvelo','put d1=25 o2=10025 d2=25 label1=z label2=x')
Flow('s0','velo',
     '''
     window n1=%(nz)d |
     math "output=1/input" |
     transp |
     spray axis=2 n=1 o=0 d=1 |
     put label2=y
     ''' % par)
# ------------------------------------------------------------
# REFLECTIVITY
# ------------------------------------------------------------
Flow('refl','zrefl','put d1=25 o2=10025 d2=25 label1=z label2=x')
Flow('r0','refl',
     '''
     window n1=%(nz)d min2=%(ox)g n2=%(nx)d |
     transp |
     spray axis=2 n=1 o=0 d=1 |
     put label2=y
     ''' % par)

Result('s0','s0','window      | transp |'+igrey('pclip=99 allpos=y color=j'))
Result('r0','r0','window      | transp |'+igrey('pclip=99'))

# ------------------------------------------------------------
# SHOT-PROFILE MODELING
# ------------------------------------------------------------

Flow('ttt',None,
     '''
     spike nsp=1
        n1=3000 d1=0.004 o1=0
        n2=1    d2=25  o2=%(xsou)g |
     math output="exp(-10000*((x1-0.2)^2))" |
     halfint inv=y adj=n |
     halfint inv=y adj=y |
     window n1=2000 |
     pad n1out=3000 |
     bandpass flo=10 fhi=40
     ''' % par )
Result('ttt','ttt','window n1=100 | graph')

# sou(nw)
Flow('sou','ttt',
     '''
     fft1 |
     window squeeze=n n1=%(nw)d min1=%(ow)g j1=%(jw)d |
     put label1=w
     ''' % par )
Result('sou','sou','real | graph')

# source wavefield
# sdd(nx,ny,nw,ne)
Flow('sdd','sou',
     '''
     pad beg2=%(psou)d n2out=%(nx)d |
     transp |
     spray axis=2 n=1 o=0 d=1 |
     put label1=x label2=y
     ''' % par )
Result('sdd','sdd','window | real | transp | grey pclip=100')

Flow('srr www','sdd s0 r0',
     '''
     srmod
     readwrite=y verb=y eps=0.01 nr=5 dt=0.00005 tx=16 px=0
     slo=${SOURCES[1]}
     ref=${SOURCES[2]}
     www=${TARGETS[1]}
     ''')

Flow('trr','srr',
     '''
     window min1=%(xsou)g j1=3 n1=384 |
     put o1=0 |
     transp |
     fft1 inv=y |
     put o1=-0.2 label1=t |
     window min1=0 |
     pad n1out=1500 |
     window min1=2 n1=600
     ''' % par )
Result('trr','trr','grey')

End()
