## 
 # F-D modeling in random media
 ##
from rsfproj import *
import spmig,fdmod

# ------------------------------------------------------------
par = {
    'nt':4000,'dt':0.0005,'ot':0,'lt':'label1=t unit1=s',
    'kt':150,     # wavelet delay
    'nx':801, 'ox':0, 'dx':0.0025,'lx':'label2=x unit2=km',
    'nz':401, 'oz':0, 'dz':0.0025,'lz':'label1=z unit1=km',
    #
    'nw':100,'ow':1,'jw':1,'fs':0,'js':1,
    'nrmax':5,'dtmax':0.00001,
    'nbz':200,'nbx':200,
    'tx':0.0015,'tz':0.0015
    }
fdmod.param(par)
# ------------------------------------------------------------

# ------------------------------------------------------------
# wavelet
Flow('wav',None,
         '''
         spike nsp=1 mag=1 n1=%(nt)d d1=%(dt)g o1=%(ot)g k1=%(kt)d |
         ricker1 frequency=35 |
         scale axis=123 |
         put label1=t label2=x label3=y 
         ''' % par)    
Result('wav','window n1=400 | graph title="" label1="t" label2=')

# ------------------------------------------------------------
Flow('r_',None,'math n1=%(nx)d d1=%(dx)g o1=%(ox)g output=0' % par)
Flow('s_',None,'math n1=1      d1=0      o1=0      output=0' % par)

# receivers
Flow('zr','r_','math output="0" ')
Flow('xr','r_','math output="x1"')
Flow('rr',['xr','zr'],
     '''
     cat axis=2 space=n
     ${SOURCES[0]} ${SOURCES[1]} | transp
     ''', stdin=0)
Plot('rr','window n1=2 | dd type=complex | window j2=10 | '
     + fdmod.cgraph('symbol=* plotcol=6',par))

# sources
Flow('zs','s_','math output=0')
Flow('xs','s_','math output=1')
Flow('rs','s_','math output=1')
Flow('ss',['xs','zs','rs'],
     '''
     cat axis=2 space=n
     ${SOURCES[0]} ${SOURCES[1]} ${SOURCES[2]} | transp
     ''', stdin=0)
Plot('ss','window n1=2 | dd type=complex | window | '
     + fdmod.cgraph('symbol=v plotcol=6',par))

# ------------------------------------------------------------
# velocity
Flow('vo',None,
     '''
     math n1=%(nz)d o1=%(oz)g d1=%(dz)g output="1.5+0.0*x1" |
     spray axis=2 n=%(nx)d o=%(ox)g d=%(dx)g
     ''' % par)
Flow('va','vo','window')
Flow('vb','vo',
     '''
     noise mean=0 range=.5 |
     add add=-1.5 |
     window f1=35 |
     pad  beg1=35 |
     add add=1.5 |
     smooth rect1=3 rect2=3
     ''')
Flow('vc','vo','window')

# ------------------------------------------------------------

# scatterers
Flow('ro','vo','math output=2')
Flow('ra',None,
     '''
     spike nsp=1 mag=5
     n1=%(nz)d o1=%(oz)g d1=%(dz)g k1=349 l1=351
     n2=%(nx)d o2=%(ox)g d2=%(dx)g k2=399 l2=401 |
     add add=2 |
     smooth rect1=3 rect2=3
     ''' % par)
Flow('rb','ra','window')
# ------------------------------------------------------------
# F-D modeling
for i in ('o','a','b'):
    Plot('v'+i,fdmod.cgrey('color=j allpos=y bias=1.5 pclip=100',par))
    Plot('r'+i,fdmod.cgrey('        allpos=y bias=2.0 pclip=100',par))
    Result('v'+i,['v'+i,'ss','rr'],'Overlay')
    Result('r'+i,['r'+i,'ss','rr'],'Overlay')
    
    fdmod.amodel('d'+i,'w'+i,'wav','v'+i,'r'+i,'ss','rr','dens=y',par)
    Result('w'+i,             fdmod.wgrey('pclip=99',par))
    Result('d'+i,'transp |' + fdmod.dgrey('pclip=99',par))

Flow('dc','db','window')
Plot('vc',fdmod.cgrey('color=j allpos=y bias=1.5 pclip=100',par))
Result('vc',['vc','ss','rr'],'Overlay')

# ------------------------------------------------------------
# S-R migration

# source data (frequency)
Flow('dos','wav',
     '''
     pad beg2=400 n2out=%(nx)d |
     put o2=%(ox)g d2=%(dx)g |
     fft1 inv=n opt=n |
     window squeeze=n n1=%(nw)d min1=%(ow)g j1=%(jw)d |
     put label1=w label2=x |
     transp plane=12 | transp plane=23
     ''' % par)

for i in ('a','b','c'):
    # slowness 
    Flow('s'+i,'v'+i,
         '''
         math output=1/input |
         transp |
         spray axis=2 n=1 o=0 d=1 |
         put label2=y
         ''')
    
    # recorded data (time)
    Flow(  'd'+i+'t',['d'+i,'do'],'add ${SOURCES[1]} scale=1,-1')
    Result('d'+i+'t','transp |' + fdmod.dgrey('pclip=99',par))
    
    # recorded data (frequency)
    Flow('d'+i+'w','d'+i+'t',
         '''
         transp |
         fft1 inv=n opt=n |
         window squeeze=n n1=%(nw)d min1=%(ow)g j1=%(jw)d |
         put label1=w label2=x |
         transp plane=12 | transp plane=23
         ''' % par)
    
    # migration
    spmig.imagePW('i'+i,'c'+i,'s'+i,'dos','d'+i+'w',par)
    Result('i'+i,'window | transp |'
           + fdmod.cgrey('pclip=100 title=i%s' %i,par))



End()
