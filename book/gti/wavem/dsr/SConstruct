###########################################################################
# STANDARD HEADER
###########################################################################
import sys, os

root = os.environ.get('RSFROOT')
sys.path.append(os.path.join(root,'lib'))

from rsfproj import *
Book()

###########################################################################

plot = "grey label1='Time (s)' label2='Lateral (km)' "

Flow('diag',None,
     '''
     spike n1=129 n2=131
     d1=0.004 d2=0.004
     nsp=6 
     k1=10,30,50,70,90,110 
     k2=10,30,50,70,90,110
     ''')

Plot('diag','diag',plot + "pclip=100 title=Model")

Flow('diag-fft','diag','cosft sign2=1')
Flow('diagz','diag',
          '''cp $SOURCE $TARGET;
          echo d1=0.003 >> $TARGET''',stdin=0,stdout=-1)

Flow('diag-presto','diag-fft',
          'prestolt nh=131 dh=0.008 vel=1.5 inv=1')
Flow('diag-pre','diag-presto',
          'transp plane=23 | cosft sign2=-1 sign3=-1')

Plot('diag-presto','diag-presto',
          '''
          prestolt vel=1.5 |
          cosft sign2=-1 |
          %s pclip=99.8 title="Prestack Stolt" 
          ''' % plot)
Combine('diag-presto','diag diag-presto','SideBySideAniso',result=1)

Plot('diag-phase','diag',
          '''gazdag eps=0.01 nt=129 dt=0.004 vel=1.5 inv=1 |
          %s pclip=99.8 title=Gazdag''' % plot)
Combine('diag-phase','diag diag-phase','SideBySideAniso',result=1)

Plot('diag-sstep','diagz',
          '''sstep1 eps=0.01 nt=129 dt=0.004 vel=1.5 inv=1 |
          %s pclip=99.8 title=Gazdag1''' % plot)
Combine('diag-sstep',['diag','diag-sstep'],'SideBySideAniso',result=1)

Flow('diag-predsr','diag',
          '''fft2 | dsr nh=65 dh=0.008 vel=1.5 inv=1 nt=129 dt=0.004 |
          fft3 inv=1 | transp plane=23 | fft2 inv=1 both=1''')

Plot('diag-dsr','diag-predsr',
          '''fft2 both=1 | transp plane=23 | fft3 |
          dsr vel=1.5 nz=129 dz=0.004 | fft2 inv=1 |
          %s pclip=100 title="DSR"''' % plot)
Combine('diag-dsr',['diag','diag-dsr'],'SideBySideAniso',result=1)

Flow('sagmod',None,"sag nt=65 nx=65 tmax=4 v0=1.5 alpha=0.5")
Flow('sagvel','sagmod',"voft v0=1.5 alpha=0.5")
Flow('sagdat','sagmod sagvel',
          "gazdag velocity=${SOURCES[1]} nt=65 dt=0.0615385 inv=1")
Flow('sagres','sagdat sagvel',
          "gazdag velocity=${SOURCES[1]} inv=0")

Result('sagdat','sagdat',plot + ' title="Gazdag modeling"')
Result('sagres','sagres',plot + ' pclip=100 title="Gazdag migration"')

################### Impulses ######################################

Flow('impuls',None,
          '''
          spike n1=129 n2=400 d1=1 d2=1 nsp=1 k1=100 k2=128 |
          bandpass fhi=0.3 | transp | bandpass fhi=0.3 | transp
          ''')
Flow('impuls2',None,
          '''
          spike n1=129 n2=256 n3=100 d1=1 d2=1 d3=1 nsp=1 k1=100 k2=121 k3=41 |
          bandpass fhi=0.3 | transp | bandpass fhi=0.3 | transp |
          transp plane=13 | bandpass fhi=0.3 | transp plane=13
          ''')

##################### Models #####################################

Flow('const',None,'spike n1=129 n2=256 d1=1 d2=1 mag=2')
Flow(['wall','one','two'],None,
          '''
          spike n1=129 n2=80  d1=1 d2=1 mag=4 > ${TARGETS[1]};
          spike n1=129 n2=176 d1=1 d2=1 mag=2 > ${TARGETS[2]};
          cat axis=2 ${TARGETS[1]} ${TARGETS[2]}
          ''')
Flow('noise','const',
          '''
          spike n1=129 n2=256 d1=1 d2=1 mag=200 nsp=1 k1=100 k2=80 |
          add $SOURCE
          ''',stdin=0)
Flow('vofz','const',
          '''
          window n2=1 | headermath output='1+0.01*N' | spray n=256 o=0 d=1
          ''')
Flow('vofx','const',
          '''
          window n1=1 | headermath output='1+0.01*N' |
          spray n=129 o=0 d=1 | transp
          ''')
Flow('vofx2','const',
          '''
          window n1=1 | headermath output='1+0.01*N*(1+0.001*N)' | \
          spray n=129 o=0 d=1 | transp
          ''')
Flow('vofx3','const',
          '''
          window n1=1 | headermath output='1/sqrt(1-0.00375*N)' | \
          spray n=129 o=0 d=1 | transp
          ''')
Flow('pgauss',None,
          'spike n1=129 n2=400 d1=1 d2=1 mag=2 | gauss c1=33')
Flow('mgauss',None,
          'spike n1=129 n2=400 d1=1 d2=1 mag=2 | gauss c1=33 a=-1')

for mod in ('const','wall','noise',
            'vofz','vofx','vofx2','vofx3',
            'pgauss','mgauss'):
    trav = mod + '-trav'
    trav1 = mod + '-trav1'
    trav2 = mod + '-trav2'
    Plot(trav,mod,
              '''
              eikonal yshot=127 | window n2=256 |
              contour nc=1 c0=49.5 plotcol=2 plotfat=3 wanttitle=n wantaxis=n
              ''')
    Flow(trav1,mod,'eikonal yshot=80')
    Flow(trav2,mod,'eikonal yshot=160')
    Plot(trav2,[trav1,trav2],
              '''
              add ${SOURCES[1]} | window n2=256 |
              contour nc=1 c0=99 plotcol=2 plotfat=3 wanttitle=n wantaxis=n
              ''')

    # Time migration by Gazdag
    vz = mod + '-vz'
    phase = mod + '-phase'
    Flow(vz,mod,'depth2time velocity=$SOURCE | stack norm=yes')
    Flow(phase,['impuls',vz,mod],
              '''
              window n2=256 | gazdag inv=0 velocity=${SOURCES[1]} eps=1 |
              time2depth velocity=${SOURCES[2]}
              ''')
    Plot(phase,phase,plot + 'label1="Depth (km)" wanttitle=n')
    Combine(phase,[phase,trav],'Overlay',result=1)

    # Depth migration by split-step
    phase = mod + '-sstep'
    Flow(phase,['impuls',mod],
              'window n2=256 | sstep1 eps=1 velocity=${SOURCES[1]}')    
    Plot(phase,phase,plot + 'label1="Depth (km)" wanttitle=n')
    Combine(phase,[phase,trav],'Overlay',result=1)

    # Time migration by DSR
    phase = mod + '-phase2'
    Flow(phase,['impuls2',vz,mod],
              '''
              fft2 both=1 | transp plane=23 | fft3 |
              dsr velocity=${SOURCES[1]} | fft2 inv=1 |
              time2depth velocity=${SOURCES[2]}
              ''')
    Plot(phase,phase,plot + 'label1="Depth (km)" wanttitle=n')
    Combine(phase,[phase,trav2],'Overlay',result=1)

grad = {
    'vofx3':-0.00375,
    'vofx':-0.00272
    }

# Time migration by Gazdag 
for mod in  ['vofx','vofx3']:
    vz = mod + '-Vz'
    phase = mod + '-Phase'
    trav = mod + '-trav'
    Flow(vz,mod,'depth2time velocity=$SOURCE | stack norm=yes')
    Flow(phase,['impuls',vz,mod],
              '''
              window n2=256 | gazdag inv=0 velocity=${SOURCES[1]} eps=1
              grad=%g | time2depth velocity=${SOURCES[2]}
              ''' % grad[mod])
    Plot(phase,phase,plot + 'label1="Depth (km)" wanttitle=n')
    Combine(phase,[phase,trav],'Overlay',result=1)

###########################################################################
# STOLT TEST
###########################################################################

Flow('fft3',None,
          '''
          spike n1=125 n2=131 n3=131 d1=0.004 d2=0.008 d3=0.008
          nsp=3 k1=50,75,100 k2=50,75,100 k3=50,75,100 |
          bandpass flo=10 fhi=50 |
          cosft sign2=1 sign3=1
          ''')
for nf in [2,4,8]:
    stolt = 'stolt%d' % nf
    Flow(stolt,'fft3',
              'stolt nf=%d vel=4 | cosft sign2=-1 sign3=-1' % nf)
    Plot(stolt+'-depth',stolt,
              '''window n1=1 f1=30 |
              grey title="Stolt migration %d: Depth slice"
              screenratio=1 screenht=12''' % nf)
    Plot(stolt+'-line',stolt,
              '''window n2=1 f2=64 |
              grey title="Stolt migration %d: In-line slice"
              screenratio=0.5 screenht=6''' % nf)
    Combine(stolt,[stolt+'-line',stolt+'-depth'],'OverUnderIso',result=1)

    
    
###########################################################################
End()
