from rsfproj import *
from math import pi

lam = 0

Flow('zo',None,
     '''
     spike n1=400 nsp=5 k1=100,150,200,250,300 n2=100 d2=0.01 |
     bandpass flo=5 fhi=20
     ''')
Flow('vel','zo','window n2=1 | math output=2')
Flow('cmp','zo vel','inmo velocity=${SOURCES[1]}')
Flow('ncmp','cmp','noise rep=1 range=0.1 seed=2005 | bandpass flo=5 fhi=20 | add $SOURCE')

Flow('mvel','vel','math output=1')
Flow('mcmp','ncmp mvel',
     '''
     spike n1=400 k1=125 n2=100 d2=0.01 mag=0.5 |
     bandpass flo=5 fhi=20 |
     inmo velocity=${SOURCES[1]} |
     add ${SOURCES[0]}
     ''')

for case in ('','n','m'):
    cmp=case+'cmp'
    Result(cmp,'grey title=CMP label2="Offset (km)" ')

    scan=case+'scan'
    dsem=case+'dsem'
    semb=case+'semb'
    Flow(scan,cmp,'vscan nv=201 v0=1 dv=0.01 weight=n')
    Flow(semb,cmp,'vscan nv=201 v0=1 dv=0.01 semblance=y')
    Result(semb,
           '''
           grey color=j allpos=y title="Semblance"
           label2="Velocity (km/s)" 
           ''')

    pik=case+'pik'
    nmo=case+'nmo'
    Flow(pik,semb,'window min2=1.75 max2=2.25 | pick rect1=100')
    Flow(nmo,[cmp,pik],'nmo velocity=${SOURCES[1]}')
    Result(nmo,'grey title=NMO label2="Offset (km)" ')

    stck=case+'stck'
    feyn=case+'feyn'
    comp=case+'comp'
    Flow(stck,nmo,'stack')
    Flow(feyn,scan,
         '''
         deriv | 
         math output="input/(x2^3*sqrt(x1+0.002))" |
         stack | halfint adj=n | envelope hilb=y phase=80
         ''')
    Result(comp,[cmp,feyn,stck],
           '''
           window n2=1 | cat axis=2 ${SOURCES[1:3]} |
           reverse which=2 | 
           dots labels="Stack:Feynman:Zero Offset"
           ''')
    
End()
