from rsfproj import *
import math

mpar = {
    'nz':300,'dz':8,'oz':0,   'zmin':0,   'zmax':2400,
    'nx':500,'dx':8,'ox':4000,'xmin':4000,'xmax':8000,
    'nt':6000,'dt':0.0005,'ot':0, 'tau':0.5
    }
Fetch('marmvel.hh','marm')

# wavelet
Flow('mwav',None,
     '''
     spike nsp=1 n1=%(nt)d d1=%(dt)g o1=%(ot)g |
     math output="exp(-10000*((x1-%(tau)g)^2))" |
     halfint inv=y adj=y |
     halfint inv=n adj=y |
     bandpass flo=15
     ''' % mpar)

Result('mwav','graph title=Wavelet')
Result('fwav','mwav','spectra | window max1=100 | sfgraph title="Wavelet Spectrum" ')

# velocity
Flow('mvel','marmvel.hh',
     '''
     dd form=native |
     window j1=2 j2=2 |
     window min1=%(oz)g n1=%(nz)g min2=%(ox)g n2=%(nx)g |
     smooth rect1=30 rect2=30 repeat=5
     ''' % mpar)

Result('mvel',
       '''
       grey color=j scalebar=y title=Model bias=1500 allpos=y
       screenht=9 screenwd=15 label1=Depth unit1=m label2=Lateral unit2=m
       barlabel=Velocity barunit=m/s
       ''')

Flow('msoc',None,
     '''
     spike
     n1=%(nz)d d1=%(dz)g o1=%(oz)g k1=150
     n2=%(nx)d d2=%(dx)g o2=%(ox)g k2=250
     ''' % mpar )
Flow('msou','msoc','cube2list verb=y clip=0.01')

# modeling
##
Flow('mdat mwfl','mwav mvel msou msou',
     '''
     afdm2d verb=y abc=y free=n snap=y jsnap=6
     nbz=50 tz=0.006125 nbx=50 tx=0.006125 
     vel=${SOURCES[1]}
     sou=${SOURCES[2]}
     rec=${SOURCES[3]}
     wfl=${TARGETS[1]}         
     ''')

# ------------------------------------------------------------

Flow('march','mvel','eikonal zshot=1192 yshot=5992 | add add=%(tau)g' % mpar)
Result('march',
       '''
       grey clip=1 color=j scalebar=y bias=%(tau)g
       title="Eikonal" allpos=y
       screenht=9 screenwd=15 label1=Depth unit1=m label2=Lateral unit2=m
       barlabel=Time barunit=s
       ''' % mpar)

for n in (1,2):
    mpar['t'] = n*0.25+mpar['tau']
    wfl = 'mwfl%d' % n
    Plot(wfl,'mwfl',
         '''
         window n3=1 min3=%(t)g min1=%(oz)g n1=%(nz)d min2=%(ox)g n2=%(nx)d |
         grey pclip=100 title="Wavefield Snapshot at %(t)g s"
         screenht=9 screenwd=15 label1=Depth unit1=m label2=Lateral unit2=m
         ''' % mpar)
    Plot('c'+wfl,'march',
         '''
         contour nc=1 c0=%(t)g dc=1 wanttitle=n wantaxis=n plotfat=5
         screenht=9 screenwd=15 
         ''' % mpar)
    Result(wfl,[wfl,'c'+wfl],'Overlay')

Flow('freq','mwfl','transp plane=23 memsize=500 | transp memsize=500 | fft1')

Flow('freq1','freq','window n2=1 n3=1 min2=2000 min3=5000')
Flow('fshift1','freq1','math output="exp(I*%g*x1)" ' % (2*math.pi*0.1))
Flow('x1','fshift1','real')
Flow('y1','fshift1','imag')
for x in ('x1','y1'):  
    Flow(x+'p',x,'smoothder')
Flow('time1','x1 y1 x1p y1p',
     '''
     math x=${SOURCES[0]} y=${SOURCES[1]} xp=${SOURCES[2]} yp=${SOURCES[3]}
     output="(x*yp-xp*y)/(x*x+y*y+0.001)/%g"
     ''' % (2*math.pi))

Flow('fshift','freq','math output="input*exp(-I*%g*x1)" ' % (2*math.pi*mpar['tau']))
Flow('x','fshift','real')
Flow('y','fshift','imag')
for x in ('x','y'):  
    Flow(x+'p',x,'smoothder eps=1')

Flow('time','x y xp yp',
     '''
     math x=${SOURCES[0]} y=${SOURCES[1]} xp=${SOURCES[2]} yp=${SOURCES[3]}
     output="(xp*y-x*yp)/(x*x+y*y+0.001)"
     ''')

Flow('asym1','time1','window n1=1 min1=50 | spray axis=1 n=501')

Result('time','time1 asym1',
       '''
       cat axis=2 ${SOURCES[1]} | window max1=50 |
       graph title="Instantaneous Time" dash=0,1
       label1=Frequency unit1=Hz label2=Time unit2=s min2=0 max2=0.2
       ''')

for w in (10,25,40):
    mpar['w']=w
    Result('time%d' % w,'time',
           '''
           window n1=1 min1=%(w)d min2=%(oz)g n2=%(nz)d min3=%(ox)g n3=%(nx)d |
           grey clip=1.5 color=j scalebar=y
           title="Instantaneous Time at %(w)d Hz" 
           screenht=9 screenwd=15 label1=Depth unit1=m label2=Lateral unit2=m
           barlabel=Time barunit=s
           ''' % mpar)

End()
