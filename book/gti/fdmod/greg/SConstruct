## 
 # 
 ##
from rsfproj import *
import fdmod

# ------------------------------------------------------------
par = {
    'nt':2000,'ot':0, 'dt':0.0005, 'lt':'label1=t unit1=s',
    'nx':1001,'ox':0, 'dx':2.5,    'lx':'label2=x unit2=m',
    'nz':401, 'oz':0, 'dz':2.5,    'lz':'label1=z unit1=m',
    'kt':50
    }
fdmod.param(par)

# ------------------------------------------------------------
# plotting functions
def wtplot(wplot,ws,wr,par):
    _ws = "t_" + ws
    _wr = "t_" + wr

    Flow(_ws,ws,
         '''
         window j3=50 n3=20 min1=%(zmin)g max1=%(zmax)g min2=%(xmin)g max2=%(xmax)g f3=%(kt)d |
         put o3=0
         ''' % par)
    Flow(_wr,wr,
         '''
         window j3=50 n3=20 min1=%(zmin)g max1=%(zmax)g min2=%(xmin)g max2=%(xmax)g f3=%(kt)d |
         put o3=0
         ''' % par)
    Result(wplot,[_ws,_wr],
           '''
           cat ${SOURCES[1]} axis=2 space=n |
           grey pclip=97 gainpanel=a title="" screenratio=0.375 screenht=5 grid=y
           ''')
    
def wzplot(wplot,ws,wr,par):
    _ws = "z_" + ws
    _wr = "z_" + wr

    Flow(_ws,ws,
         '''
         window j1=40 min1=%(zmin)g max1=%(zmax)g min2=%(xmin)g max2=%(xmax)g f3=%(kt)d n3=1000 |
         put o3=0 |
         transp plane=13
         ''' % par)
    Flow(_wr,wr,
         '''
         window j1=40 min1=%(zmin)g max1=%(zmax)g min2=%(xmin)g max2=%(xmax)g f3=%(kt)d n3=1000 |
         put o3=0 |
         transp plane=13
         ''' % par)
    Result(wplot,[_ws,_wr],
           '''
           cat ${SOURCES[1]} axis=2 space=n |
           grey pclip=98 gainpanel=a title="" grid=y
           ''')

# ------------------------------------------------------------
# wavelet
fdmod.wavelet('wav',50,par)
Result('wav','wav','window n1=200 | graph title="" label1="t" label2=')

# ------------------------------------------------------------
# experiment
fdmod.horizontal('rr',0,par)
Plot('rr','window n1=2 | dd type=complex | window j2=10 | '
     + fdmod.cgraph('symbol=* plotcol=1 plotfat=10',par))

fdmod.point('ss',par['ox']+par['nx']/2*par['dx'],0,1,par)
Plot('ss','window n1=2 | dd type=complex | window | '
     + fdmod.cgraph('symbol=. plotcol=2 plotfat=10',par))

# ------------------------------------------------------------
# velocity
Flow('vo',None,
     '''
     math n1=%(nz)d o1=%(oz)g d1=%(dz)g output="2000+1*x1" |
     spray axis=2 n=%(nx)d o=%(ox)g d=%(dx)g
     ''' % par)
Plot(  'vo',fdmod.cgrey('allpos=y bias=2000 pclip=100',par))
Result('vo',['vo','rr','ss'],'Overlay')
# ------------------------------------------------------------
# reflectivity
Flow('ro',None,
     '''
     spike nsp=2 mag=1,1
     n1=%(nz)d o1=%(oz)g d1=%(dz)g k1=161 l1=%(nz)d
     n2=%(nx)d o2=%(ox)g d2=%(dx)g k2=001,201 l2=200,%(nx)d |
     add add=2
     ''' % par)
Plot  ('ro',fdmod.cgrey('pclip=100 bias=2',par))
Result('ro',['ro','rr','ss'],'Overlay')
# ------------------------------------------------------------
# mask
Flow('dmask',None,
     '''
     spike nsp=1 mag=1
     n1=%(nt)d o1=%(ot)g d1=%(dt)g
     n2=%(nx)d o2=%(ox)g d2=%(dx)g k2=100 l2=901 |
     smooth rect2=100 |
     scale axis=123 |
     transp
     ''' % par)

# ------------------------------------------------------------
# FD modeling
fdmod.amodel('do','wo','wav','vo','ro','ss','rr','free=y dens=n',par)
fdmod.amodel('dx','wx','wav','vo','ro','ss','rr','free=y dens=y',par)

Flow('dd','dx do','add scale=1,-1 ${SOURCES[1]}')
Flow('ww','wx wo','add scale=1,-1 ${SOURCES[1]}')

Result('do','transp |' + fdmod.dgrey('pclip=99.9',par))
Result('dd','transp |' + fdmod.dgrey('pclip=99.9',par))

Result('wo',fdmod.wgrey('pclip=99.9',par))
Result('ww',fdmod.wgrey('pclip=99.9',par))

# ------------------------------------------------------------
# RTM wavefields

Flow('sou','wav','transp')
Flow('tmp','dd dmask','add mode=p ${SOURCES[1]} | reverse which=2 opt=i')
    
for k in ('n','y'):
    fdmod.awe('ds'+k,'us'+k,'sou','vo','ro','ss','rr','free=y dens=%s jsnap=1'%k,par)

    fdmod.awe('dt'+k,'ut'+k,'tmp','vo','ro','rr','rr','free=y dens=%s jsnap=1'%k,par)
    Flow('dr'+k,'dt'+k,'reverse which=2 opt=i verb=y')
    Flow('ur'+k,'ut'+k,'reverse which=4 opt=i verb=y')

    # ------------------------------------------------------------
    # data
    Result('ds'+k,'transp |' + fdmod.dgrey('pclip=99.9',par))
    Result('dr'+k,'transp |' + fdmod.dgrey('pclip=99.9',par))

    # ------------------------------------------------------------
    # wavefield
    Flow('ws'+k,'us'+k,'window min1=%(zmin)g max1=%(zmax)g min2=%(xmin)g max2=%(xmax)g | scale axis=123' % par)
    Flow('wr'+k,'ur'+k,'window min1=%(zmin)g max1=%(zmax)g min2=%(xmin)g max2=%(xmax)g | scale axis=123' % par)

    Result('ws'+k,'window j3=50 |'+fdmod.wgrey('gainpanel=a pclip=99.9',par))
    Result('wr'+k,'window j3=50 |'+fdmod.wgrey('gainpanel=a pclip=99.9',par))

    wtplot('tmovie'+k,'ws'+k,'wr'+k,par)
    wzplot('zmovie'+k,'ws'+k,'wr'+k,par)

    # ------------------------------------------------------------
    # RTM images

    eps = 0.01
    
    Flow('mm0'+k,['ws'+k,'wr'+k],'ic ur=${SOURCES[1]} version=0 nbuf=500 verb=y')
    Flow('mm1'+k,['ws'+k,'wr'+k],'ic ur=${SOURCES[1]} version=1 nbuf=500 verb=y eps=%g' % eps)

    for i in range(2):
	for k in ('n','y'):
		Result('mm'+str(i)+k,fdmod.cgrey('pclip=99',par))
        	Result('aa'+str(i)+k,'mm'+str(i)+k,
               	'''
               		window n1=10 f1=155 |
               		envelope |
               		transp | stack |
               		scale axis=123 |
               		graph min2=0 max2=+1 wantaxis=y title="" wherexlabel=t label2="" unit2=""
               		screenratio=%(ratio)g screenht=%(height)g
               	''' % par)
    
# ------------------------------------------------------------

End()
