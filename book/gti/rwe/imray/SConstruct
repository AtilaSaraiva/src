from rsfproj import *
import math

# minimum and maximum velocity

vmin=1.5
vmax=3.5

smin=1/(vmax*vmax)
smax=1/(vmin*vmin)

# length in x and z
xmax=10.0
zmax=5.0

nz=501
nx=1001

g = (smax-smin)/xmax
g2 = 0.5*g

# Velocity model in (x,z)
Flow('vxz',None,
     '''
     math n1=%d n2=%d d1=%g d2=%g
     label1=Depth label2=Lateral unit1=km unit2=km
     label=Velocity unit=km/s
     output="1/sqrt(%g+%g*x2)"
     ''' % (nz,nx,zmax/(nz-1),xmax/(nx-1),smin,g))
Plot('vxz','grey color=j scalebar=y bias=%g allpos=y wanttitle=n screenht=%g screenwd=%g' % (vmin,zmax,xmax))

# Traveltimes

xc = xmax/2
zc = zmax/2

Flow('txz','vxz','rays2a nt=3000 dt=0.001 sym=n nr=361 a0=-180 amax=180 zshot=%g yshot=%g' % (zc,xc))

Plot('txz',
     '''
     window j1=100 | transp |
     graph transp=y yreverse=y min1=0 max1=%g min2=0 max2=%g wanttitle=n screenht=%g screenwd=%g plotcol=7
     scalebar=y
     ''' % (zmax,xmax,zmax,xmax))

Result('txz','vxz txz','Overlay')
   

tmax = zmax/vmax
nt = nz

# Slowness squared
Flow('slow2',None,
     '''
     math n1=%d n2=%d d1=%g d2=%g
     label1=Time label2=Lateral unit1=s unit2=km
     output="%g+%g*x2"
     ''' % (nt,nx,tmax/(nt-1),xmax/(nx-1),smin,g))

# Intermediate factor
Flow('fact','slow2',
     '''
     math
     output="(-3*(%g)^4*x1 + sqrt(4*(%g)^6*input^3 + 9*(%g)^8*x1^2))^(1/3)"
     ''' % (g2,g2,g2))

# sigma factor
Flow('sigma','slow2 fact',
     '''
     math fact=${SOURCES[1]}
     output="-(fact/(2^(1/3)*(%g)^2)) + (2^(1/3)*input)/fact"
     ''' % g2)

Flow('vrms','sigma slow2',
     '''
     add mode=p $SOURCE |
     math slow2=${SOURCES[1]}
     output="sqrt(slow2/((slow2-%g*input)*(slow2+%g*input)))"
     ''' % (g2*g2,g2*g2/3))

Flow('vdix','sigma slow2',
     '''
     add mode=p $SOURCE |
     math slow2=${SOURCES[1]}
     output="sqrt(slow2)/(slow2-%g*input)"
     ''' % (g2*g2))

for case in ('vrms','vdix'):
    Plot(case,
         '''
         grey color=j scalebar=y bias=%g
         allpos=y wanttitle=n barlabel=Velocity barunit=km/s
         ''' % vmin)
Result('vrms','vrms vdix','SideBySideIso')

sq = math.sqrt((smin+g*xc)**2-(g*zc)**2)
x0 = (2*smin*xc - g2*zc*zc)/(smin-g*xc+sq)
t0 = math.sqrt(2.0)*zc*(2*smin+2*g*xc+sq)/(3*math.sqrt(smin+g*xc+sq))

Flow('txz','vxz','rays2a nt=3000 dt=0.001 sym=n nr=361 a0=-180 amax=180 zshot=%g yshot=%g' % (zc,xc))

Plot('txz',
     '''
     window j1=100 | transp |
     graph transp=y yreverse=y min1=0 max1=%g min2=0 max2=%g wanttitle=n screenht=%g screenwd=%g plotcol=7
     scalebar=y
     ''' % (zmax,xmax,zmax,xmax))


Flow('txt','vdix','math output=1 | eikonalvti vx=$SOURCE zshot=%g yshot=%g order=1' % (t0,x0))

Plot('txt','contour scalebar=y nc=30 c0=0 dc=0.1 wanttitle=n plotcol=7')

Result('txt','vdix txt','Overlay')


End()
