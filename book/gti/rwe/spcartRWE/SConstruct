from rsfproj import *
import zomig,spmig

par = {
    'nz':300,  'dz':0.005,    'oz':0,     # CC axis 1
    'nt':250,  'dt':0.005,    'ot':1.5,   # RC axis 1
    'nx':300,  'dx':0.020,    'ox':0,     # CC axis 2
    'ng':180,  'dg':0.500,    'og':-45,   # RC axis 2
    'ny':1,    'dy':1,        'oy':0,     # CC axis 3
    'nT':2000, 'dT':0.004,    'oT':0,     'kT':250, # time
    'tmx':10,'eps':0.0000001, 'verb':'y','nrmax':1,
    'ow':1, 'incore':'y',
    'spx':150
    }

par['dw']=1/(par['nT']*par['dT'])
par['nw']=par['nT']/1000*50
#par['nw']=2
#par['ow']=3

par['spx']=par['nx']/2

par['xsou']=par['spx']*par['dx']
par['ysou']=par['oy']

# ------------------------------------------------------------
par['xmin']=par['ox']                             -1
par['xmax']=par['ox'] + (par['nx']-1) * par['dx'] +1
par['zmin']=par['oz']                             -1
par['zmax']=par['oz'] + (par['nz']-1) * par['dz'] +1
par['tmin']=par['ot']
par['tmax']=par['ot'] + (par['nt']-1) * par['dt']
par['gmin']=par['og']
par['gmax']=par['og'] + (par['ng']-1) * par['dg']
# ------------------------------------------------------------

def cgrey(custom,par):
    return '''
    grey labelrot=n wantaxis=y wanttitle=y
    title="" pclip=100 label1="z(m)" label2="x(m)" %s
    min1=%g max1=%g min2=%g max2=%g
    ''' % (custom,par['zmin'],par['zmax'],par['xmin'],par['xmax'])
def rgrey(custom,par):
    return '''
    grey labelrot=n wantaxis=y wanttitle=y
    title="" pclip=100 label1="t(s)" label2="g" %s
    min1=%g max1=%g min2=%g max2=%g
    ''' % (custom,par['tmin'],par['tmax'],par['gmin'],par['gmax'])

def cgraph(custom,par):
    return '''
    graph labelrot=n  %s
    yreverse=y wantaxis=n title=" " 
    min1=%g max1=%g min2=%g max2=%g min1=0
    ''' % (custom,par['xmin'],par['xmax'],par['zmin'],par['zmax'])

# ------------------------------------------------------------

# velocity
Flow('vel',None,
     '''
     spike
     n1=%(nz)d o1=%(oz)g d1=%(dz)g
     n2=%(nx)d o2=%(ox)g d2=%(dx)g |
     math output=2-0.05*x1-0.05*x2 |
     put label1=z label2=x
     ''' % par)
Plot('vel',cgrey('allpos=y bias=1.5',par))

# ------------------------------------------------------------

# wavefronts (by HWT)
Flow('hwt','vel',
     '''
     hwt2d verb=n
     xsou=3 zsou=-3
     nt=1000 ot=0 dt=%(dt)g
     ng=%(ng)d og=%(og)g dg=%(dg)g
     ''' % par)
# coordinate system: rays(g,t)
Flow('cos','hwt','window min2=%(ot)g n2=%(nt)d' % par)

Plot('wft','cos','window f1=5 j1=5 | transp |'
     + cgraph('plotcol=1',par))
Plot('ray','cos','window      j2=5 |'
     + cgraph('plotcol=2',par))
Result('cos','vel ray wft','Overlay')

# ------------------------------------------------------------

# slowness in CC
Flow('sloCC','vel',
     '''
     math output="1/input" |
     transp |
     spray axis=2 n=1 o=0 d=1 |
     put label1=x label2=y label3=z
     ''')
# slowness in RC
Flow('sloRC','sloCC cos',
     '''
     window |
     c2r rays=${SOURCES[1]} adj=n |
     put label1=g label2=t label3=
     ''')
Result('sloRC','transp |'
       + rgrey('pclip=100 color=j allpos=y bias=0.5',par))

# coordinate system coefficients (A,B,M=mask) and references (A,B)
Flow(['abmRC','abrRC'],['cos','sloRC'],
     '''
     rweab naref=1 nbref=1
     slo=${SOURCES[1]} abr=${TARGETS[1]}
     ''')

Plot('aRC','abmRC','window n3=1 f3=0 | transp |'+ rgrey('pclip=100 color=F allpos=n bias=1',par))
Plot('bRC','abmRC','window n3=1 f3=1 | transp |'+ rgrey('pclip=100 color=F allpos=y bias=19',par))
Plot('mRC','abmRC','window n3=1 f3=2 | transp |'+ rgrey('pclip=100 color=j allpos=y',par))
Result('abmRC','aRC bRC mRC','OverUnderAniso')

# ------------------------------------------------------------
# modeling wavelet

Flow('wav',None,
     '''
     spike nsp=1 mag=1 k1=%(kT)d
     n1=%(nT)d d1=%(dT)g o1=%(oT)g
     n2=1    d2=%(dx)g   o2=%(xsou)g
     n3=1    d3=%(dy)g   o3=%(ysou)g |
     ricker1 frequency=5 |
     put label1=t label2=x label3=y 
     ''' % par )    
Result('wav','graph title=" " grid=y')

Flow('sowCC','wav',
     '''
     fft1 opt=n |
     window squeeze=n n1=%(nw)d min1=%(ow)g |
     pad beg2=%(spx)d n2out=%(nx)d |
     put label1=w label2=x label3=y |
     transp plane=12 | transp plane=23 
     ''' % par)
Result('sowCC','window | real | transp | grey pclip=100')

Flow('sowRC','sowCC cos',
     '''
     window |
     spray axis=2 n=1 o=%(oz)g d=%(dz)g |
     pad beg2=10 n2out=20 |
     c2r rays=${SOURCES[1]} adj=n linear=n nsz=3 nsx=3|
     put label1=g label2=t label3=w
     ''' % par)
Result('sowRC','window n3=1 | real | transp |'
       + rgrey('title',par))

# ------------------------------------------------------------
# modeling reflectivity

Flow('refCC',None,
     '''
     spike nsp=1 mag=1
     n1=%(nz)d o1=%(oz)g d1=%(dz)g k1=200
     n2=%(nx)d o2=%(ox)g d2=%(dx)g k2=%(spx)d l2=%(spx)d 
     n3=%(ny)d o3=%(oy)g d3=%(dy)g |
     put label1=z label2=x label3=y |
     transp plane=12 | transp plane=23
     ''' % par)
Plot('refCC','window | transp |' + cgrey('pclip=100',par))
Result('refCC','refCC ray wft','Overlay')

Flow('refRC','refCC cos',
     '''
     window |
     c2r rays=${SOURCES[1]} adj=n |
     put label1=g label2=t label3=
     ''')
# ------------------------------------------------------------

# frequency data CC: (x,w)
spmig.model('fffCC','sloCC','sowCC','refCC',par)
Result('fffCC','window | real | transp | grey pclip=100')

# ------------------------------------------------------------

# time data CC: (t,x)
Flow('datCC','fffCC',
     '''
     window | transp |
     pad beg1=%d n1out=%d |
     fft1 opt=n inv=y |
     window f1=%d | put o1=0 o2=%g | pad n1out=%d |
     put label1=t label2=x
     ''' % (int(par['ow']/par['dw']),
            par['nT']/2+1,
            par['kT'],par['ox'],par['nT']) )
Result('datCC','grey pclip=100 wanttitle=n grid=y')


# ------------------------------------------------------------

# frequency data CC: (x,w)
Flow('frqCC','datCC',
     '''
     fft1 opt=n inv=n |
     window squeeze=n min1=%(ow)g j1=1 n1=%(nw)d |
     transp plane=12 | transp plane=23 |
     put label1=x label2=y label3=w
     ''' % par)
Result('frqCC','window | real | transp | grey pclip=100')

# ------------------------------------------------------------

# frequency data RC: (g,w)
Flow('frqRC','frqCC cos',
     '''
     window |
     spray axis=2 n=1 o=%(oz)g d=%(dz)g |
     pad beg2=10 n2out=20 |
     c2r rays=${SOURCES[1]} adj=n linear=n nsz=3 nsx=3|
     put label1=g label2=t label3=w
     ''' % par)
Result('frqRC','window n3=1 f3=50 | real | transp |'
       + rgrey('',par))

# ------------------------------------------------------------
# migration wavelet (impulse)

Flow('spkCC',None,
     '''
     spike nsp=1 mag=1 k1=1
     n1=%(nT)d d1=%(dT)g o1=%(oT)g
     n2=1    d2=%(dx)g   o2=%(xsou)g
     n3=1    d3=%(dy)g   o3=%(ysou)g |
     put label1=t label2=x label3=y 
     ''' % par )    
Result('spkCC','graph title=" " grid=y')

Flow('sokCC','spkCC',
     '''
     fft1 opt=n |
     window squeeze=n n1=%(nw)d min1=%(ow)g |
     pad beg2=%(spx)d n2out=%(nx)d |
     put label1=w label2=x label3=y |
     transp plane=12 | transp plane=23 
     ''' % par)
Result('sokCC','window | real | transp | grey pclip=100')

Flow('sokRC','sokCC cos',
     '''
     window |
     spray axis=2 n=1 o=%(oz)g d=%(dz)g |
     pad beg2=10 n2out=20 |
     c2r rays=${SOURCES[1]} adj=n linear=n nsz=3 nsx=3|
     put label1=g label2=t label3=w
     ''' % par)
Result('sokRC','window n3=1 | real | transp |'
       + rgrey('title',par))

# ------------------------------------------------------------

# WEM image CC: (z,x)
spmig.image('imgCC','sloCC','sokCC','frqCC',par)
Plot  ('imgCC','window | transp |' + cgrey('title=imgCC',par))
Result('imgCC',['imgCC','ray','wft'],'Overlay')

# ------------------------------------------------------------

for i in (['SSF','FFD','PSC',
           'F15','F45','F60']):
    if(i=='F15'): method='method=0 c1=0.50   c2=0.00'
    if(i=='F45'): method='method=0 c1=0.50   c2=0.25'
    if(i=='F60'): method='method=0 c1=0.4761 c2=0.3767'
    if(i=='SSF'): method='method=1'
    if(i=='FFD'): method='method=2 c1=0.50   c2=0.00'
    if(i=='PSC'): method='method=3 c1=0.50   c2=0.00'

    migCC = 'migCC' + '-' + i
    
    migRC = 'migRC' + '-' + i
    mofRC = 'mofRC' + '-' + i
    
    cutCC = 'cutCC' + '-' + i
    modCC = 'modCC' + '-' + i
    
    # RWE image RC: (g,t)
    Flow(migRC,['sokRC','frqRC','abmRC','abrRC'],
         '''
         rwesrmig ntap=10 verb=y %s
         rwf=${SOURCES[1]}
         abm=${SOURCES[2]}
         abr=${SOURCES[3]} |
         put label1=g label2=t
         ''' % method)
    Result(migRC,'window | transp |' + rgrey('title=%s',par) % i)

    # RWE image CC: (z,x)
    Flow(migCC,[migRC,'cos'],
         '''
         c2r rays=${SOURCES[1]} adj=y linear=n nsz=3 nsx=3
         a2n=%(nz)d a2o=%(oz)g a2d=%(dz)g
         a1n=%(nx)d a1o=%(ox)g a1d=%(dx)g |
         put label1=z label2=x
         ''' % par)
    Plot(migCC,'window | transp |' + cgrey('title=%s',par) % i)
    Result(migCC,[migCC,'ray','wft'],'Overlay')

    # RWE data RC: (g,w)
    Flow(mofRC,['sowRC','refRC','abmRC','abrRC'],
         '''
         rwesrmig ntap=10 adj=y %s
         nw=%d ow=%g dw=%g 
         img=${SOURCES[1]}
         abm=${SOURCES[2]}
         abr=${SOURCES[3]} |
         put label1=g label2=t label3=w
         ''' % (method,par['nw'],par['ow'],par['dw']) )
    Result(mofRC,'window n3=1 f3=50 | real | transp |'
           + rgrey('pclip=99',par))
    
    par['nzcut']=20
    par['ozcut']=-10*par['dz']
    Flow(cutCC,[mofRC,'cos'],
         '''
         c2r rays=${SOURCES[1]} adj=y linear=n nsz=3 nsx=3
         a1n=%(nx)d    a1o=%(ox)g    a1d=%(dx)g
         a2n=%(nzcut)d a2o=%(ozcut)g a2d=%(dz)g |
         window n2=1 min2=%(oz)g
         ''' % par)

    # RWE data RC: (x,T)
    Flow(modCC,cutCC,
         '''
         transp |
         pad beg1=%d n1out=%d |
         fft1 opt=n inv=y |
         window f1=%d |
         pad n1out=%d |
         put label1=t label2=x o1=0
         ''' % (int(par['ow']/par['dw']),
                par['nT']/2+1,
                par['kT'],
                par['nT']))
    Result(modCC,'grey pclip=100 wanttitle=n grid=y')


    # ------------------------------------------------------------

Result('icomp','imgCC migCC-SSF migCC-F15','Movie')

End()
