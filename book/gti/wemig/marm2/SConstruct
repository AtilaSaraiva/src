from rsfproj import *
import spmig,zomig

def igrey(custom):
    return '''
    grey labelrot=n title="" %s 
    ''' % (custom)

# ------------------------------------------------------------
# PARAMETERS
# ------------------------------------------------------------
par = {
    'nw':600, 'ow':3,                            'jw':1,
    'nt':2500,'ot':0,  'dt':0.002,'kt':1,'ft':0,
    'ns':1,   'os':3,  'ds':0.025,
    'nx':256, 'ox':2,  'dx':0.0125,
    'nz':1500,'oz':0,  'jz':4,
    'verb':'y','eps':0.01,'nrmax':5,'dtmax':0.00005,
    'tmx':16,'tmy':0,'pmx':500,'pmy':0
    }
par['xmin']=par['ox']
par['xmax']=par['ox']+(par['nx']-1)*par['dx']

# ------------------------------------------------------------
# VELOCITY/SLOWNESS
# ------------------------------------------------------------
VSUF = '_marmousi-ii.segy'
for c in ('p','s'):
    v = 'v' + c
    h = v + 'head'
    t = v + VSUF

    Fetch(t,'marm2')

    # velocity
    Flow([v,h],t,
         '''
         segyread tape=$SOURCE tfile=${TARGETS[1]} |
         put o1=0 d1=0.00125 o2=0 d2=0.00125 label1="z(km)" label2="x(km)" |
         window j1=%(jz)d
         ''' % par,stdin=0)
    Result(v,v,igrey('color=j allpos=y'))

    # slowness
    s = 's' + c
    Flow(s,v,
         '''
         window f1=90 |
         math "output=1/input" |
         transp memsize=400 |
         spray axis=2 n=1 o=0 d=1 |
         put label2=y
         ''' % par)
    Result(s,s,'window | transp | '+igrey('color=j allpos=y'))

# P source datuming (from 10m to 450m)
Flow('xs','vp',
     '''
     window squeeze=n n1=2 j1=88 f1=2 |
     math "output=1/input" |
     transp memsize=400 |
     spray axis=2 n=1 o=0 d=1 |
     put label2=y
     ''' % par )
Result('xs','xs','window | transp | '+igrey('color=j allpos=y bias=0.45'))

# P receivers datuming (from 5m to 450m)
Flow('xr','vp',
     '''
     window squeeze=n n1=2 j1=89 f1=1 |
     math "output=1/input" |
     transp memsize=400 |
     spray axis=2 n=1 o=0 d=1 |
     put label2=y
     ''' % par )
Result('xr','xr','window | transp | '+igrey('color=j allpos=y bias=0.45'))

# ------------------------------------------------------------
# DATA
# ------------------------------------------------------------
sgy = 'surface_p1.segy'
Fetch(sgy,'marm2')
Flow(['dat','hdr'],sgy,
     '''
     segyread tape=$SOURCE tfile=${TARGETS[1]} format=5 verb=y |
     put n2=1361 o2=0   d2=0.0125
         n3=320  o3=3.0 d3=0.025
     label1=t label2=x label3=s
     ''')

# ------------------------------------------------------------
# receiver (P) data [rec]
# ------------------------------------------------------------
Flow('rec','dat',
     '''
     window n3=1 min3=%(os)g |
     window f1=37 | pad end1=37 | put o1=0 |
     fft1 |
     window squeeze=n
     n1=%(nw)d min1=%(ow)g j1=%(jw)d
     n2=%(nx)d min2=%(ox)g |
     transp |
     spray axis=2 n=1 o=1 d=1 |
     put label1=x label2=y label3=w label4=e
     ''' % par )
Result('rec','rec','window | real | '+igrey('pclip=100'))
Result('trec','rec',
       'window | transp | pad beg1=5 n1out=1251 | fft1 inv=1 | '
       +igrey('pclip=99'))

# ------------------------------------------------------------
# source (P) data [sou]
# ------------------------------------------------------------
Flow('wave',None,
     '''
     spike nsp=1 mag=1 k1=1
     n1=%(nt)d d1=%(dt)g o1=%(ot)g
     n2=1      d2=%(dx)g o2=%(os)g
         ''' % par )    
Result('wave','wave','graph')

# data at the surface [dos]
Flow('sou','wave',
     '''
     fft1 inv=n |
     window squeeze=n n1=%d min1=%g j1=%d |
     pad beg2=%d n2out=%d |
     transp |
     spray axis=2 n=1 o=1 d=1 |
     put label1=x label2=y label3=w label4=e
     ''' % (par['nw'],par['ow'],par['jw'],
            (par['os']-par['ox'])/par['dx'],
            par['nx']) )
Result('sou','sou','window | real | '+igrey('pclip=100'))
Result('tsou','sou',
       'window | transp | pad beg1=5 n1out=1251 | fft1 inv=1 | '
       +igrey('pclip=99'))

# ------------------------------------------------------------

# datumed source (causal, from 10m to 450m)
zomig.Cdtone('dds','sou','xs',par)
Result('dds','dds','window | real | '+igrey('pclip=100'))

# datumed receivers (anticausal, from 5m to 450m)
zomig.Adtone('ddr','rec','xr',par)
Result('ddr','ddr','window | real | '+igrey('pclip=100'))

spmig.imagePW('img','cig','sp','dds','ddr',par)

Result('img','img','window | transp | '+ igrey('pclip=99'))
Result('vv','sp','window | transp | '
       + igrey('color=j allpos=y min2=%(xmin)g max2=%(xmax)g') % par)

# ------------------------------------------------------------

End()
