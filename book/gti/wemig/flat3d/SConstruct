from rsfproj import *
import sys
sys.path.append('../../Scons')
import zomig,spmig

# ------------------------------------------------------------
# PLOTTING
# ------------------------------------------------------------
def igrey(custom):
    return '''
    transp plane=23 | transp plane=12 |
    byte gainpanel=all %s |
    grey3 labelrot=n title="" flat=y frame1=120 frame2=200 frame3=200 point1=0.35
    ''' % (custom)

def wgrey(custom):
    return '''
    real | 
    transp plane=23 | transp plane=12 |
    byte gainpanel=all %s |
    grey3 labelrot=n title="" flat=y frame1=20 frame2=200 frame3=200
    ''' % (custom)

def tgrey(custom):
    return '''
    byte gainpanel=all %s |
    grey3 labelrot=n title="" flat=y frame1=320 frame2=200 frame3=200 point1=0.35
    ''' % (custom)

def reflector(formula,par):
    return '''
    math 
    n1=%d o1=%g d1=%g
    n2=%d o2=%g d2=%g output="%s"
    ''' % (par['nx'],par['ox'],par['dx'],
           par['ny'],par['oy'],par['dy'],formula)

# ------------------------------------------------------------
par = {
    'nz':160,  'dz':2.5,  'oz':0,
    'nx':400,  'dx':5.0,  'ox':0,
    'ny':400,  'dy':5.0,  'oy':0,
    'nt':5000, 'dt':0.0005,'ot':0, 'kt':201, 'f':20,
#
    'nw':1, 'ow':5,
    'nw':50,'ow':0.8, 'jw':2,
#    
    'verb':'y', 'eps':0.01, 'nrmax':1, 'dtmax':0.00005,
    'tmx':16,'tmy':16,'pmx':0,'pmy':0
    }
par['zmin']=par['oz']
par['zmax']=par['oz'] + (par['nz']-1) * par['dz']
par['xmin']=par['ox']
par['xmax']=par['ox'] + (par['nx']-1) * par['dx']
par['ymin']=par['oy']
par['ymax']=par['oy'] + (par['ny']-1) * par['dy']

par['xsou']=(par['xmin']+par['xmax'])/2
par['ysou']=(par['ymin']+par['ymax'])/2

# ------------------------------------------------------------
# REFLECTIVITY
# ------------------------------------------------------------
Flow('hor',None,reflector('302.5',par))

Flow('ref','hor',
     '''
     unif3 n1=%(nz)d d1=%(dz)g v00=1,2 |
     ai2refl | scale axis=123 |
     transp plane=12 | transp plane=23 | 
     put label1=x label2=y label3=z
     ''' % par)
Result('ref','ref',igrey('pclip=100'))

# ------------------------------------------------------------
# SLOWNESS
# ------------------------------------------------------------
Flow('slo','hor',
     '''
     unif3 n1=%(nz)d d1=%(dz)g v00=1000,1000 |
     math "output=1/input" |
     transp plane=12 | transp plane=23 | 
     put label1=x label2=y label3=z
     ''' % par)
Result('slo','slo',igrey('pclip=100'))


# ------------------------------------------------------------
# WAVELET
# ------------------------------------------------------------
Flow('wav',None,
     '''
     spike nsp=1 mag=1 k1=%(kt)d
     n1=%(nt)d d1=%(dt)g o1=0
     n2=1    d2=%(dx)g   o2=%(xsou)g
     n3=1    d3=%(dy)g   o3=%(ysou)g |
     ricker1 frequency=%(f)s |
     put label1=t label2=x label3=y 
     ''' % par )    
Result('wav','wav','graph title=" "')

Flow('sou','wav',
     '''
     fft1 |
     window squeeze=n n1=%d min1=%g j1=%d |
     pad beg2=%d n2out=%d |
     pad beg3=%d n3out=%d |
     put label1=w label2=x label3=y |
     transp plane=12 | transp plane=23 
     ''' % (par['nw'],par['ow'],par['jw'],
            par['nx']/2, par['nx'],
            par['ny']/2, par['ny']))    
Result('sou','sou',wgrey('pclip=100'))

# ------------------------------------------------------------
# MODELING
# ------------------------------------------------------------
spmig.model('wfl','slo','sou','ref',par)
Result('wfl','wfl',wgrey('pclip=100'))

Flow('dat','wfl',
     '''
     transp plane=23 | transp plane=12 | pad n1out=201 |
     fft1 inv=y 
     ''' % par )
Result('dat','dat',tgrey('pclip=100'))

# ------------------------------------------------------------
# MIGRATION
# ------------------------------------------------------------
#spmig.image('img','slo','sou','wfl',par)
#Result('img','img',igrey('pclip=100'))

for k in ('o','x','t'):
    img = 'img' + k

    if(k=='o'): par['misc']='itype=o'
    if(k=='x'): par['misc']='itype=x hsym=y nhx=20'
    if(k=='t'): par['misc']='itype=t nht=40 oht=-0.1 dht=0.005'

    spmig.image(img,'slo','sou','wfl',par)
    Result(img,img,'window n4=1 min4=0 n5=1 min5=0 | '
           + igrey('pclip=100'))

    if(k=='x' or k=='t'):
        off = 'off' + k
        Flow(off,img,'stack | transp | stack')
        Result(off,off,'grey pclip=100')

        ang = 'ang' + k
        if(k=='x'):
            Flow(ang,off,'radon adj=y p0=-2 np=200 dp=0.02')
            Result(ang,ang,'grey pclip=100 label2=tan')
        if(k=='t'):
            Flow(ang,off,'radon adj=y p0=0  np=300 dp=10')
            Result(ang,ang,'grey pclip=100 label2=nu')
End()




















