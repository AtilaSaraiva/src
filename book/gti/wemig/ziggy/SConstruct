from rsfproj import *
import sys
sys.path.append('../../Scons')
import wemig

# ------------------------------------------------------------
# MIGRATION parameters
# ------------------------------------------------------------
par = {
    'nw':400,'ow':1,'jw':1,
    'nw':1,  'ow':5,
    'nx':500,'ox':10925,'dx':150,
    'nt':1500,'ot':0,'dt':0.008,'kt':1,'ft':0,
    'ns':25, 'js':20, 'fs':0,
    'nh':100,
    #
    'verb':'y',
    'eps':0.01,
    'nrmax':5,
    'dtmax':0.00005,
    #   
    'tmx':16, 
    'tmy':0,
    'pmx':0,
    'pmy':0,
    #
    'xmin':10925, 'xmax':85775, 'zmin':6100, 'zmax':30000
    }
# ------------------------------------------------------------

# ------------------------------------------------------------
# from SGY to RSF
# ------------------------------------------------------------
data = 'sigsbee2a_nfs.sgy'
velo = 'sigsbee2a_migvel.sgy'

Fetch(data,'sigsbee')
Fetch(velo,'sigsbee')

Flow('zdata tzdata ./dhead ./bdhead',data,
     '''
     segyread
     tape=$SOURCE
     tfile=${TARGETS[1]}
     hfile=${TARGETS[2]}
     bfile=${TARGETS[3]}
     ''',stdin=0)
Flow('zvelo tzvelo ./vhead ./bvhead',velo,
     '''
     segyread
     tape=$SOURCE
     tfile=${TARGETS[1]}
     hfile=${TARGETS[2]}
     bfile=${TARGETS[3]}
     ''',stdin=0)

# ------------------------------------------------------------
# VELOCITY
# ------------------------------------------------------------
Flow('velo','zvelo','put d1=25 o2=10025 d2=37.5 label1=z label2=x')
Flow('s0','velo',
     '''
     window |
     math "output=1/input" |
     transp |
     spray axis=2 n=1 o=0 d=1 |
     put label2=y
     ''')
Flow('sd','s0','window squeeze=n n3=2 j3=244')
Flow('s1','s0','window squeeze=n      f3=244')

# ------------------------------------------------------------
# SHOTS
# ------------------------------------------------------------
# create sraw(t,o,s): o=full offset
Flow('ss','tzdata','dd type=float | headermath output="10925+fldr*150" | window')
Flow('oo','tzdata','dd type=float | headermath output="offset"         | window')
Flow('si','ss','math output=input/150')
Flow('oi','oo','math output=input/75')
Flow('os','oi si','cat axis=2 space=n ${SOURCES[1]} | transp | dd type=int')
Flow('sraw','zdata os',
     '''
     intbin head=${SOURCES[1]} xkey=0 ykey=1
     ''')
Flow('shot','sraw',
     '''
     put d2=75 d3=150 o3=10925 label1=t label2=o label3=s |
     mutter half=false t0=1.0 v0=6000
     ''')

# ------------------------------------------------------------
# CMPS
# ------------------------------------------------------------
# create mraw(t,h,m): h=half offset
Flow('mm',['oo','ss'],'math o=${SOURCES[0]} s=${SOURCES[1]} output=s+o/2-10925')
Flow('hh',['oo'     ],'math o=${SOURCES[0]}                 output=o/2')
Flow('mi','mm','math output=input/37.5')
Flow('hi','hh','math output=input/37.5')
Flow('mh','hi mi','cat axis=2 space=n ${SOURCES[1]} | transp | dd type=int')
Flow('craw','zdata mh',
     '''
     intbin head=${SOURCES[1]} xkey=0 ykey=1
     ''')
Flow('cmps','craw',
     '''
     window j2=4 j3=4 n3=500 |
     put d2=150 d3=150 o3=10925 label1=t label2=h label3=m |
     mutter half=true t0=0.25 v0=2250 |
     pad n2out=100 
     ''')

# ------------------------------------------------------------
# WAVELET
# ------------------------------------------------------------
Flow('wave',None,
     '''
     spike nsp=1 mag=1 k1=%(kt)d
     n1=%(nt)d d1=%(dt)g o1=%(ot)g |
     ricker1 frequency=9
         ''' % par )    
Result('wave','wave','graph')

# ------------------------------------------------------------

wemig.sinking(par)

wemig.profile(par)

wemig.result(par)

End()
