\title{Using IWAVE}
\author{William. W. Symes \thanks{The Rice Inversion Project,
Department of Computational and Applied Mathematics, Rice University,
Houston TX 77251-1892 USA, email {\tt symes@caam.rice.edu}.}}

\maketitle

\begin{abstract}
  IWAVE is a framework for time-domain regular grid finite difference
  and finite element methods. The current IWAVE package includes
  source code for component libraries and commands, and 
  examples of typical IWAVE acoustic modeling use cases. The
  examples are taken from a recent paper on error propagation for
  heterogeneous medium simulation using finite differences, and allow
  the user to replicate illustrations of the interface error effect
  which renders all FD methods effectively first-order accurate.  This
  paper gives a brief tour of the common IWAVE use cases illustrated
  in the package examples.
\end{abstract}

\section{Introduction}
Domain-specific simulation such as seismic modeling begs for
software re-use via modular design. All applications of this type have
the same structure: static fields are initialized, dynamic fields
updated, output extracted. A modular approach to code architecture is
implicit in this structure, and further specialization leads to even more opportunity
for code re-use via modular design. 
%The general topic of this paper, time-domain
%simulation on regular rectangular grids, presents specific openings
%for code re-use via abstraction: time steps may have internal
%structure which is repeated in a defined pattern, parallelism via
%domain decomposition may be computed from stencil shape information
%rather than hard-wired into the code, sampling rules for output
%buffering are simple to formulate and universal, and external data
%formats may be hidden behind uniform interfaces.

The software package described in these pages, IWAVE, takes advantage
of the aforementioned intrinsic modularity. IWAVE is open source
software for finite difference or finite element time-domain
simulation on regular rectangular grids, written exclusively in the
C99 dialect of ISO C. IWAVE is built around a core framework: that is,
a collection of separate software packages which together provide
essential services upon which applications may be built. These
service components completely define the interfaces to which
additional code must be written to formulate a complete
application. 

Along with the core framework, the current release
contains a complete finite difference time-domain acoustic modeling 
application, featuring
\begin{itemize}
\item simple parameter-driven job control;
\item modeling in 1D, 2D, and 3D space;
\item staggered grid schemes of orders 2 in time and 2k, k = 1, 2,..., in space
\item serial, loop-parallel, and task-parallel execution models,
  scaling to thousands of threads; 
\item flexible specification of PML absorbing or pressure-release
  boundary conditions on all faces of the simulation cube;
\item arbitrary source and receiver locations, and flexible point and array
  source specification including simultaneous source modeling (random,
  plane-wave,...)
\item standard input and output data formats (SEGY, RSF)
\end{itemize}
An isotropic elastic modeling application with similar features, and
built around the same core framework, has
been developed and will be included in a forthcoming release.

The primary purpose of this short paper is to illustrate the use of
IWAVE to calculate synthetic acoustic seismograms. To that end, the paper
describes a simple application - 2D synthetic seismogram generation
over a simple structural model of the sedimentary column - and
provides a set of demonstration examples (``demos'') which the reader
may reproduce, along with complete annotation of the files needed for
job specification and sample graphics derived from the results (as
well as commands to produce these graphics).

A secondary purpose is to supply the user with the means to
independently verify some of the claims in the paper by
\cite{SymesVdovina:09}, namely the existance of an error component in
synthetic data derived from strongly heterogeneous models, in addition
to the well-known grid dispersion error. The examples presented here
are essentially the same as those presented in that paper. By
installing IWAVE and running the demonstrations described here, the
reader may reproduce the computational content of \cite[]{SymesVdovina:09}.

IWAVE is both a standalone application, and a component of the
Madagascar software suite \cite[]{Madagascar}
The application package and the examples discussed
here (and indeed this paper itself) may be built either independently, or within Madagascar, as
explained in detail below.

IWAVE was used in a quality control role in the SEAM Phase I project -
see \cite{FehlerKeliher:2011} for an account, including discussion of
the many difficulties of large scale numerical simulation of seismograms.

The internal details of IWAVE are not discussed here, except insofar
as is necessary to explain the use of the main
commands. \cite{GeoPros:11} briefly describe the structure of the
IWAVE framework, with emphasis on its object-oriented design and the
resulting mechanisms for coupling modeling with optimization packages
to produce inversion applications. The IWAVE project web page \cite[]{IWAVE}
provides extensive reference material, and further information about
the design.

The paper begins with a brief review of the system of partial
differential equations solved (approximately) by IWAVE's acoustic
application, and the choice of finite difference method. The following
section presents the examples of
\cite{SymesVdovina:09}, along with some additional examples based on
the same distribution of mechanical parameters which shed light on the
impact of finite difference order on solution accuracy. Instructions
for recreating these examples follow. The paper ends with a brief
discussion of the prospects for improvements in performance and
accuracy in FD technology, and the evolutionary advantages flowing from the
modular, or object, orientation of IWAVE. Two appendices describe the
job parameters used in the examples, and download and install instructions.
 
\section{Acoustodynamics}
The IWAVE acoustics application is based on the pressure-velocity form of
acoustodynamics, consisting of two coupled first-order partial
differential equations:
\begin{eqnarray}
\label{awe}
\rho \frac{\partial \bv}{\partial t} &=& - \nabla p \\
\frac{1}{\kappa}\frac{\partial p}{\partial t} &=& -\nabla \cdot \bv + g
\end{eqnarray}
In these equations, $p(\bx,t)$ is the pressure (excess, relative to an
ambient equilibrium pressure), $\bv(\bx,t)$ is the particle velocity,
$\rho(\bx)$ and $\kappa(\bx)$ are the density and particle velocity
respectively. Bold-faced symbols denote vectors; the above formulation
applies in 1, 2, or 3D.

The inhomogeneous term $g$ represents externally supplied energy (a
``source''), via a defect in the acoustic constitutive relation. A
typical example is the {\em isotropic point source}
\[
g(\bx,t) = w(t) \delta(\bx-\bx_s)
\]
at source location $\bx_s$.

\cite{Vir:84} introduced finite difference methods based on this
formulation of acoustodynamics to the active source seismic
community. \cite{Vir:86} extended the technique to elastodynamics, and
\cite{Lev:88} demonstrated the use of higher (than second) order
difference formulas and the consequent improvement in dispersion
error.  IWAVE's acoustic application uses the principles introduced by
these authors to offer a suite of finite difference schemes, all
second order in time and of various orders of accuracy in space.

The bulk modulus and buoyancy (reciprocal density) are the natural
parameters whose grid samplings appear in the difference formulae. I will
display velocity and density instead in the examples below. IWAVE's acoustic application
converts velocity and density to bulk modulus and buoyancy as part of
the problem setup phase; the user may supply any equivalent combination of parameters.

\section{Examples based on a 2D dome model}

This simple 2D model embeds an anticline or dome in an otherwise
undisturbed package of layers. The velocity and density models are
depicted in Figures \ref{fig:vp} and \ref{fig:dn}. These
figures display sampled versions of the models with $\Delta x = \Delta
z = $ 5 m; the model fields are actually given analytically, and can
be sampled at any spatial rate.

\cite{SymesVdovina:09} use this model to illustrate the {\em
  interface error} phenomenon: the tendency, first reported by
\cite{Brown:84}, of all finite difference schemes for wave
propagation to exhibit first order error, regardless of formal order,
for models with material parameter discontinuities. 
Figure \ref{fig:data5m} exhibits a shot gather, computed with a (2,4) (= 2nd order in time,
4th order in space) staggered grid scheme, $\Delta
x = \Delta z = $ 5 m and an appropriate near-optimal time step, acquisition geometry as described in
caption. The same gather computed at different spatial sample rates
seem identical, at first glance, however in fact the sample rate has a considerable effect. Figures
\ref{fig:trace} and \ref{fig:wtrace} compare traces computed from models sampled
at four different spatial rates (20 m to 2.5 m), with proportional
time steps. The scheme used is formally 2nd order
convergent like the original 2nd order scheme suggested by
\cite{Vir:84}, but has better dispersion suppression due to the use of
4th order spatial derivative approximation. Nonetheless,
the figures clearly show the first order error, in the form of a
grid-dependent time shift, predicted by \cite{Brown:84}. 

Generally, even higher order approximation of spatial derivatives
yields less dispersive propagation error, which dominates the finite
difference error for smoothly varying material models. For
discontinuous models, the dispersive component of error is still
improved by use of a higher order spatial derivative approximation,
but the first order interface error eventually dominates as the grids
are refined. Figure \ref{fig:data5m8k} shows the same shot gather as
displayed earlier, with the same spatial and temporal sampling and
acquisition geometry, but computed via the (2,8) (8th order in space)
scheme. The two gather figures are difficult to disinguish. The trace
details (Figures \ref{fig:trace8k}, \ref{fig:wtrace8k}) show clearly
that while the coarse grid simulation is more accurate than the (2,4)
result, but the convergence rate stalls out to 1st order as the grid
as refined, and for fine grids the (2,4) and (2,8) schemes produce
very similar results: dispersion error has been suppressed, and what
remains is due to the presence of model discontinuities.

See
\cite[]{SymesVdovina:09} for more examples, analysis, and discussion,
also \cite[]{FehlerKeliher:2011} for an account of consequences for quality control in
large-scale simulation.

\section{Creating the examples - running IWAVE applications}
IWAVE builds with SConstruct ({\tt www.scons.org}), either as an
independent package or as part of Madagascar \cite[]{Madagascar}. For
download and install instructions, see Appendix B and sources cited
there.

The examples are also scripted with SConstruct. Providing scripts
makes the results convenient to rebuild, and I'll first explain how to do
that. I also explain how one uses the basic IWAVE commands from
the command line, outside the context of these examples.

\subsection{Scripted Examples}
To build the intermediate data and figures for  the examples described
here,,
\begin{itemize}
\item install IWAVE, either within Madagascar or standalone. I will use  {\tt \$TOP} to denote
  the path to the top-level IWAVE directory for the standalone
  version, or to the top-level Madagascar build directory.
\item for the standalone version of IWAVE, the examples build with the
  assistance of SU, which must also be installed. The choice of word
  order in IWAVE and SU must be compatible: either the XDR option must
  be set in both, or in neither. Default for both IWAVE and SU is native binary
  word order. To set the XDR option for SU, follow instructions in {\tt
    Makefile.config}; for IWAVE, configure compilation with the flag
  {\tt -DSUXDR}, as described in Appendix B and \cite[]{IWAVE}.
\item the Madagascar version builds with entirely with Madagascar commands,
  so no external package need be supplied.
\item build data and figures: in the standalone version of IWAVE,
\begin{itemize}
  \item {\tt cd \$TOP/demo/data}
\item {\tt scons}
\end{itemize},
or, in the Madagascar version,
\begin{itemize}
\item {\tt cd \$TOP/book/trip/iwave/data}
\item {\tt scons}
\item {\tt scons lock -f madfig.sc}
\end{itemize}
(the last step is necessary only if you wish to build a copy of this
paper from source - it archives the newly created figures and makes
them available to the paper build, as described in the next bullet)
\item to (re)build this paper, build the figures first. Then in the standalone version,
\begin{itemize}
\item {\tt cd \$TOP/papers}
\item {\tt scons}
\end{itemize} 
or, in the Madagascar version,
\begin{itemize}
\item {\tt cd \$TOP/book/iwave}
\item {\tt scons}
\end{itemize}

\end{itemize}
Note that the finest (2.5 m) grid consists of roughly 10 million
gridpoints. Consequently the modeling runs collectively take a
considerable time, from a minutes to a substantial fraction of an hour
depending on platform,
on a single thred. This example is computationally large enough that
parallelism via domain decomposition is worthwhile. IWAVE is designed
from the ground up to support parallel computation; a companion report
will demonstrate parallel use of IWAVE.

Inspection of the {\tt SConstruct} file in {\tt data} will show that
the modeling tool used is {\tt \$TOP/asg/main/asg.x}, the IWAVE
acoustic modeling command (in Madagascar Flows, this command is referenced
simply as {\tt asg}, which is an alias for {\tt \$RSFROOT/bin/sfasg},
where {\tt \$RSFROOT} is an alias for the Madagascar install
directory). Input data is supplied by a parameter list, stored in a file.
The model-building tool {\tt standardmodel} builds the velocity and
density model files, and works the same way - many of the parameter
files in the {\tt data} directory are input for this tool.

Both the IWAVE acoustic modeling command and {\tt standardmodel}
self-doc in the style of SU or Madagascar. For modeling command, the
self-doc is deprecated in favor of the web documentation mentioned
above.

\subsection{Using IWAVE commands in other contexts}
To use the acoustic modeling command outside of the scripted examples,
the user needs to create a parameter list.  The job parameters for the
use case of the scripted examples are described in detail in Appendix
A. The html documentation \cite[]{IWAVE} describes other parameter
choices, corresponding the wide variety of use cases accommodated by
this application. Key parameters are pathnames to the model data files
(velocity and density, or equivalent parameters) and to seismic trace
files containing prototype output trace headers and (possibly) source
pulse traces, and output traces on normal completion.

The acoustic application currently expect model data files in the RSF
format of Madagascar \cite[]{Madagascar}. The scripts use {\tt
  standardmodel} to store gridded model data in RSF format, and data
from other sources will need conversion to this format. An RSF data
set consists of two files, an ascii header (grid metadata) file and a
flat binary data file. The data set is referenced by the header file
name; one of the parameters listed in the header file is the pathname
of the binary data file, with key {\tt in}. The header file is small
and easily created by hand with an editor, if necessary. Many archival
data formats make the grid sample values available as a flat binary
file - this is true for instance of the gridded models output by GOCAD
({\tt www.gocad.org}), for which the {\tt vo} files contain virtually
the same information as (so may easily be translated to) RSF header
files in ascii form, and the {\tt vodat} files are flat binary files
which may be used unaltered as RSF binary files.

By convention, the dimension of the problem is that of the primary
model grid, that associated with the bulk modulus data, if it is given, or
failing that, the velocity. This grid is also the primary grid of the
simulation: that is, the space steps used in the finite difference
method are precisely those of the bulk modulus, or velocity, data.
Thus the choice of simulation grid is made externally to IWAVE.

The IWAVE acoustic application uses specific internal scales - m/ms
for velocity, g/cm$^3$ for density, and corresponding units for other
parameters. To ensure that data in other (metric) units are properly
scaled, the RSF header file should specify a value for the {\tt scale}
key, equal to the power of 10 by which the data should be multiplied
on being read into the application, to convert to the internal
scale. For example, if velocities are given in m/s, the header file
should include the line {\tt scale = -3}. In forthcoming releases,
this device will be deprecated in favor of explicit unit
specifications.

One of IWAVE's design criteria is that acquisition geometry parameters
should have no a priori relation to the computational grid geometry:
source and receiver locations may be specified anywhere in Euclidean
space. The current release accepts a SU (SEGY without reel header)
format data file specified by the {\tt hdrfile} keyword: the trace
headers in this file are those of the output (pressure) traces. Units of
length and time are m and ms respectively, consistent with other
internal unit choices. The example scripts use SU or Madagascar
commands to create these prototype trace files.

The source pulse may be specified as a Ricker wavelet, or read from
another SU file, whose pathname is the value associated with the {\tt
  source} keyword. Source calibrarion is regulated by several other
keywords, as described in Appendix A. In the examples, the Ricker
option is used, simply because it avoids some small incompatibilities
between SU and Madagascar filter implementations which would otherwise
prevent the standalone and Madagascar versions of the examples from
generating the same pulses, and therefore prevent the results from
matching precisely. 

Because the number of
parameters describing a simulation task is reasonably large (roughly
15 in a simple case), the job parameters for IWAVE's acoustic
application are most conveniently stored in a file, passed to the
application via a command line parameter. Denoting by {\tt \$ASG}
either {\tt \$TOP/asg/main/asg.x} for the standalone implementation,
or {\tt \$RSFROOT/bin/sfasg} for the Madagascar install, the proper
command takes the form
\begin{verbatim}
[prefix] $ASG par=[parfile].
\end{verbatim}
Here {\tt [prefix]} is any necessary command prefix, eg. {\tt mpirun
  ...}, and {\tt [parfile]} is the pathname of the parameter file. On
successful completion, the output data will be stored in a file (SU
format) indicated by the key {\tt datafile} in the parameter file.

\section{Discussion and Conclusion}
The rather large and only slowly disappearing error revealed by the
examples from \cite{SymesVdovina:09} suggests strong limits for the
accuracy of regular grid finite difference methods. Finite element
methods suffer from the same limitations: accurate solution of
acoustodynamic or elastodynamic problems appears to demand
interface-fitted meshed \cite[]{Cohen:01}, with the attendant increase
in code and computational complexity.

The situation may not be so bleak, however. For one special case,
namely constant density acoustics, 
\cite{Terentyev:09} show that a regular grid finite difference method,
derived from a regular grid Galerkin finite element method, has
accuracy properties one would expect in homogeneous media (second
order convergence, reduction of grid dispersion through higher order
space differencing) even for discontinuous models: the interface error
effect is attenuated. This type of result actually goes quite far back
in computational geophysics (see for example \cite{Muiretal:92}),
though theoretical support has been slower in coming.

Pure regular grid methods cannot take advantage of changes in average
velocity across the model, and concommitant changes in
wavelength. Coupling of local regular grids is possible, however, and
can yield substantial computational efficiency through grid coarsening
in higher velocity zones - see \cite{moczoetal:06}. IWAVE already
accommodates multiple grids (in domain decomposition parallelism), and
extension to incommensurable multiple grids would be a significant
change, but in principle
straightforward. The use of logically rectangular but
geometrically irregular (``stretched'') grids is completely
straightforward, on the other hand. 

These and other extensions, both past and future, are eased by the
reusability designed into the IWAVE core framework. This design has produced
reasonably well-performing and easy-to-use applications, and has proven
extensible to new models and schemes. Moreover, as explained by
\cite{GeoPros:11}, the object-oriented design of IWAVE dovetails with
similarly designed optimization software to support the construction
of waveform inversion software. The inversion applications resulting
from this marriage inherit the features of IWAVE - parallel execution,
high-order stencils, efficient boundary conditions, simple job control
- without requiring that these aspects be reworked in the code extensions. 

The IWAVE acoustic application supports many use cases beyond those of
the scripted examples, such as various modes of parallel execution,
array sources, movie output, 3D modeling, and many others described in
the documentation.
It is hoped that the brief overview above, the detailed description of the example
parameters given in Appendix A, and the much more extensive
description of use cases in \cite[]{IWAVE} will enable the reader to
constuct a wide variety of synthetic data sets with relative ease.

\section{Acknowledgements}
IWAVE has been a team effort: the original design of the core
framework is due to Igor Terentyev, and Tanya Vdovina, Dong Sun, Marco
Enriquez, and Xin Wang have each made major contributions.
Development of IWAVE was supported by the SEG Advanced Modeling (SEAM)
project, by the National Science Foundation under awards 0620821 and
0714193, and by the sponsors of The Rice Inversion Project. The IWAVE
project owes a great deal to several open source seismic software
packages (Seismic Un*x, SEPlib, Madagascar), debts which we gratefully
acknowledge. The author wishes to record his special gratitude to
Sergey Fomel, the architect of Madagascar, for his inspiring ideas and
his generous and crucial help in the integration of IWAVE into Madagascar.

\bibliographystyle{seg}
\bibliography{masterref}


