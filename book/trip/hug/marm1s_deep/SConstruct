#############################################################################
###################### COMMON DEFINITIONS - DO NOT ALTER ####################
#############################################################################
from rsf.proj import *
from batch import getFlowSignature
import os
thispath        = os.getcwd()
#############################################################################
###################### END COMMON DEFINITIONS ###############################
#############################################################################

######################## LOCAL DEFINITIONS ##################################

######## abbreviations for commands used in flows - put these first, if
######## you use abbreviations
# example:
#          CWPROOT         = os.getenv('CWPROOT')
#          ...
#          sunull          = os.path.join(CWPROOT,'bin/sunull')
RSFSRC          = os.getenv('RSFSRC')
towed_array     = os.path.join(RSFSRC,'trip/iwave/trace/main/towed_array.x')
acd             = os.path.join(RSFSRC,'trip/iwave/acd/main/acd.x')
acdcgne         = os.path.join(RSFSRC,'trip/iwave/acd/main/acdcgne.x')
acdlbfgs        = os.path.join(RSFSRC,'trip/iwave/acd/main/acdlbfgs.x')
acdiva          = os.path.join(RSFSRC,'trip/iwave/acd/main/acdiva.x')
acdds_grad      = os.path.join(RSFSRC,'trip/iwave/acd/main/acdds_grad.x')
acddscheb_grad  = os.path.join(RSFSRC,'trip/iwave/acd/main/acddscheb_grad.x')
acdadjtest      = os.path.join(RSFSRC,'trip/iwave/acd/main/acdadjtest.x')
helm            = os.path.join(RSFSRC,'trip/iwave/helm/main/helm.x')

fetches = {
    'line100m.su' : ['marmousi', 'http://www.trip.caam.rice.edu'],
    'hdr6km.su' : ['marmousi', 'http://www.trip.caam.rice.edu'],
    'wavelet_base.su' : ['marmousi', 'http://www.trip.caam.rice.edu'],
    'velocity.HH' : ['marmousi', 'http://www.trip.caam.rice.edu']
}
for file in fetches.keys():
    Fetch(file,fetches[file][0],server=fetches[file][1])   

Flow('ocean',None,'makevel n1=141 d1=24 n2=444 d2=24 o1=0 o2=0 v000=1.5 | put data_type=vel data_format=native_float label1=Depth unit1=m label2=Position uni2=m unit=m/ms esize=4',stdin=0) 
Flow('vel24base','velocity.HH','dd form=native | window j1=6 j2=6')
Flow('vext','vel24base','window f2=383 n2=1 | spray axis=2 d=24 n=60')
Flow('extv',['vel24base', 'vext'], 'cat axis=2 d=24 ${SOURCES[1]}')
Flow('vel24',['ocean','extv'],'window n1=15 f1=0 | cat axis=1 d=24 ${SOURCES[1]}') 
#Flow('sedmts',['vel24','ocean'],'add mode=a scale=1,-1 ${SOURCES[1]}')
#Flow('sedhsm','sedmts','cp ${SOURCES[0]} ${TARGETS[0]}; ' + helm + ' in=${SOURCES[0]} out=${TARGETS[0]} datum=400 power=-1 bc=0 scale1=5.e+5 scale2=5.e+5',stdin=0,stdout=-1)
#Flow('vel24sm',['ocean','sedhsm'],'add mode=1 scale=1,1 ${SOURCES[1]}')
Flow('vel24sm','vel24','smooth rect1=5 rect2=5 repeat=10')
Flow('vel24sm2','vel24','smooth rect1=5 rect2=5 repeat=2')
Flow('vel24sm4','vel24','smooth rect1=5 rect2=5 repeat=4')

Flow('vel24big','vel24','smooth rect1=10 rect2=10 repeat=1')

Flow('csq24','vel24','add mode=p ${SOURCES[0]} |put data_type=csq')
Flow('csq24sm','vel24sm','add mode=p ${SOURCES[0]} |put data_type=csq')
Flow('csq24sm2','vel24sm2','add mode=p ${SOURCES[0]} |put data_type=csq')
Flow('csq24big','vel24big','add mode=p ${SOURCES[0]} |put data_type=csq')
Flow('csq24noah','ocean','add mode=p ${SOURCES[0]} |put data_type=csq')


Flow('dcsq24', ['csq24', 'csq24sm2'],'add mode=a scale=1,-1 < csq24.rsf csq24sm2.rsf |window min1=180| sfpad beg1=8') 
Flow('csqext.rsf','csq24sm.rsf', 'sfcat csq24sm.rsf csq24sm.rsf d=1.0 o=0.0 | sfput id1=0 id2=1 id3=3 dim=2 gdim=3',stdin=0)
Flow('dcsqext.rsf','dcsq24.rsf', 'sfcat dcsq24.rsf dcsq24.rsf d=1.0 o=0.0 | sfput id1=0 id2=1 id3=3 dim=2 gdim=3',stdin=0)

# add source coordinates from hdrfile to source AND receiver 
# coordinates from wavelet to create "dressed" wavelet for array
# source option in iwave. Note that iwave reads a source GATHER by
# detecting new source coordinates (sx, sy, selev) but assigns source
# trace GRID POSITIONS in the array by receiver coordinates (gx, gy, 
# gelev). The towed array app sets these coordinates up so that each 
# shot may have an array of sources, with the source traces in the 
# same position relative to the data source coordinates - hence 
# "towed_array".

# use naming convention: time series stored in wavelet_base, 
# headers for experiment foo stored in hdrfoo.su, wavelet in
# waveletfoo.su

for foo in ['line100m', 'hdr6km']:
    Flow('wavelet_' + foo + '.su', ['wavelet_base.su', foo + '.su'],
         towed_array + 
         '''
         data=${SOURCES[1]} 
         src=${SOURCES[0]} 
         towed=${TARGETS[0]}
         ''',
         stdin=0, stdout=0)

# simulation - one shot
Flow('shot6km.su',['wavelet_hdr6km.su','csq24.rsf','hdr6km.su'],
     '/bin/cp ../hdr6km.su ../shot6km.su; ' + 
     acd  + ' ' +  
     '''
     deriv=0 adjoint=0 order=2 cfl=0.5 cmin=1.0 cmax=6.0 sampord=1 
     csq=../csq24.rsf source=../wavelet_hdr6km.su 
     data=../shot6km.su 
     ''',
     stdin=0,stdout=0,workdir='shot6km.work')

# simulation - one shot, smoothed velo
Flow('shot6kmsm2.su',['wavelet_hdr6km.su','csq24sm2.rsf'],
        '/bin/cp ../hdr6km.su ../shot6kmsm2.su; ' +
        acd  + ' ' +  
	'''
	deriv=0 adjoint=0 order=2 cfl=0.5 cmin=1.0 cmax=6.0 sampord=1 
	csq=../csq24sm2.rsf source=../wavelet_hdr6km.su 
        data=../shot6kmsm2.su 
	''',
	stdin=0,stdout=0,workdir='shot6kmsm2.work')

# simulation - one shot, smoothed velo
Flow('shot6kmsm4.su',['wavelet_hdr6km.su','csq24sm4.rsf'],
        '/bin/cp ../hdr6km.su ../shot6kmsm4.su; ' +
        acd  + ' ' +  
	'''
	deriv=0 adjoint=0 order=2 cfl=0.5 cmin=1.0 cmax=6.0 sampord=1 
	csq=../csq24sm4.rsf source=../wavelet_hdr6km.su 
        data=../shot6kmsm4.su 
	''',
	stdin=0,stdout=0,workdir='shot6kmsm4.work')

# simulation - one shot, smoothed velo
Flow('shot6kmsm.su',['wavelet_hdr6km.su','csq24sm.rsf'],
        '/bin/cp ../hdr6km.su ../shot6kmsm.su; ' +
        acd  + ' ' +  
	'''
	deriv=0 adjoint=0 order=2 cfl=0.5 cmin=1.0 cmax=6.0 sampord=1 
	csq=../csq24sm.rsf source=../wavelet_hdr6km.su 
        data=../shot6kmsm.su 
	''',
	stdin=0,stdout=0,workdir='shot6kmsm.work')

# simulation - one shot, smoothed velo
Flow('shot6kmbig.su',['wavelet_hdr6km.su','csq24big.rsf'],
        '/bin/cp ../hdr6km.su ../shot6kmbig.su; ' +
        acd  + ' ' +  
	'''
	deriv=0 adjoint=0 order=2 cfl=0.5 cmin=1.0 cmax=6.0 sampord=1 
	csq=../csq24big.rsf source=../wavelet_hdr6km.su 
        data=../shot6kmbig.su 
	''',
	stdin=0,stdout=0,workdir='shot6kmbig.work')

# simulation - one shot, ocean
Flow('shot6kmnoah.su',['wavelet_hdr6km.su','csq24noah.rsf'],
        '/bin/cp ../hdr6km.su ../shot6kmnoah.su; ' +
        acd  + ' ' +  
	'''
	deriv=0 adjoint=0 order=2 cfl=0.5 cmin=1.0 cmax=6.0 sampord=1 
	csq=../csq24noah.rsf source=../wavelet_hdr6km.su 
        data=../shot6kmnoah.su 
	''',
	stdin=0,stdout=0, workdir='shot6kmnoah.work')

# Born simulation - one shot, big
Flow('born6kmbig.su',['wavelet_hdr6km.su','csq24big.rsf','dcsq24.rsf'],
        '/bin/cp ../hdr6km.su ../born6kmbig.su; ' + 
        acd  + ' ' +  
	'''
	deriv=1 adjoint=0 order=2 cfl=0.5 cmin=1.0 cmax=6.0 sampord=1 
	csq=../csq24big.rsf csq_d1=../dcsq24.rsf source=../wavelet_hdr6km.su 
        data=../born6kmbig.su
	''',
	stdin=0,stdout=0, workdir='born6kmbig.work')

# Born simulation - one shot
Flow('born6km.su',['wavelet_hdr6km.su','csq24sm.rsf','dcsq24.rsf'],
        '/bin/cp ../hdr6km.su ../born6km.su; ' + 
        acd  + ' ' +  
	'''
	deriv=1 adjoint=0 order=2 cfl=0.5 cmin=1.0 cmax=6.0 sampord=1 
	csq=../csq24sm.rsf csq_d1=../dcsq24.rsf source=../wavelet_hdr6km.su 
        data=../born6km.su
	''',
	stdin=0,stdout=0, workdir='born6km.work')

# Born inversion - one shot
Flow(['icsq6km.rsf', 'icsq6km_mut.su', 'icsq6km_est.su', 'icsq6km_res.su'], ['born6km.su', 'wavelet_hdr6km.su', 'csq24sm.rsf'],
        'add < ../csq24.rsf > ../icsq6km.rsf scale=0.0 && ' +
        acdcgne  + ' ' +  
	'''
	order=2 cfl=0.5 cmin=1.0 cmax=6.0 sampord=1 nsnaps=20 
	csq=../csq24.rsf rcsq=../csq24sm.rsf 
	icsq=../icsq6km.rsf source=../wavelet_hdr6km.su 
        data=../born6km.su outfile=cgne.out 
	ResidualTol = 0.01 GradientTol = 0.01
        MaxIter = 20 dataest = ../icsq6km_est.su datares = ../icsq6km_res.su
	datamut=../icsq6km_mut.su mute_slope=0.7 mute_zotime=0 mute_width=200
	''',
	stdin=0,stdout=0,workdir='icsq6km.work')

# Born inversion - one shot, homog bg
Flow(['icsq6kmnoah.rsf', 'icsq6kmnoah_est.su', 'icsq6kmnoah_res.su'],['born6km.su', 'wavelet_hdr6km.su', 'csq24noah.rsf'],
        'add < ../csq24.rsf > ../icsq6kmhom.rsf scale=0.0 && ' +  
	acdcgne  + ' ' +  
	'''
	order=2 cfl=0.5 cmin=1.0 cmax=6.0 sampord=1 nsnaps=20 
	csq=../csq24.rsf rcsq=../csq24noah.rsf 
	icsq=../icsq6kmnoah.rsf source=../wavelet_hdr6km.su 
        data=../born6km.su outfile=cgne.out 
	ResidualTol = 0.01 GradientTol = 0.01
        MaxIter = 20 dataest = ../icsq6kmnoah_est.su datares = ../icsq6kmnoah_res.su
	datamut=mut.su mute_slope=0.7 mute_zotime=0 mute_width=200
	''',
	stdin=0,stdout=0,workdir='icsq6kmnoah.work')

# Born inversion - one shot, no mute
Flow(['icsq6kmnm.rsf', 'icsq6kmnm_est.su', 'icsq6kmnm_res.su'],['born6km.su', 'wavelet_hdr6km.su', 'csq24sm.rsf'],
        'add < ../csq24.rsf > ../icsq6km.rsf scale=0.0 && ' +
        acdcgne  + ' ' +  
	'''
	order=2 cfl=0.5 cmin=1.0 cmax=6.0 sampord=1 nsnaps=20 
	csq=../csq24.rsf rcsq=../csq24sm.rsf 
	icsq=../icsq6kmnm.rsf source=../wavelet_hdr6km.su 
        data=../born6km.su outfile=cgne.out 
	ResidualTol = 0.01 GradientTol = 0.01
        MaxIter = 20 dataest = est.su datares = res.su
	datamut=mut.su mute_slope=0.0 mute_zotime=0 mute_width=200
	''',
	stdin=0,stdout=0,workdir='icsq6kmnm.work')

# Born inversion - one shot, homog bg, no mute
Flow(['icsq6kmnoahnm.rsf', 'icsq6kmnoahnm_est.su', 'icsq6kmnoahnm_res.su'], ['born6km.su', 'wavelet_hdr6km.su', 'csq24noah.rsf'],
        'add < ../csq24.rsf > ../icsq6kmhom.rsf scale=0.0 && ' +  
	acdcgne  + ' ' +  
	'''
	order=2 cfl=0.5 cmin=1.0 cmax=6.0 sampord=1 nsnaps=20 
	csq=../csq24.rsf rcsq=../csq24noah.rsf 
	icsq=../icsq6kmnoahnm.rsf source=../wavelet_hdr6km.su 
        data=../born6km.su outfile=cgne.out 
	ResidualTol = 0.01 GradientTol = 0.01
        MaxIter = 20 dataest = est.su datares = res.su
	datamut=mut.su mute_slope=0.0 mute_zotime=0 mute_width=200
	''',
	stdin=0,stdout=0,workdir='icsq6kmnoahnm.work')

# pre-cooked exes
exe_serial  = {}
exe_getafix = {'platf':'mpi', 'ppn':'16'}
exe_stampede_4hr = {'platf':'stampede','nodes':'2','ppn':'16','wall':'04:00:00'}
exe_stampede_10min = {'platf':'stampede','nodes':'2','ppn':'16','wall':'00:10:00'}
# choose

jobs = [
        { 'job': 'born100m',
          'pre': '/bin/cp ../hdr100m.su ../born100m.su',
          'src': ['hdr100m.su', 'wavelet_line100m.su', 'csqsm.rsf', 'dcsq.rsf'],
          'tgt': ['born100m.su'],
          'cmd': acd + ' ' + 
		 'deriv=1 adjoint=0 order=2 cfl=0.5 cmin=1.0 cmax=6.0 sampord=1 ' +
		 'csq=../csqsm.rsf csq_d1=../dcsq.rsf source=../wavelet_line100m.su ' +
		 'data=../born100m.su partask=' +
	 	 getThreads(exe_stampede_10min),
          'exe': exe_stampede_10min
        },
        { 'job': 'ds_grad_100m_2_80pct',
          'src': ['born100m.su', 'wavelet_line100m.su', 'csqsm.rsf', 'csq.rsf'],
          'tgt': ['ds100m_2_80pct.rsf'],
          'pre': 'spray < ../csq.rsf axis=3 n=60 d=1.0 o=0.0| put dim=2 gdim=3 id1=0 id2=1 id3=3 ' +
		 '| add scale=1.0 > ../ds100m_2_80pct.rsf && ' +
		 'add < ../csqsm.rsf ../csqhom.rsf scale=0.8,0.2 > ../csq80pct.rsf && ' +
		 'add < ../csqsm.rsf > ../csq_end100m.rsf scale=1.1 && ' +
		 'add < ../csqsm.rsf > ../grad100m_2_80pct.rsf scale=0.0 && ' +
		 'add < ../ds100m_2_80pct.rsf > ../nres_2_80pct.rsf scale=0.0',
          'cmd': acddscheb_grad + ' ' + 
		 'order=2 cfl=0.5 cmin=1.0 cmax=6.0 sampord=1 nsnaps=20 ' +
                 'mute_slope=0.67 mute_zotime=0.0 mute_width=300 ' +
        	 'csq=../csq.rsf csqext=../ds100m_2_80pct.rsf ' +
		 'csq_beg=../csq80pct.rsf ' +
		 'csq_end=../csq_end100m.rsf ' +
        	 'reflectivity=../ds100m_2_80pct.rsf ' +
		 'source=../wavelet_line100m.su ' +
		 'grad=../grad100m_2_80pct.rsf ' +
		 'normalres=../nres_2_80pct.rsf ' +
        	 'data=../born100m.su ' +
		 'outfile=dsgrad.out Nhval=0 ' +
        	 'MaxIter = 100 gamma=0.04 epsilon=0.0001 alpha=1.1 ' +
		 'dataest = est.su datares = res.su ' +
		 'DSWeight=0.01 partask=' +
		 getThreads(exe_stampede_4hr),
          'exe': exe_stampede_4hr
        },
        { 'job': 'ds_grad_100m_cg_80pct',
          'src': ['born100m.su', 'wavelet_line100m.su', 'csqsm.rsf', 'csq.rsf'],
          'tgt': ['ds100m_cg_80pct.rsf'],
          'pre': 'spray < ../csq.rsf axis=3 n=60 d=1.0 o=0.0| put dim=2 gdim=3 id1=0 id2=1 id3=3 ' +
		 '| add scale=1.0 > ../ds100m_cg_80pct.rsf && ' +
		 'add < ../csqsm.rsf ../csqhom.rsf scale=0.8,0.2 > ../csq80pct.rsf && ' +
		 'add < ../csqsm.rsf > ../csq_end100m.rsf scale=1.1 && ' +
		 'add < ../csqsm.rsf > ../grad100m_cg_80pct.rsf scale=0.0 && ' +
		 'add < ../ds100m_cg_80pct.rsf > ../nres_cg_80pct.rsf scale=0.0',
          'cmd': acdds_grad + ' ' + 
		 'order=2 cfl=0.5 cmin=1.0 cmax=6.0 sampord=1 nsnaps=20 ' +
                 'mute_slope=0.67 mute_zotime=0.0 mute_width=300 ' +
        	 'csq=../csq.rsf csqext=../ds100m_cg_80pct.rsf ' +
		 'csq_beg=../csq80pct.rsf ' +
		 'csq_end=../csq_end100m.rsf ' +
        	 'reflectivity=../ds100m_cg_80pct.rsf ' +
		 'source=../wavelet_line100m.su ' +
		 'grad=../grad100m_cg_80pct.rsf ' +
		 'normalres=../nres_cg_80pct.rsf ' +
        	 'data=../born100m.su ' +
		 'outfile=dsgrad.out Nhval=0 ' +
        	 'MaxIter = 200 ResidualTol=0.01 GradientTol=0.001 ' +
		 'dataest = est.su datares = res.su ' +
		 'DSWeight=0.01 partask=' +
		 getThreads(exe_stampede_4hr),
          'exe': exe_stampede_4hr
        },
        { 'job': 'ds_grad_100m_2_00pct',
          'src': ['born100m.su', 'wavelet_line100m.su', 'csqsm.rsf', 'csq.rsf'],
          'tgt': ['ds100m_2_00pct.rsf'],
          'pre': 'spray < ../csq.rsf axis=3 n=60 d=1.0 o=0.0| put dim=2 gdim=3 id1=0 id2=1 id3=3 ' +
		 '| add scale=1.0 > ../ds100m_2_00pct.rsf && ' +
		 'add < ../csqsm.rsf ../csqhom.rsf scale=0.0,1.0 > ../csq00pct.rsf && ' +
		 'add < ../csqsm.rsf > ../csq_end100m.rsf scale=1.1 && ' +
		 'add < ../csqsm.rsf > ../grad100m_2_00pct.rsf scale=0.0 && ' +
		 'add < ../ds100m_2_00pct.rsf > ../nres_2_00pct.rsf scale=0.0',
          'cmd': acddscheb_grad + ' ' + 
		 'order=2 cfl=0.5 cmin=1.0 cmax=6.0 sampord=1 nsnaps=20 ' +
                 'mute_slope=0.67 mute_zotime=0.0 mute_width=300 ' +
        	 'csq=../csq.rsf csqext=../ds100m_2_00pct.rsf ' +
		 'csq_beg=../csq00pct.rsf ' +
		 'csq_end=../csq_end100m.rsf ' +
        	 'reflectivity=../ds100m_2_00pct.rsf ' +
		 'source=../wavelet_line100m.su ' +
		 'grad=../grad100m_2_00pct.rsf ' +
		 'normalres=../nres_2_00pct.rsf ' +
        	 'data=../born100m.su ' +
		 'outfile=dsgrad.out Nhval=0 ' +
        	 'MaxIter = 100 gamma=0.04 epsilon=0.0001 alpha=1.1 ' +
		 'dataest = est.su datares = res.su ' +
		 'DSWeight=0.01 partask=' +
		 getThreads(exe_stampede_4hr),
          'exe': exe_stampede_4hr
        },
]


Result('vel24', 'vel24', 'put label1=Depth unit1=m label2=Distance unit2=m label="V\_p\_" unit="m\_/ms\_" | grey color=c mean=y title="Flooded Marmousi" scalebar=y barreverse=y')

Result('vel24m', 'vel24sm', 'put label1=Depth unit1=m label2=Distance unit2=m label="V\_p\_" unit="m\_/ms\_" | grey color=c mean=y title="Smoothed, Flooded Marmousi" scalebar=y barreverse=y')

Result('wavelet','wavelet_base.su', 'suread endian=0 read=data | put label1=Time label2=Pressure unit1=s unit2=GPa title="Gaussian deriv fpeak=6 Hz" unit="GPa" |sfgraph')

Result('shot6km','shot6km.su', 'suread endian=0 read=data | put label1=Time label2=Distance d2=0.025 o2=0 unit1=s unit2=km title="x\_s\_=6 km" label="Pressure" unit="GPa" | grey scalebar=y barreverse=y')

Result('shot6kmsm','shot6kmsm.su', 'suread endian=0 read=data | put label1=Time label2=Distance d2=0.025 o2=0 unit1=s unit2=km title="x\_s\_=6 km" label="Pressure" unit="GPa" | grey scalebar=y barreverse=y')

Result('shot6kmnoah','shot6kmnoah.su', 'suread endian=0 read=data | put label1=Time label2=Distance d2=0.025 o2=0 unit1=s unit2=km title="x\_s\_=6 km" label="Pressure" unit="GPa" | grey scalebar=y barreverse=y')

Result('born6km','born6km.su', 'suread endian=0 read=data | put label1=Time label2=Distance d2=0.025 o2=0 unit1=s unit2=km title="x\_s\_=6 km" label="Pressure" unit="GPa" | grey scalebar=y barreverse=y')




End()
