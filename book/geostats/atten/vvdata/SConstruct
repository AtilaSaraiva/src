# Spatial energy spectrum for 2-D fluctuations
# 
# May 2007
#
# Thomas Jules Browaeys 
# Bureau of Economic Geology
# University of Texas at Austin
# mailto:jules.browaeys@beg.utexas.edu


from rsfproj import *
from math import pi

private = {'login':os.environ.get('BEG_LOGIN'),
            'password':os.environ.get('BEG_PASSWORD'),
            'server':os.environ.get('BEG_SERVER')}


# Clipping parameters
pcb = {'fzc':0.0025, 'bvv':.1, 'fm':0., 'fpx':0.0025, 'fpz':0.15, 'sm':0., 'spx':70., 'spz':20.}


# Crossline
pgrid = {'nz':609, 'oz':4., 'dz':2., 'nx':521, 'ox':272., 'dx':17.}
# VP
#dfile = 'coronation_xl590_vp.rsf'
#pcb['bva'] = 3200.
# VS
dfile = 'coronation_xl590_vs.rsf'
pcb['bva'] = 1400.

# Zooming window
pgrid['ozw'] = 200.
pgrid['nzw'] = 151
pgrid['oxw'] = 952.
pgrid['nxw'] = 481


# Inline
#pgrid = {'nz':609, 'oz':4., 'dz':2., 'nx':183, 'ox':8364., 'dx':17.}
# VP
#dfile = 'coronation_il270_vp.rsf'
#pcb['bva'] = 3200.
# VS
#dfile = 'coronation_il270_vs.rsf'
#pcb['bva'] = 1400.

# Zooming window

#pgrid['ozw'] = 4.
#pgrid['nzw'] = 609.
#pgrid['oxw'] = 8364.
#pgrid['nxw'] = 183


# Get data

Fetch(dfile,'apache',private)
Flow('dfile',dfile,'math output="input" | put label1=z label2=x unit1=m unit2=m')
Result('dfile','grey color=j bias=%(bva)g title=" VS velocity"' % pcb)


# Window selection and shift for zero mean scaled signal


Flow('wdfile','dfile','window min1=%(ozw)g n1=%(nzw)d min2=%(oxw)g n2=%(nxw)d' % pgrid)
Flow('mscale','wdfile','stack axis=2 norm=n | stack axis=1 norm=n | math output="input*%g"' % (1./(pgrid['nzw']*pgrid['nxw'])))
Flow('mdfile','mscale',
     '''
     window | spray axis=1 n=%(nzw)d o=%(ozw)g d=%(dz)g |
     spray axis=2 n=%(nxw)d o=%(oxw)g d=%(dx)g | put label1=z
     ''' % pgrid)
Flow('signal',['wdfile','mdfile'],'math r=${SOURCES[0]} m=${SOURCES[1]} output="r/m-1."')
Result('signal','grey color=j bias=%(bvv)g title="VS velocity variations"' % pcb)


# Spatial frequency content


fft2 = 'fft1 sym=y | fft3 sym=y'
Flow('fdfile','signal',fft2)
Flow('f2dfile','fdfile','math output="input*conj(input)" | real | window min1=%(fzc)g' % pcb)
Result('f2dfile','put label1=fz label2=fx unit1=1/m unit2=1/m | grey color=j allpos=y title="Energy density spectrum"')


# Spectrum in directions X and Z


Flow('specsdez','f2dfile','window n2=1 min2=0')
Flow('specsdex','f2dfile','window n1=1 min2=0')
Plot('specsdex',
         '''
         put label1=f unit1=1/m label2="Energy" unit2= |
         graph dash=0 title="Spatial energy spectrum X" max1=%(fpx)g min1=%(fm)g min2=%(sm)g max2=%(spx)g
         ''' % pcb)
Plot('specsdez',
         '''
         put label1=f unit1=1/m label2="Energy" unit2= |
         graph dash=3 title="Spatial energy spectrum Z" max1=%(fpz)g min1=%(fm)g min2=%(sm)g max2=%(spz)g
         ''' % pcb)
Result('specsdexz','specsdex specsdez','SideBySideAniso')


# End of program


End()
