from rsfproj import *

for dat in Split('a d gma gmd'):
    sep = dat + '.int.HH'
    Fetch(sep,'geosat')
    Flow(dat,sep,
         '''
         cp $SOURCE temp.rsf &&
         echo data_format=xdr_int >> temp.rsf && 
         dd < temp.rsf form=native > $TARGET &&
         rm temp.rsf
         ''',stdin=0,stdout=-1)

mdz=500

for dat in ('a','d'):
    tri = dat+'tri'
    xy = dat+'xy'
    z = dat+'z'
    dz = dat+'dz'
    dzm = dat+'dzm'
    mask = dat+'mask'
    
    Flow(tri,['gm'+dat,dat],
         'cat axis=2 ${SOURCES[1]} | window f1=2 n1=3')
    Flow(xy,tri,'window n1=2 | scale dscale=1.e-6')
    Flow(z,tri,'window n1=1 f1=2 squeeze=n | dd type=float')

    Flow(dz,z,
         '''
         window f2=1 squeeze=n | pad end2=1 | add scale=1,-1 $SOURCE |
         math output="abs(input)" | mask max=%g
         ''' % mdz)
    Flow(dzm,dz,
         '''
         window f2=1 squeeze=n | pad end2=1 | add $SOURCE
         ''')
    
    Flow(mask,[z,dzm],'mask min=0.00001 | add ${SOURCES[1]} mode=p')
    Flow(dat+'tris',[xy,z,mask],
         'cat axis=1 ${SOURCES[1]} | headerwindow mask=${SOURCES[2]}')

Flow('tris','atris dtris','cat axis=2 ${SOURCES[1]}')

End()
