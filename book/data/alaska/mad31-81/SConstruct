from rsf.proj import *

############################
# Data fetching, SEG-Y -> RSF
#############################

rawsegy=['L23535','L23536','L23537']

for file in rawsegy  :
    Fetch(file+'.SGY',
	  server='http://certmapper.cr.usgs.gov',
      	  top='nersl/NPRA/SEISMIC/1981/31_81',
      	  dir='DMUX')
    Flow([file, file+'.bin',  file+'.asc', 't'+file],
         file+'.SGY',
         '''
         segyread bfile=${TARGETS[1]} hfile=${TARGETS[2]} tfile=${TARGETS[3]}
         ''')

# concatinate the input files

Flow('line',rawsegy,'cat axis=2 ${SOURCES[1:3]}')
Flow('tline',map(lambda x: 't'+x,rawsegy),'cat axis=2 ${SOURCES[1:3]}')

# display the first 3000 traces

Plot('first','line',
     'window n2=3000 | grey pclip=90 title="First 3,000 Traces" ')

Result('zoomfirst','line',
       '''
       window min2=1000 max2=1250 min1=0 max1=3 |
       grey pclip=90 title=Zoom
       ''')

Result('firstrec24','line',
       '''
       window min2=2324 max2=2424 min1=0 max1=6 |
       grey pclip=90 title="First Record"
       ''')

# Window out misfire
Flow('shotmask','tline',
     '''
     window n1=1 f1=2 | mask min=157 max=157 |
     add add=-1 | add scale=-1
     ''')

# Convert to shots
Flow('shots','line shotmask',
     '''
     headerwindow mask=${SOURCES[1]} |
     put n2=101 n3=67 |
     window n2=96 f3=10 |
     put o3=100 d3=1
     ''')

Flow('tshots','tline shotmask',
     '''
     headerwindow mask=${SOURCES[1]} |
     put n2=101 n3=67 |
     window n2=96 f3=10 |
     put o3=100 d3=1
     ''')

#############################
# Elevation profile, datuming
#############################

Flow('spelev','../line31-81/spnElev.txt',
     '''
     echo in=$SOURCE data_format=ascii_float n1=2 n2=33 |
     dd form=native
     ''',stdin=0)
Plot('spelev',
     '''
     dd type=complex |
     window |
     graph wanttitle=n wantaxis=n symbol=o plotcol=5
     min2=75 max2=125 min1=85 max1=165
     ''')

Flow('elev','spelev','spline o1=85 d1=1 n1=81')
Plot('elev',
     '''
     graph title=Elevation label1=Shot 
     min2=75 max2=125 min1=85 max1=165 
     ''')
Result('elev','elev spelev','Overlay')


End()
