from rsf.suproj import * 
# need to add the velocity analysis script
# need to add migration
# need to try sudivstack

#################### 
# Fetch the dataset and convert to multiple rsf files
####################

segyread = '''
segyread bfile=${TARGETS[1]} hfile=${TARGETS[2]}
tape=$SOURCE endian=%d
''' % (1-little_endian())

rawsegy=['L23535','L23536','L23537']
for file in rawsegy  :
    Fetch(file+'.SGY',
	  server='http://certmapper.cr.usgs.gov',
      	  top='nersl/NPRA/SEISMIC/1981/31_81',
      	  dir='DMUX')
    Flow([file, file+'.bin',  file+'.asc'],
         file+'.SGY',segyread,stdin=0)


Fetch('31_81_PR.SGY',
      server='http://certmapper.cr.usgs.gov',
      top='nersl/NPRA/SEISMIC/1981/31_81',
      dir='PROCESSED')


# concatinate the input files
Flow ('line', rawsegy,
     'cat ${SOURCES[:3]}',stdin=0)

# display the first 3000 traces

Result('first','line',
       'suwind count=3000 | suximage perc=90')

Result('zoomfirst','line',
       '''
       suwind key=tracl min=1000 max=1250 tmin=0 tmax=3 |
       suximage perc=90
       ''')

#Result('firstmovie','line',
#       '''
#       suxmovie n2=101 loop=1 fframe=1 dframe=1 
#                title="record %g" perc=20 
#       ''')

Result('firstrec24','line',
       '''
       suwind key=tracl min=2324 max=2424 tmin=0 tmax=6 |
       suximage perc=90
       ''')
Flow ('hdrfile.txt','line',
     'sugethw output=geom key=tracl,fldr,tracf')
 
#Flow ('InterpText.class','InterpText.java',
#     '''
#     javac ${SOURCE}
#     ''', stdin=0)

#Flow ('hdrfile1.txt',['hdrfile.txt','InterpText.class'],
#     ''' 
#     java InterpText
#     ''',stdin=0)

Flow ('hdrfile1.txt',['hdrfile.txt','InterpText.py'],
     ''' 
     ./InterpText.py
     ''',stdin=0)

Flow ('binary_hdrfile1.dat','hdrfile1.txt',
     ''' 
     a2b n1=13
     ''')

keys='ep,sx,sy,gx,gy,cdp,tracf,offset,' \
      'selev,gelev,sstat,gstat,tstat'

Flow ('allshots', 'line binary_hdrfile1.dat',
     '''
     sushw 
     	   infile=${SOURCES[1]}
    	   key=%s |
     sushw 
     	   key=f1 
    	   a=0 |
     suwind 
     	    key=cdp 
    	    min=-999998 
    	    max=999999 |
     suwind 
     	    key=ep 
    	    min=-999998 
    	    max=999999 |
     suwind 
     	    key=ep 
	    reject=149
    ''' % keys)

#Result('test','allshots',
#	'''
#	 suxmovie n2=96 loop=1 fframe=1 dframe=1 
#            title="allshots record %g" perc=20
# 	''')

	
# display traces 1010-1250 first 3100 ms (or 1550 samples)
#Result('second','line',
#       '''
#       window f2=1010 n2=240 n1=1550 |
#       agc rect1=250 rect2=100 |
#       grey title="First 3000 traces" pclip=70
#       ''')

#Fetch('31_81_PR.SGY',
#	server='http://certmapper.cr.usgs.gov',
#      	  top='nersl/NPRA/SEISMIC/1981/31_81',
#      	  dir='PROCESSED')

# convert stack and view it:
file='checkstack'
Flow([file, file+'.bin', file+'.asc'],
     '31_81_PR.SGY',segyread + '''
     |   sushw key=ntr a=534 | sushw key=d1 a=0 
     ''',
     stdin=0)

Result('checkstack','checkstack',
       'suximage title="checkstack" perc=90')
Result('zoomcheckstack','checkstack',
       '''
       suwind tmin=0 tmax=3  |
       suximage title="zoom checkstack" perc=90
       ''')

Flow('allvelfilt_shot','allshots alaska_velfilt.sh',
     './${SOURCES[1]} 100 155')

#Result('movie_velfilt','allvelfilt_shot',
#	'''
#	 suxmovie n2=96 loop=1 fframe=1 dframe=1 
#                 title="record %g" perc=20
#	''')

Result('velfiltrec24','allvelfilt_shot',
       '''
       suwind key=tracl min=2324 max=2424 tmin=0 tmax=6 |
       suximage perc=90
       ''')

# sergey did this, but it did not work.  I just used a string
#tnmo=[0000,.339,.607,.707,.872,1.125,
#      1.358,1.652,2.091,2.349,2.859,6.000]
#vnmo=[7752,8074,7964,7781,8124,08754,
#      08931,09721,10425,10742,12518,16552]
#
#tnmo = ','.join(map(str,tnmo))
#vnmo = ','.join(map(str,vnmo))

tnmo='0000,.339,.607,.707,.872,1.125,1.358,1.652,2.091,2.349,2.859,6.000'
vnmo='7752,8074,7964,7781,8124,8754,8931,9721,10425,10742,12518,16552'
Flow('velfiltcdpsmute','allvelfilt_shot',
     '''
     susort cdp |
     sunmo 
       tnmo=%s
       vnmo=%s |
     sumute \
       xmute=-5225,-2970,-55,55,2970,5225 \
       tmute=.700,.280,.100,.100,.280,.700 \
       mode=0 \
       key=offset |
     sunmo 
       tnmo=%s
       vnmo=%s
       invert=1
     ''' % (tnmo,vnmo,tnmo,vnmo)) 

#Result('movie_cdps','velfiltcdpsmute',
#	'''
#	 suxmovie n2=96 loop=1 fframe=1 dframe=1 
#        title="record %g" perc=20
# 	''')

Result('cdp250-251','velfiltcdpsmute',
       '''
       suwind key=cdp min=250 max=251 tmin=0 tmax=3 |
       suwigb perc=90
       ''')

Flow('velfiltcdpsnmo',['velfiltcdpsmute','vpick.txt'],
     '''
     suchw 
       key1=tstat 
       key2=offset 
       a=-200 
       b=.0861 
     | sustatic 
       hdrs=1 
       sign=1 
     | supef 
       maxlag=.2 
       pnoise=.01 
       mincor=.25 
       maxcor=5 
     | sustatic 
       hdrs=1 
       sign=-1 
     | sunmo 
       par=vpick.txt 
     | sugain 
       agc=1 
       wagc=.1 
     | sumute 
       xmute=55,2970,5225 
       tmute=.100,.280,.700 
       mode=0 
       key=offset
   ''')	

#Result('movie_velfiltcdpsnmo','velfiltcdpsnmo',
#	'''
#	 suxmovie n2=96 loop=1 fframe=1 dframe=1 
#                  title="velfiltcdpsnmo record %g" perc=20
# 	''')

Flow('brutestack','velfiltcdpsnmo',
     '''
     sustack 
        key=cdp 
        normpow=1 
     ''')

Result('brutestack','brutestack',
       '''
       suximage title="brutestack" perc=90
       ''')

Result('zoombrutestack','brutestack',
       '''
       suwind tmin=0 tmax=3.0 |
       suximage title="brutestack" perc=90
       ''')

# do inverse nmo, 1 function nmo and compare residual statics.  compare
# velanalysis after residual statics.

Flow('statics_in','velfiltcdpsnmo',
     '''
     suwind tmin=1.0 tmax=3.0 | 
     suresamp rf=2
     ''')

Flow('sourcestatic.dat recstatic.dat',
     'statics_in',
     '''
     suresstat \
        ssol=sourcestatic.dat 
        rsol=recstatic.dat 
        niter=5 
        ntraces=5280 
        ntpick=100 samples 
        nshot=167
        nr=668 
        nc=636 
        sfold=96 
        rfold=96 
        cfold=48 
        verbose=1
     ''',stdout=0)

Result('sourcestatic','sourcestatic.dat',
       'xwigb n1=167 title="source static"')    
Result('recstatic','recstatic.dat',
       'xwigb n1=668 title="receiver static"')    

Flow('rstack',
     'velfiltcdpsnmo sourcestatic.dat recstatic.dat',
     '''
     sushw key=tstat a=0 
     | sushw key=sstat a=0 
     | sushw key=gstat a=0 
     | sustatic 
         hdrs=3 
         sou_file=${SOURCES[1]} 
         rec_file=${SOURCES[2]} 
         ns=167 
         nr=668 
         no=96 
     | sustack 
       key=cdp 
       normpow=1 
     ''')

Result('rstack','rstack',
       'suximage title="rstack" perc=90')

Result('zoomrstack','rstack',
       '''
       suwind tmin=0 tmax=3.0  |
       suximage title="rstack" perc=90
       ''')

Flow('stkvel1.intp2.bin','010_Velocity_Interp_IVA.sh',
     '''
     ./010_Velocity_Interp_IVA.sh
     ''')

Result('vfile','stkvel1.intp2.bin',
       '''
       ximage n1=3000 d1=.002 f2=101 d2=1 cmap=rdb11
       ''')

Flow('mig',['rstack','stkvel1.intp2.bin'],
     '''
     sufrac power=.5 sign=1 |
     suktmig2d vfile=stkvel1.intp2.bin dx=55 hoffset=0 
     ''')

Result('mig','mig',
       '''
       suximage title="mig" perc=90
       ''')
Result('zoommig','mig',
       '''
       suwind tmin=0 tmax=3.0  |
       suximage title="mig" perc=90
       ''')

# it looks like one offset is used for the whole offset gather
# documentation says use sufrac before migration
Flow('premig',['velfiltcdpsnmo','vpick.txt','stkvel1.intp2.bin'],
     './mig.sh')

Flow('premigstack','premig',
     '''
     susort | 
     sustack 
        key=cdp 
        normpow=1 
     ''')

Result('premigstack','premigstack',
       '''
       sufilter f=4,8,200,240 |
       suximage title="premigstack" perc=90
       ''')
Result('zoompremigstack','premigstack',
       '''
       sufilter f=4,8,200,240 |
       suwind tmin=0 tmax=3.0  |
       suximage title="premigstack" perc=90
       ''')

Plot('premigmovie','premig',
     '''
     suxmovie n2=536 loop=1 fframe=1 dframe=1 
     title="record %g" perc=20 
     ''')

End()








