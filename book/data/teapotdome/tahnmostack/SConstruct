from rsf.proj import *
import math

# get the stack created using seismic unix
#Fetch('final_stack.rsf','teapot',server='http://s3.amazonaws.com',top='')
Result('sustack','final_stack','grey title="su stack"')

#Fetch('npr3_gathers.sgy','teapot',server='http://s3.amazonaws.com',top='')

Flow(['npr3_gathers.rsf','npr3_gathers_hdr.rsf'],'npr3_gathers.sgy',
     'sfsegyread tfile=${TARGETS[1]}')

Flow(['mappedstack.rsf','mappedstack_hdr.rsf'],
     ['npr3_gathers.rsf','npr3_gathers_hdr.rsf'],
     '''
     sftahread \
        verbose=1 \
  	input=npr3_gathers.rsf \
    	headers=npr3_gathers_hdr.rsf \
     | sftahnmo \
       verbose=1  \
       tnmo=0.000,0.373,0.619,0.826,0.909,1.017,1.132,1.222,1.716,3.010 \
       vnmo=9086.27,10244.26,11085.81,10803.11,10969.02,11578.66,12252.14,12669.89,14590.08,17116.54 \
     | sftahstack key=iline,xline verbose=1 \
     | sftahwrite \
        verbose=1                           \
        label2="xline" o2=1 n2=188 d2=1   \
        label3="iline" o3=1 n3=345 d3=1   \
        output=mappedstack.rsf \
        outheaders=mappedstack_hdr.rsf 
     ''',stdout=0)

Result('mappedstack','grey title="tah stack"')
Result('mappedstack3d','mappedstack',
	'''
           window n1=1000
           | byte 
           | grey3 title="tah stack" frame1=500 frame2=120 frame3=140
        ''')



# make the mapped gather in the middle data.
# sftahmakeskey hangs if you say key= instead of pkey=

Flow(['mappedgather.rsf','mappedgather_hdr.rsf'],
     ['npr3_gathers.rsf','npr3_gathers_hdr.rsf'],
     '''
     sftahread \
        verbose=0 \
  	input=npr3_gathers.rsf \
     | sftahmakeskey pkey=iline,xline skey=cdpt verbose=1 \
     | sftahwrite \
        verbose=1                           \
	label2="cdpt"  o2=1 n2=50  d2=1   \
        label3="xline" o3=100 n3=5 d3=10   \
        label4="iline" o4=100 n4=3  d4=50   \
        output=mappedgather.rsf \
     ''',stdout=0)
#(sftahread input=mappedgather.rsf | sftahgethw key=iline,xline,cdpt,offset verbose=1 >/dev/null )|& more

Result('mappedgather','grey title="tah gather"')
Result('zoommappedgather','mappedgather',
	'sfwindow max1=2. | grey title="tah gather"')

Flow(['mappedgathernmo.rsf','mappedgathernmo_hdr.rsf'],
     ['mappedgather.rsf','mappedgather_hdr.rsf'],
     '''
     sftahread \
        verbose=0 \
  	input=mappedgather.rsf \
     | sftahnmo \
       verbose=1  \
       tnmo=0.000,0.373,0.619,0.826,0.909,1.017,1.132,1.222,1.716,3.010 \
       vnmo=9086.27,10244.26,11085.81,10803.11,10969.02,11578.66,12252.14,12669.89,14590.08,17116.54 \
     | sftahwrite \
        verbose=1                           \
	label2="cdpt"  o2=1 n2=50  d2=1   \
        label3="xline" o3=100 n3=5 d3=10   \
        label4="iline" o4=100 n4=3  d4=50   \
        output=mappedgathernmo.rsf \
     ''',stdout=0)
Result('mappedgathernmo','grey title="tah nmo gather"')
Result('zoommappedgathernmo','mappedgathernmo',
	'sfwindow max1=2. | grey title="tah nmo gather"')

Flow('foldplot','npr3_gathers_hdr',
     '''
     dd type=float |
     fold
        verbose=1 
	o1=0 n1=96  d1=200 label1=offset 
	o2=1 n2=188 d2=1   label2=xline 
	o3=1 n3=345 d3=1   label3=iline
     ''')
Result('foldplot','grey title=foldplot pclip=100')
Result('foldplot3d','foldplot',
	'''
	byte 
	| grey3 title=foldplot pclip=100 
	  frame1=24 frame2=94 frame3=172
	''')
Flow('foldmap','foldplot',
     '''
     transp plane=13
     ''')
Result('foldmap','grey title=foldplot pclip=100')
# shot coordinates
Flow('sx','npr3_gathers_hdr','dd type=float | headermath output="sx"')
Flow('sy','npr3_gathers_hdr','dd type=float | headermath output="sy"')
Flow('sxsycoord',['sx','sy'],'cmplx ${SOURCES[1]}')
Result('sxsycoord','graph symbol="+" title="Shot coordinates" plotcol=5')

# Receiver coordinates
Flow('gx','npr3_gathers_hdr','dd type=float | headermath output="gx"')
Flow('gy','npr3_gathers_hdr','dd type=float | headermath output="gy"')
Flow('gxgycoord',['gx','gy'],'cmplx ${SOURCES[1]}')
Result('gxgycoord','graph symbol="+" title="Receiver coordinates" plotcol=5')









# from command line:
# wget http://s3.amazonaws.com/teapot/npr3_field.sgy
# ln -s /home/karl/data/TeapotDome/Prestack/npr3_field.sgy .
#Fetch('npr3_field.sgy','teapot',server='http://s3.amazonaws.com',top='')

Flow(['npr3_field.rsf','npr3_field_hdr.rsf'],'npr3_field.sgy',
     'sfsegyread tfile=${TARGETS[1]}')
# (sftahread input=npr3_field.rsf | sftahgethw key=ep,fldr,tracf,offset,sx,sy >/dev/null) |& more
#sfheaderattr <npr3_field_hdr.rsf

Flow(['mappedfield.rsf','mappedfield_hdr.rsf'],
     ['npr3_field.rsf','npr3_field_hdr.rsf'],
     '''
     sftahread \
        verbose=0 \
  	input=npr3_field.rsf \
     | sftahwrite \
        verbose=1                           \
	label2="tracf"  o2=1 n2=863  d2=1   \
        label3="fldr" o3=14 n3=9 d3=100   \
        output=mappedfield.rsf \
     ''',stdout=0)
#(sftahread input=mappedfield.rsf | sftahgethw key=iline,xline,cdpt,offset verbose=1 >/dev/null )|& more

Result('mappedfield','grey title="tah field"')
Result('zoommappedfield','mappedfield',
	'sfwindow max1=2. | grey title="tah field"')

Flow(['mappedfieldnmo.rsf','mappedfieldnmo_hdr.rsf'],
     ['mappedfield.rsf','mappedfield_hdr.rsf'],
     '''
     sftahread \
        verbose=0 \
  	input=mappedfield.rsf \
     | sftahnmo \
       verbose=1  \
       tnmo=0.000,0.373,0.619,0.826,0.909,1.017,1.132,1.222,1.716,3.010 \
       vnmo=9086.27,10244.26,11085.81,10803.11,10969.02,11578.66,12252.14,12669.89,14590.08,17116.54 \
     | sftahwrite \
        verbose=1                           \
	label2="tracf"  o2=1 n2=863  d2=1   \
        label3="fldr" o3=14 n3=9 d3=100   \
        output=mappedfieldnmo.rsf \
     ''',stdout=0)
Result('mappedfieldnmo','grey title="tah nmo field"')
Result('zoommappedfieldnmo','mappedfieldnmo',
	'sfwindow max1=2. | grey title="tah nmo field"')

End()
