from rsf.proj import *

# Sconscript('../fetch/SConstruct')

#(sftahread input=../fetch/npr3_field.rsf | sftahgethw key=tracl,tracr,fldr,tracf,ep,cdp,cdpt,sx,sy,gx,gy >/dev/null )|& more
#(sftahread input=../fetch/npr3_gathers.rsf | sftahgethw key=tracl,tracr,fldr,tracf,ep,cdp,cdpt,sx,sy,gx,gy >/dev/null )|& more

# sftahscscale directly read the input trace and header files.  It will 
# reread the input file to:
#   1- build the sloc and gloc table, a list of each shot x,y and each group x,y
#   2- read the traces and compute the average trace amplitude
#   3- write the sxyamp and gxyamp arrays,  sxyamp is the x,y,amp for each shot
#   4- read each trace and header, read the sxyamp and the gxyamp, apply the 
#      scale correction
#   5- write the trace and header (tah)

# to get all the traces change sftahwrite label2 to:
#	label3="fldr"  o3=14 n3=850  d3=1   

Flow('scscale scscale_hdr sxy gxy sxyamp gxyamp',
     ['../fetch/npr3_field.rsf','../fetch/npr3_field_hdr.rsf'],
     '''
     sftahscscale 
  	input=$SOURCE 
	sxy=${TARGETS[2]}    gxy=${TARGETS[3]} 
	sxyamp=${TARGETS[4]} gxyamp=${TARGETS[5]} 
	starttime=1.5 
	verbose=2 
     | sftahwrite 
        verbose=1 
        label2="tracr" o2=1 n2=723990 d2=1 
	output=$TARGET 
     ''',stdout=0,stdin=0)

Result('sxy',
       'scale dscale=1e-6 | graph symbol="+" title="Shot coordinates" plotcol=4 label1=x label2=y unit1= unit2=')
Result('gxy',
	'scale dscale=1e-6 | graph symbol="+" title="Receiver coordinates" plotcol=5 label1=x label2=y unit1= unit2=')
Flow('sx','sxyamp','window n1=1 f1=0')
Flow('sy','sxyamp','window n1=1 f1=1')
Flow('sxsycoord',['sx','sy'],'cmplx ${SOURCES[1]}')
Result('sxsycoord','scale dscale=1e-6 | graph symbol="+" title="Shot (x,y)" plotcol=5 label1=x label2=y unit1= unit2=')
Flow('gx','gxyamp','window n1=1 f1=0')
Flow('gy','gxyamp','window n1=1 f1=1')
Flow('gxgycoord',['gx','gy'],'cmplx ${SOURCES[1]}')
Result('gxgycoord','scale dscale=1e-6 | graph symbol="+" title="group (x,y)" plotcol=5 label1=x label2=y unit1= unit2=')

Flow(['scscale_subset.rsf','scscale_subset_hdr.rsf'],
     ['scscale.rsf','scscale_hdr.rsf'],
     '''
     sftahsort 
        input=$SOURCE 
	sort="fldr:14,23 tracf:1,1063" 
	verbose=1 
     | sftahwrite 
        verbose=1                           
        label2="tracf" o2=1  n2=1062 d2=1    
	label3="fldr"  o3=14 n3=10  d3=1   
        output=$TARGET 
     ''',stdout=0,stdin=0)

Plot('scscale_subset','scscale_subset',
     'sfwindow max1=2. | grey title="field with scscale"',view=1)

Flow(['npr3_field_subset.rsf','npr3_field_subset_hdr.rsf'],
     ['../fetch/npr3_field.rsf','../fetch/npr3_field_hdr.rsf'],
     '''
     sftahsort 
        input=../fetch/npr3_field.rsf 
	sort="fldr:14,23 tracf:1,1063" 
	verbose=1 
     | sftahwrite 
        verbose=1                           
        label2="tracf" o2=1  n2=1062 d2=1    
	label3="fldr"  o3=14 n3=10  d3=1   
        output=npr3_field_subset.rsf 
     ''',stdout=0,stdin=0)


Plot('npr3_field_subset','npr3_field_subset',
     'sfwindow max1=2. | grey title="field"',view=1)

End()
