from rsf.proj import *

# Download data

Fetch('Nshots.su','nankai')

# Convert to RSF

Flow('shots tshots','Nshots.su','suread suxdr=y tfile=${TARGETS[1]} | window min1=5')

# Extract shots

Flow('shots2 smask','shots','intbin mask=${TARGETS[1]} xk=tracf yk=fldr')

Result('smask',
       '''
       dd type=float |
       stack axis=1 norm=n |
       graph symbol=x title="Nankai Trough"
       label2="Traces per Shot Gather" 
       ''')

Flow('offset','tshots',
     'window n1=1 f1=11 squeeze=n | dd type=float | intbin head=$SOURCE xk=tracf yk=fldr')

# Display individual shots

for fldr in (1707,1847):
    shot = 'shot%d' % fldr
    offset = 'offset%d' % fldr
    mask = 'mask%d' % fldr

    Flow(mask,'smask','window n2=1 min2=%d' % fldr)
    
    Flow(shot,['shots2',mask],
         'window n3=1 min3=%d squeeze=n | headerwindow mask=${SOURCES[1]}' % fldr)
    Flow(offset,['offset',mask],
         'window n3=1 min3=%d squeeze=n | headerwindow mask=${SOURCES[1]}' % fldr)

    Result(shot,[shot,offset],
           '''
           window min1=5.8 max1=7.8 |
           wiggle xpos=${SOURCES[1]} yreverse=y transp=y poly=y
           title="fldr %d" label2=Offset
           ''' % fldr)

    fx = 'fx%d' % fldr
    Flow(fx,shot,'spectra')
    Result(fx,'grey color=j allpos=y title=FX')

# Resample to 4 ms and extract CMPs

Flow('cmps cmask','shots',
     'bandpass fhi=125 | window j1=2 | intbin mask=${TARGETS[1]} xk=tracf yk=cdp')

Flow('offs','tshots','window n1=1 f1=11 squeeze=n | dd type=float | intbin xk=tracf yk=cdp head=$SOURCE')

Result('cmask',
       '''
       dd type=float |
       stack axis=1 norm=n |
       graph symbol=x title="Nankai Trough"
       label2="Traces per CMP Gather" 
       ''')

# Window a CMP and determine tpow gain

cmpno = 1280

Flow('mask','cmask','window n2=1 min2=%d' % cmpno)

Flow('cmp','cmps mask',
     '''
     window n3=1 min3=%d |
     headerwindow mask=${SOURCES[1]}
     ''' % cmpno)
Flow('off','offs mask',
     '''
     window n3=1 min3=%d squeeze=n |
     headerwindow mask=${SOURCES[1]}
     ''' % cmpno)
        
Flow('tpow beta','cmp',
     '''
     stack | envelope | fpow beta=${TARGETS[1]} time=y |
     spray axis=2 n=48 o=28 d=1 | mul $SOURCE
     ''')

label = {'cmp':'',
         'tpow':'(Gained)'}

for case in ('cmp','tpow'):
    Plot(case,[case,'off'],
         '''
         wiggle xpos=${SOURCES[1]} title="CMP %d %s"
         yreverse=y transp=y poly=y label2=Offset unit2=m
         wherexlabel=t wheretitle=b
         ''' % (cmpno,label[case]))

Result('cmp','cmp tpow','SideBySideAniso')

# Apply t^2 gain
Flow('cmpt','cmps','pow pow1=2')

# Velocity analysis and NMO
Flow('vscan','tpow off mask',
     '''
     vscan half=n offset=${SOURCES[1]} mask=${SOURCES[2]}
     v0=1400 nv=101 dv=10 semblance=y 
     ''')
Plot('vscan','grey color=j allpos=y title="Velocity Scan" unit2=m/s')

Flow('pick','vscan','mutter inner=y half=n t0=5 x0=1400 v0=75 | pick v0=1500 rect1=25')
Plot('pick','graph transp=y yreverse=y plotcol=7 plotfat=3 pad=n min2=1400 max2=2400 wanttitle=n wantaxis=n')

Plot('vscanp','vscan pick','Overlay')

Flow('nmo','tpow off mask pick','nmo half=n offset=${SOURCES[1]} mask=${SOURCES[2]} velocity=${SOURCES[3]}')

Plot('tpowg','tpow','grey title="CMP %d" labelsz=12 titlesz=18' % cmpno)
Plot('nmog','nmo','grey title="Normal Moveout" labelsz=12 titlesz=18')
Plot('nmo','tpowg nmog','SideBySideAniso')

Result('vscan','tpow vscanp nmo','SideBySideAniso')

# Apply to all CMPs

Flow('vscans','cmpt offs cmask',
     '''
     vscan half=n offset=${SOURCES[1]} mask=${SOURCES[2]}
     v0=1400 nv=101 dv=10 semblance=y nb=5
     ''')
Flow('picks','vscans','mutter inner=y half=n t0=5 x0=1400 v0=75 | pick v0=1500 rect1=25 rect2=10')

Result('picks',
       '''
       window | grey color=j mean=y scalebar=y title="NMO Velocity"
       label2=CMP barreverse=y barlabel=Velocity barunit=m/s
       ''')

Flow('nmos','cmpt offs cmask picks',
     'nmo half=n offset=${SOURCES[1]} mask=${SOURCES[2]} velocity=${SOURCES[3]}')

Flow('stack','nmos','stack')

Result('stack','window min1=5.5 max1=8 | grey title="NMO Stack" ')

End()
