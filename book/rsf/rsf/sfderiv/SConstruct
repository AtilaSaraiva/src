from rsf.proj import *
from math import pi

# Impulse response test

shift = 2*pi*256
Flow('nfreq',None,
     '''
     math type=complex
     n1=512 d1=0.00195312 o1=-0.5 label1=Frequency unit1=cycle
     output="I*%g*x1"
     ''' % (2*pi))
Flow('ntime','nfreq',
     '''
     math output="input*exp(I*x1*%g)" |
     put fft3_n1=512 fft3_o1=-256 |
     fft3 axis=1 inv=y |
     real
     ''' % shift)

Flow('spike',None,'spike n1=512 k1=257 d1=1 o1=-256')

fft = '''
rtoc |
fft3 axis=1 pad=1 opt=n |
math output="input*exp(-I*x1*%g)"
''' % shift

for order in (2,20):
    time = 'time%d' % order
    freq = 'freq%d' % order
    Flow(time,'spike','deriv order=%d' % order)
    Flow(freq,time,fft)

Result('freq','nfreq freq20 freq2',
       '''
       cat axis=2 ${SOURCES[1:3]} | imag |
       dots labels=ideal:order=20:order=2 gaineach=n 
       ''')
Result('time','ntime time20 time2',
       '''
       cat axis=2 ${SOURCES[1:3]} |
       window min1=-33 max1=33 |
       dots unit1=sample labels=ideal:order=20:order=2 gaineach=n dots=2
       ''')

# Compare with igrad

# Error when differentiating a smooth function

End()
