from rsfproj import *


Flow('modl',None,'spike n1=100 d1=0.08 n2=4 nsp=4 k2=1,2,3,4 mag=1,2.2,3.5,5')
Flow('refl',None,
     '''
     spike n1=100 n2=4 nsp=4 k2=1,2,3,4
     mag=0.0909091,0.1428570,0.1111110,0.2000000
     ''')

Result('modl',
       '''
       unif2 n1=110 d1=0.05 v00=5,6,8,10,15 |
       grey color=j allpos=y title="Model" scalebar=y
       barlabel="Velocity (kft/s)" label1="Depth (kft)" label2="Lateral (kft)"
       barreverse=y pclip=100
       ''')

Flow('clean','modl refl',
     '''
     kirmod nt=501 dt=0.004 freq=25 refl=${SOURCES[1]}
     ns=12 s0=1.4 ds=-0.1
     nh=64 h0=0.1 dh=0.1
     vel=5 gradz=2 type=v
     ''')
Flow('dat','clean',
     '''
     noise rep=y seed=2004 range=0.0002 |
     ricker1 frequency=25 |
     add $SOURCE 
     ''')

shots = []
for shot in range(0,12,5):
    data = 'data%d' % shot
    shots.append(data)
    Plot(data,'dat',
         '''
         window n3=1 f3=%d |
         tpow tpow=2 |
         grey gpow=0.5 title="Shot %d"
         ''' % (shot,shot+1))
Result('data',shots,'SideBySideAniso')

Flow('off','data','window n1=1 | math output="500*x1" ')
Flow('cmp','off','math output="input+1000*x2" ')

def wiggle(title):
    return  '''
    wiggle transp=y yreverse=y poly=y xpos=${SOURCES[1]}
    title="%s" xmax=3200 xmin=50
    label2="Half-Offset (ft)" zplot=0.25
    ''' % title

def graph(col,fat):
    return '''
    graph transp=y yreverse=y pad=n min2=4000 max2=12925
    plotcol=%d plotfat=%d wantaxis=n wanttitle=n
    ''' % (col,fat)
    
for x in range(1500,4000,500):
    cdp = 'cdp%d' % x
    off = 'off%d' % x
    msk = 'msk%d' % x
    Flow(msk,'cmp','mask min=%d max=%d' % (x-1,x+1))
    Flow(off,['off',msk],'spray axis=1 n=1 | headerwindow mask=${SOURCES[1]}')
    Flow(cdp,['dat',msk],'headerwindow mask=${SOURCES[1]}')
    Plot(cdp,[cdp,off],wiggle('CDP gather for cdp=%d' % x))
    ##################
    # Velocity Scan
    ##################
    scn = 'scn%d' % x
    Flow(scn,[cdp,off],'vscan offset=${SOURCES[1]} semblance=y v0=4000 dv=75 nv=120')
    Plot(scn,'grey color=j allpos=y label2="Velocity (ft/s)" title="Velocity Scan" ')
    ##################
    # Velocity Picking
    ##################
    pik = 'pik%d' % x
    Flow(pik,scn,'blindpick rect1=100')
    Plot(pik+'a',pik,graph(7,10))
    Plot(pik+'b',pik,graph(0,1))
    Plot(scn+'a',[scn,pik+'a',pik+'b'],'Overlay')
    ##################
    # NMO
    ##################
    nmo = 'nmo%d' % x
    Flow(nmo,[cdp,off,pik],'nmo offset=${SOURCES[1]} velocity=${SOURCES[2]}')
    Plot(nmo,[nmo,off],wiggle('Normal Moveout Applied'))
    #####################
    # Putting it together
    #####################
    Result(cdp,[cdp,scn+'a',nmo],'SideBySideAniso')
    
End()
