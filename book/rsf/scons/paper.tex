\title{Reproducible research in computational geophysics \\ using SCons}

\lefthead{Fomel \& Hennenfent}
\righthead{Reproductible research}

\author{Sergey Fomel and Gilles Hennenfent}
\email{sergey.fomel@beg.utexas.edu, ghennenfent@eos.ubc.ca}

\maketitle

\begin{abstract}
SCons (from Software Construction) is
\end{abstract}

\section{Introduction}

\subsection{Reproducible research philosophy}

Peer review is the backbone of scientific progress. From the ancient
alchemists, who worked in secret on magic solutions to insolvable
problems, the modern science has come a long way to become a social
enterprise, where hypotheses, theories, and experimental results are
openly published and verified by the community. By reproducing and
verifying previously published research, a researcher can take new
steps to advance the progress of science.

Traditionally, scientific disciplines are divided into theoretical and
experimental studies. Reproduction and verification of theoretical
results usually requires only imagination (apart from pencils and
paper), experimental results are verified in laboratories using
equipment and materials similar to those described in the publication.

During the last century, computational studies emerged as a new
scientific discipline. Computational experiments are carried out on a
computer by applying numerical algorithms to digital data. How
reproducible are such experiments? On one hand, reproducing the result
of a numerical experiment is a difficult undertaking. The reader needs
to have access to precisely the same kind of input data, software and
hardware as the author of the publication to reproduce the result. It
is often difficult or impossible to provide detailed specifications
for these components. On the other hand, basic components of a
computational system such as operating systems and file formats are
getting increasingly standardized, and new components can be shared in
principle because they simply represent digital information
transferable over the Internet.

The practice of software sharing has fueled the miraculously efficient
development of Linux, Apache, and many other open-source software
projects.  Its proponents often refer to this ideology as an analog of
the scientific peer review tradition. Eric Raymond, one of the
best-known supporters of the open-source movement, writes
\cite[]{taoup}:
\begin{quote}
  Abandoning the habit of secrecy in favor of process transparency and
  peer review was the crucial step by which alchemy became chemistry.
  In the same way, it is beginning to appear that open-source
  development may signal the long-awaited maturation of software
  development as a discipline.
\end{quote}
While software development is trying to imitate science, computational
science needs to borrow from the open-source model in order to sustain
itself as a fully scientific discipline.

In computer science, the concept of publishing and explaining computer
programs goes back to the idea of \emph{literate programming} promoted
by \cite{knuth} and expended by many other researchers
\cite[]{thimbleby}. In his 2004 lecture on ``better programming'',
Harold Thimbleby says\footnote{url:http://www.uclic.ucl.ac.uk/harold/}
\begin{quote}
  We want ideas, and in particular programs, that work in one place to
  work elsewhere. One form of objectivity is that published science
  must work elsewhere than just in the author's laboratory or even
  just in the author's imagination; this requirement is called
  \emph{reproducibility}.
\end{quote}

The quest for peer review and reproducibility is especially important
for computational geosciences and computational geophysics in
particular. The very first paper published in \emph{Geophysics} was
titled ``Black magic in geophysical prospecting''
\cite[]{GEO01-01-00010008,TLE02-03-00280031} and presented an account
of different ``magical'' methods of oil explorations promoted by
entrepreneurs in the early days of geophysical exploration industry.
Although none of these methods exist today, it is not a secret that
industrial practice is full of nearly magical tricks, often hidden
besides a scientific appearance. Only a scrutiny of peer review and
result verification can help us distinguish magic from science and
advance the latter.

Nearly ten years ago, the technology of reproducible research in
geophysics was pioneered by Jon Claerbout and his students at the
Stanford Exploration Project (SEP).  SEP's system of reproducible
research requires the author of a publication to document creation of
numerical results from the input data and software sources to let
others test and verify the result reproducibility
\cite[]{SEG-1992-0601,matt}.
%% In Claerbout's words
%% \footnote{http://sepwww.stanford.edu/research/redoc/IRIS.html},
%% \begin{quote}
%%   The purpose of reproducible research is to facilitate someone going a step
%%   further by changing something. The first step that someone will want to make
%%   is to be sure that your work is reproducible before they change and improve
%%   upon it. 
%% \end{quote}
%% \begin{quote}
%%   It takes some effort to organize your research to be reproducible.
%%   We found that although the effort seems to be directed to helping other
%%   people stand up on your shoulders, the principal beneficiary is generally
%%   the author herself. This is because time turns each one of us into another
%%   person, and by making effort to communicate with strangers, we help
%%   ourselves to communicate with our future selves.
%% \end{quote}
The discipline of reproducible research was also adopted and
popularized in the statistics and wavelet theory community by
\cite{donoho}. It is referenced in the popular wavelet theory books
\cite[]{hubbard,mallat}.  However, the adoption or reproducible
research practice by computational geoscientists outside of SEP has
been slow.  Partially, this is caused by difficult and inadequate
tools.

%What kind of documentation is required to make geophysical numerical
%experiments reproducible? Geophysical data analysis involves remote datasets
%that are typically passed through several data processing steps before a final
%image is created and some information about the subsurface geology is
%inferred.  Keeping a precise record of the processing history is necessary for
%reproducing and verifying the result. 

%The closest analog from other
%disciplines is medicine. Both geosciences and medical sciences study unique
%objects (the Earth planet and the human organism respectively). Each
%geophysical dataset is in some sense as unique as each medical patient, and
%keeping a careful log of the data analysis history is essential for scientific
%validation of the methods applied to it.

\subsection{Tools for reproducible research}

The reproducible research system developed at Stanford is based on
``make''\footnote{Originally, SEP used ``cake'', a dialect of ``make''
  \cite[]{Nichols.sep.61.341,Claerbout.sep.67.145,Claerbout.sep.73.451,Claerbout.sep.77.427}.
  The system was converted to ``GNU make'', a more standard dialect,
  by \cite{Schwab.sep.89.217}.}, a Unix software construction utility.
The ``make'' program keeps track of dependencies between different
components of the system and the software construction targets, which,
in the case of a reproducible research system, turn into figures and
manuscripts. The targets and commands for their construction are
specified by the author in ``makefiles'', which serve as databases for
defining source and target dependencies. A dependency-based system
leads to rapid development, because when one of the sources changes,
only parts that depend on this source get recomputed.  \cite{donoho}
based their system on Matlab, a popular integrated development
environment \cite[]{matlab}, produced by MathWorks.  While Matlab is
an adequate tool for prototyping numerical algorithms, it may not be
sufficient for large-scale computation, typical for many applications
in computational geophysics.

``Make'' is an extremely useful utility employed by thousands of
software development projects \cite[]{make}. Unfortunately, it is not
well designed from the user experience prospective. ``Make'' employs
an obscure and limited special language (a mixture of Unix shell
commands and special-purpose commands), which often appears confusing
to unexperienced users. According to Peter van der Linden, a software
expert from Sun Microsystems \cite[]{linden},
\begin{quote}
  ``Sendmail'' and ``make'' are two well known programs that are
  pretty widely regarded as originally being debugged into existence.
  That's why their command languages are so poorly thought out and
  difficult to learn. It's not just you -- everyone finds them
  troublesome.
\end{quote}
The inconvenience of ``make'' command language is also in its limited
capabilities.  The reproducible research system includes not only
custom ``make'' rules but also an obscure and hardly portable
agglomeration of shell and Perl scripts that extend ``make''.

Several alternative systems for dependency-checking software
construction have been developed in recent years. One of the most
promising new tools is SCons, enthusiastically endorsed by
\cite{dubois}. The SCons initial design won the Software Carpentry
competition sponsored by Los Alamos National Laboratory in 2000 in the
category of ``a dependency management tool to replace make''.  Some of
the main advantages of SCons are:
\begin{itemize}
\item SCons configuration files are Python scripts. Python is a modern
  programming language praised for its readability, elegance,
  simplicity, and power \cite[]{python1,python2}.
  \cite{TLE21-03-02600267} recommend Python as the first programming
  language for geophysics students.
\item SCons offers reliable, automatic, and extensible dependency
  analysis -- no more ``make depend'' or ``make clean'' to get all of
  the dependencies.
\item SCons has built-in support for many programming languages and
  systems: C, C++, Fortran, Java, LaTeX, CVS, and others.
\item While ``make'' relies on timestamps for detecting file changes
  (creating numerous problems on platforms with different system
  clocks), SCons uses by default a much more reliable detection
  mechanism employing MD5 signatures. It can detect changes not only
  in files but also in commands used to build them.
\item SCons provides integrated support for parallel builds.
\item SCons provides configuration support analogous to the ``autoconf''
  utility for testing the environment on different platforms.
\item SCons creates a global view of all dependencies -- no more
  multiple build passes or touching and reordering targets in order to
  build everything.
\item SCons is designed from the ground up as a cross-platform tool.
  It is known to work equally well on both POSIX systems (Linux, Mac
  OS X, Solaris, etc.) and Windows.
\item The stability of SCons is assured by an incremental development
  methodology utilizing comprehensive regression tests\footnote{As of
    time of this writing, SCons is in a beta version 0.96 approaching
    the 1.0 official release. See \url{http://www.scons.org/}.}.
\item SCons is publicly released under a liberal open-source license.
\end{itemize}

In this paper, we propose to adopt SCons as a new platform for
reproducible research in scientific computing.

\subsection{Paper organization}

\newpage
\section{Madagascar open source code}
%
Madagascar's homepage is \url{http://rsf.sourceforge.net}. Madagascar
source code is proposed in two versions:
\href{https://sourceforge.net/project/showfiles.php?group_id=162909}{stable}
and
\href{http://rsf.sourceforge.net/wiki/index.php/Svn-url}{development}.
The stable version is a snapshot of Madagascar at a given time. It was
installed on different platforms and tested before being released.
Updates are typically done every few months as opposed to the
development version which is updated every few hours or days by a
dynamic team of developers. As such, there is no guarantee that the
development version will be fully functional and stable at any given
point in time. In the remaining of this paper, we assume that you have
successfully installed Madagascar stable version and that you have an
Internet connection\footnote{XXX provide alternate mean to download
  Lena.img if no Internet connection XXX}.

\section{Creating a reproducible script}
%
First of all, the SConstruct commands set in our reproducible research
environment are

\noindent\texttt{Fetch(filename,dir[,ftp\_server\_info])}\\
\indent A rule to download \textit{$<$filename$>$} from a specific
directory \textit{$<$dir$>$} of an FTP server
\textit{$<$ftp\_server\_info$>$}.

\noindent\texttt{Flow(target[s],source[s],command[s][,stdin][,stdout])}\\
\indent A rule to generate \textit{$<$target[s]$>$} from
\textit{$<$source[s]$>$} using \texttt{command[s]}

\noindent\texttt{Plot(intermediate\_plot[,source],plot\_command)} or\\
\texttt{Plot(intermediate\_plot,intermediate\_plots,combination})\\
\indent A rule to generate \textit{$<$intermediate\_plot$>$} (VPL file
in the working directory).

\noindent\texttt{Result(plot[,source],plot\_command)} or\\ 
\texttt{Result(plot,intermediate\_plots,combination})\\
\indent A rule to generate a final \textit{$<$plot$>$} (VPL file in
the \textit{Fig} folder of the working directory).

These commands are defined in \textit{\$RSFROOT/lib/rsfproj.py} where
\textit{RSFROOT} is the environmental variable to the directory where
Madagascar is installed.

\subsection{Example 1}
%
\definecolor{frame}{rgb}{0.905,0.905,0.905}
\lstset{language=Python,backgroundcolor=\color{frame},showstringspaces=false,numbers=left,numberstyle=\tiny}
\lstinputlisting[firstline=1,lastline=16,frame=single]{easystart/SConstruct}

This reproducible script (i.e. SConstruct), available in the
\textit{rsf/scons/easystart} directory of Madagascar book section,
illustrates the basic use of some of the commands presented in the
previous section. An image is downloaded from an anonymous data
server, converted to Madagascar file format, manipulated, and
displayed. But let's have a closer look at the script
and decorticate it.\\

\lstinputlisting[firstline=1,lastline=1,frame=single]{easystart/SConstruct}
%
is a standard Python command that loads the Madagascar project
management module \textit{rsfproj.py} which provides our extension to
SCons.\\

\lstinputlisting[firstline=2,lastline=2,frame=single]{easystart/SConstruct}
%
instructs SCons to connect to BEG FTP server (default behavior if no
FTP server information is provided) and fetch the data file
\textit{lena.img} from the \textit{data/imgs} directory. Note that
Madagascar expects a \textit{data} folder on top of the specified
directory (i.e.  \textit{imgs}). In the directory where you have your
SConstruct, running \texttt{scons lena.img} on the command line will
download the file \textit{lena.img}.  The equivalent command lines are
\footnote{use login: anonymous, password: anonymous}
\begin{verbatim}
bash$ ftp egl.beg.utexas.edu
ftp> bin
ftp> cd data/imgs
ftp> get lena.img
ftp> bye
\end{verbatim}
%
\lstinputlisting[firstline=3,lastline=7,frame=single]{easystart/SConstruct}
%
prepares the Madagascar header file \textit{ulena.rsf} using the
standard Unix command \texttt{echo}. Note that, if no extension is
specified, the default extension ``.rsf'' will be appended to source
and target names. The equivalent command line is
%
\begin{verbatim}
bash$ echo n1=512 n2=513 d1=1 d2=1 in=lena.img \
data_format=native_uchar > ulena.rsf
\end{verbatim}
%
Since \texttt{echo} does not take a standard input, stdin is set to 0
in the Flow command otherwise the first source is the standard input.
Likewise, the first target is the standard output unless otherwise
specified. Note the triple quotes used because the actual command is
broken into several lines in the SConstruct. Note also that
\textit{lena.img} is refered as \textit{\$\{SOURCES[0]\}} (i.e.  first
element of the \textit{\$SOURCES} list) in the command. Run
\texttt{scons ulena.rsf} to execute the Flow command and obtain the
ASCII header file \textit{ulena.rsf}.  The next step is to convert the
binary data \textit{lena.img} into a Madagascar file.\\

\lstinputlisting[firstline=8,lastline=8,frame=single]{easystart/SConstruct}
%
The equivalent command line is
%
\begin{verbatim}
bash$ < ulena.rsf sfdd type=float > flena.rsf
\end{verbatim}
%
Run \texttt{scons flena.rsf}. The Lena image is now converted to
Madagascar file format with a header file \textit{flena.rsf} in the
current directory and a binary file \textit{flena.rsf@} in the data
directory (environment variable \textit{DATAPATH}). The last two steps
before displaying Lena (don't
be so impatient...)  is windowing the image and subtracting its mean.\\

\lstinputlisting[firstline=9,lastline=10,frame=single]{easystart/SConstruct}
%
The equivalent command line is
%
\begin{verbatim}
bash$ < flena.rsf sfwindow f2=1 | sfmath \ 
output=``input-99.0512''  > zmflena512.rsf
\end{verbatim}
%
Run \texttt{scons zmflena512.rsf} to obtain \textit{zmflena512.rsf}.
Use \texttt{sfin zmflena512.rsf} to check the header of our new file
(\textit{DATAPATH} is set to '.')
%
\begin{verbatim}
zmflena512.rsf:
    in="./zmflena512.rsf@"
    esize=4 type=float form=native 
    n1=512         d1=1           o1=0          
    n2=512         d2=1           o2=1          
        262144 elements 1048576 bytes
\end{verbatim}
%
and \texttt{sfattr want=mean $<$zmflena512.rsf} to double check the
image has 0 mean. It is now high time to display Lena!\\
%
\lstinputlisting[firstline=11,lastline=15,frame=single]{easystart/SConstruct}
%
which command line equivalent is
\begin{verbatim}
bash$ < zmflena512.rsf sfgrey title="Lena" transp=n minval=-150 \
maxval=150 clip=120 screenratio=1 titlesz=14 | xtpen
\end{verbatim}
%
Running \texttt{scons lena.view} displays Fig.~\ref{fig:lena}.
%
\inputdir{easystart}
\plot{lena}{height=.25\textheight}{Lena}
%
It also create a \textit{Fig} directory in the current folder where it
stores the result \textit{lena.vpl}. The Madagascar reproducible
script ends with\\
%
\lstinputlisting[firstline=16,lastline=16,frame=single]{easystart/SConstruct}

\subsection{Example 2}

Since SConstructs are Python scripts, we can also use all the
flexibility and sophistication of the Python language in our
Madagascar reproducible scripts. A demo script is available in the
\textit{rsf/scons/rsfpy} directory of Madagascar book section, but,
rather than commenting it line-by-line, we select some parts of
interest.

In a Madagascar reproducible script (i.e. SConstruct) we can declare
Python variables\\

\lstinputlisting[firstline=3,lastline=5,frame=single]{rsfpy/SConstruct}

\noindent that can be used later, for example, to define our customized plot
command as a Python function\\

\lstinputlisting[firstline=7,lastline=11,frame=single]{rsfpy/SConstruct}

This Python function, named ``grey()'', can then be called in Plot or Result
commands, e.g.\\

\lstinputlisting[firstline=52,lastline=52,frame=single]{rsfpy/SConstruct}

We can define a Python dictionary, e.g.\\

\lstinputlisting[firstline=36,lastline=37,frame=single]{rsfpy/SConstruct}

\noindent and loop over its entries, e.g.\\

\lstinputlisting[firstline=38,lastline=43,frame=single]{rsfpy/SConstruct}

Note that the title of the plots is obtained by concatenating Python
strings\\

\lstinputlisting[firstline=40,lastline=40,frame=single]{rsfpy/SConstruct}

Python strings can also be used to define sequences of commands used
in several Flows, e.g.\\

\lstinputlisting[firstline=71,lastline=74,frame=single]{rsfpy/SConstruct}

Finally, in our Madagascar reproducible script, we may want the option
to pass command line arguments when running SCons or use default
values otherwise, e.g.\\

\lstinputlisting[firstline=70,lastline=70,frame=single]{rsfpy/SConstruct}

Running \texttt{scons} only, the default value set for fthr (i.e. 70)
is used whereas running \texttt{scons fthr=68} set fthr to a command
line specified value.

This is by no mean an exhaustive list of options but, hopefully, it
gives you a flavor of the powerful tool you have in hands. Sit back
and enjoy!

\subsection{Useful SCons commands for reproducible scripts}

On top of SCons standard options (\texttt{scons --help} for more
details), Madagascar has its own SCons options. We already saw
\texttt{scons plot.view} that displays \textit{plot.vpl} (in the
\textit{Fig} folder) obtained in a Result command. \texttt{scons view}
displays the result plots one after the other.

It is also possible to check parameters for Madagascar programs in
SCons Flow commands using the CHECKPAR option (\texttt{scons
  CHECKPAR=y target}). Note that CHECKPAR is an experimental option
and will be enhanced in the future to include parameter ranges and
other safety checks.

To time the execution of processing flows in a SConstruct use the
TIMER option (\texttt{scons TIMER=y target}).

\texttt{scons lock} is used to secure result plots and copy them from
the \textit{Fig} folder of your working directory to your
\textit{\$RSFFIGS} folder where \textit{RSFFIGS} is the environmental
variable to the directory where you want Madagascar to put your key
Madagascar result plots. Note that this is a necessary step before
creating a reproducible documentation. \texttt{scons plot.flip} runs
\texttt{xtpen Fig/plot.vpl /locked/figures/plot.vpl} to flip between
the new and locked figure. This is useful when detecting changes.

\section{Creating a reproducible documentation}
%
A Madagascar reproducible paper is a paper written in \LaTeX\ and
whose figures are either generated by Madagascar reproducible scripts
or available for download, e.g.  this paper!  (\textit{paper.tex}
available in the \textit{rsf/scons/} directory of Madagascar book
section).

The main SConstruct command set in our reproducible research
environment and related to documentation is

\noindent\texttt{Paper(paper\_name,[,use][,lclass])}\\
\indent A rule to compile \textit{$<$paper\_name$>$} (Madagascar
\LaTeX\ document) using the \LaTeX\ packages specified in \textit{use}
and the \LaTeX\ style specified in \textit{lclass} (default is
\textit{geophysics.cls}).

This command is defined in \textit{\$RSFROOT/lib/rsftex.py}.

\subsection{Example}

\lstinputlisting[firstline=1,lastline=3,frame=single]{SConstruct}

This SConstruct generates this paper but it can also compile
\textit{velan.tex} in the same directory. Note that there is no Paper
command for \textit{paper.tex} since it is the default documentation
name. Optional \LaTeX\ packages and style used in \textit{paper.tex}
are passed in the End command.

Let's now have a closer look at \textit{paper.tex} to understand how
the figures of the documentation are linked to the reproducible
scripts that created them. First of all, note that \textit{paper.tex}
is not a regular \LaTeX\ document but only its body (no
$\backslash$documentclass, $\backslash$usepackage, etc.). In our
paper, Fig.~\ref{fig:lena} was created in the project folder
\textit{easystart} (sub-folder of our documentation folder) by the
result plot \textit{lena.vpl}. In the \LaTeX\ source code, it
translates as\\

\lstset{language=[LaTeX]TeX,backgroundcolor=\color{frame},showstringspaces=false,numbers=left,numberstyle=\tiny}
\lstinputlisting[firstline=377,lastline=378,frame=single]{paper.tex}

The $\backslash$inputdir command points to the project directory and
the $\backslash$plot command calls \textit{$<$result\_name$>$}. The
\LaTeX\ tag of the figure is \textit{fig:$<$result\_name$>$}. Only the
first time the paper is compiled, the VPL result file is automatically
converted to PDF file format unless the VPL result file is updated and
locked in which case, the PDF file is also automatically updated at
the next paper compilation.

\subsection{Useful SCons commands for reproducible documentation}

To actually compile this paper you first need to run and lock the
\textit{easystart} project. Go in the \textit{easystart} folder and
run \texttt{scons lock}. Go back to the documentation folder and run
\texttt{scons pdf} (alternatively \texttt{scons
  $<$paper\_name$>$.pdf}). Use \texttt{scons read} (alternatively
\texttt{scons $<$paper\_name$>$.read}) or your favorite PDF reader to
read this paper reproduced by yourself...

SERGEY: COULD YOU PLEASE HELP ME WITH scons wiki \& scons html IF YOU
WANT TO INCLUDE THEM?

\bibliographystyle{seg}
\bibliography{SEG,SEP2,scons}

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: t
%%% End: 
