from rsfproj import *

minval = -150
maxval = 150
clip = 120

def grey(title='',transp='n',label1='',label2=''):
    return '''
    sfgrey title="%s" transp=%s minval=%f maxval=%f clip=%f
    screenratio=1 label1=%s label2=%s titlesz=14
    ''' % (title,transp,minval,maxval,clip,label1,label2)

min = -50
max = 50

def graph(title=''):
    return '''
    sfgraph min2=%f max2=%f title=%s titlesz=14
    screenratio=.75
    ''' % (min,max,title)

# fetch the data on BEG FTP server
Fetch('lena.img','imgs')
Flow('lena','lena.img',
     '''
     echo n1=512 n2=513 d1=1 d2=1 in=$SOURCE
     data_format=native_uchar |
     sfdd type=float | sfwindow f2=1 | 
     sfmath output="input-99.0512"
     ''',stdin=0)

# add noise to lena
Flow('nlena','lena','sfnoise seed=2006 var=1400')

# plots and FX spectra
titles = {'lena':'Lena',
          'nlena':'Noisy Lena'}
for name in titles.keys():
    Plot(name,grey(titles[name]) )
    cftitle = titles[name]+' in the FX domain'
    Flow('fx'+name,name,'sfspectra')
    Plot('fx'+name,grey('%s','y',
                        'Frequency','Position') %cftitle )

# display 2x2 figs
Plot('lenas','lena nlena','SideBySideAniso')
Plot('fxlenas','fxlena fxnlena','SideBySideAniso')
Result('panel1','lenas fxlenas','OverUnderAniso')

# denoising using LP filtering
Flow('lplena','nlena','sfbandpass fhi=.075')
Plot('lplena',grey('Noisy Lena LP filtered'))

# thresholding
lg = 100.
thr = lg/6.
Flow('range',None,'sfmath n1=%d output="x1-%f" ' %(lg,lg/2))
Flow('thr',None,
     'sfmath n1=%d n2=2 output="(2*x2-1)*%f" ' %(lg,thr))

Plot('range',graph('Data with threshold level') )
Plot('thr',graph()+' dash=1')
Plot('data','range thr','Overlay')

Flow('hdata','range','sfthr thr=%f mode=hard' %thr)
Plot('hdata',graph('Thresholded data') )
Result('hthr','data hdata','SideBySideAniso')

# denoising using thresholding in the Fourier domain
fthr = float(ARGUMENTS.get('fthr', 70))
fft2 = 'sffft1 sym=y | sffft3 sym=y'
ifft2 = 'sffft3 sym=y inv=y | sffft1 sym=y inv=y '

Flow('fnlena','nlena',fft2)
Flow('fthrlena','fnlena','sfthr thr=%f mode="hard"' %fthr)
Flow('thrlena','fthrlena',ifft2)
Plot('thrlena',grey('Thresholding in the Fourier domain') )

# combine figures (2x2 figs)
Plot('pan2row1','lena nlena','SideBySideAniso')
Plot('pan2row2','lplena thrlena','SideBySideAniso')
Result('panel2','pan2row1 pan2row2','OverUnderAniso')

End()
