from rsf.proj import *
import math

rawsegy=['L23535','L23536','L23537']

for name in rawsegy:
    Fetch(name+'.SGY',
          server='http://certmapper.cr.usgs.gov',
          top='nersl/NPRA/SEISMIC/1981/31_81',
          dir='DMUX')
    Flow([name,'t'+name,name+'.bin',name+'.asc'],
         name+'.SGY',
         'segyread tfile=${TARGETS[1]} bfile=${TARGETS[2]} hfile=${TARGETS[3]}')

Flow('mgline',rawsegy,'cat ${SOURCES[1:3]} axis=2')
Flow('tmgline',map(lambda x: 't'+x, rawsegy),'cat ${SOURCES[1:3]} axis=2') 
Result('mgline',
       '''
       grey pclip=80 title="Alaska Line 31-81" label2=''
       font=2 labelsz=10 titlesz=16 labelfat=2 titlefat=4
       ''')

############################
# zeros out shot 149
# 157 misfire has been kept
############################

Flow('part','mgline','window f2=5955 n2=300')
Plot('part',
       '''
       grey pclip=80 title="Shot 148-149-150" label2=''
       font=2 labelsz=10 titlesz=16 labelfat=2 titlefat=4
       ''')

Flow('nosig','mgline','window f2=6060 n2=96')
Plot('nosig',
       '''
       grey pclip=80 title="Shot 149" label2=''
       font=2 labelsz=10 titlesz=16 labelfat=2 titlefat=4
       ''')

Flow('zero','nosig','math output=input*0')

Plot('zero',
       '''
       grey pclip=80 title="Shot 149 Zero" label2=''
       font=2 labelsz=10 titlesz=16 labelfat=2 titlefat=4
       ''')

Result('bad','part nosig zero','SideBySideAniso')

Flow('part1','mgline','window f2=0 n2=6060')
Flow('part3','mgline','window f2=6156')
join = ['part1','zero','part3']
Flow('mgline2',join,'cat ${SOURCES[1:3]} axis=2')

# shotline
Flow('line','mgline2',
     '''
     put n2=101 n3=67 | window n2=96 f3=10 |
     put o2=-5225 d2=110 label2=Offset unit2=ft
         o3=0 d3=440 label3=Shot unit3=ft
     ''')

Result('line',
       '''
       grey pclip=80 title="" label2=''
       font=2 labelsz=10 titlesz=16 labelfat=2 titlefat=4
       ''')

##########################
#Statics
##########################
# elevation profile
Flow('spelev','spnElev.txt',
     '''
     echo in=$SOURCE data_format=ascii_float n1=2 n2=33 |
     dd form=native
     ''',stdin=0)

Plot('spelev',
     '''
     dd type=complex |
     window |
     graph wanttitle=n wantaxis=n symbol=+ plotcol=5
     min2=75 max2=125 min1=88 max1=165
     font=2 labelsz=10 titlesz=16 labelfat=2 titlefat=4
     ''')

Flow('station','spelev','window n1=1')

# Interpolation
Flow('elev','spelev station',
     'window f1=1 | invbin1 eps=0 head=${SOURCES[1]} x0=85 dx=1 nx=81')
Plot('elev',
     '''
     graph title=Elevation label1=Shot
     min2=75 max2=125 min1=88 max1=165
     font=2 labelsz=10 titlesz=16 labelfat=2 titlefat=4
     ''')

Result('elev','elev spelev','Overlay')

Flow('helev','spelev',
     '''
     window n1=1 f1=0 |
     math output="(input-100)*440"
     ''')

Flow('delev','spelev','window n1=1 f1=1')

Flow('lineelev',['delev','helev'],
     '''
     shapebin1 nx=321 x0=-5280 dx=110 head=${SOURCES[1]} eps=0.1
     ''')

Flow('shotelev',None,
     '''
     spike n1=321 |
     math output="input*(82.5+67.5)/4" |
     put o1=-5280 d1=110 o2=1 n2=1 d2=1
     ''')
Flow('finalelev','lineelev shotelev','add scale=1,-1 ${SOURCES[1]}')

Flow('datum',['line','finalelev'],'datshift v0=10000 elev=${SOURCES[1]}')

Plot('selev','spelev',
     '''
     dd type=complex | transp | math output="(real(input)-100)*440 + imag(input)" |
     graph screenratio=0.8 min2=0 max2=140 min1=-3000 max1=30000
     font=2 labelsz=10 titlesz=16 labelfat=2 titlefat=4
     title="Elevation Profile" symbol="x"
     ''')

Plot('ielev','lineelev',
     '''
     graph screenratio=0.8 min2=0 max2=140 min1=-3000 max1=30000 title="Elevation Profile"
     font=2 labelsz=10 titlesz=16 labelfat=2 titlefat=4
     ''')

Result('elevprof','selev ielev','Overlay')

Result('datum',
       '''
       put label3= unit3=s |
       grey color=j allpos=n pclip=100 bias=0.012 scalebar=y title="Datum shift"
       font=2 labelsz=10 titlesz=16 labelfat=2 titlefat=4
       ''')

Flow('lineshift',['line','datum'],'datstretch datum=${SOURCES[1]}')

Flow('displine','lineshift','put n2=5472 n3=1 d2=1 o2=1')

Flow('gainline','displine', 'pow tpow=2')

##############################
# decon
##############################

Flow('spec','gainline','spectra all=y')
Plot('spec','spec',
     '''
     graph title="Average Spectrum Before Decon"
     min1=0 max1=120 label2='' unit2=''
     font=2 labelsz=10 titlesz=16 labelfat=2 titlefat=4
     ''')

Flow('acf','gainline',
     '''
     fft1 | math output="input*conj(input)" |
     fft1 inv=y | stack 
     ''')

Plot('acf',
     '''
     wiggle max1=0.1 transp=y seemean=y yreverse=y verb=y pclip=100
     title="ACF Before Decon"
     font=2 labelsz=10 titlesz=16 labelfat=2 titlefat=4 label2='' unit2=''
     ''')

# lag=80 ms, gap=7 ms for shallower part
Flow('filt lag','gainline',
     '''
     lopef a=80,1 w=3000,120 k=2,1 dim=2 lag=${TARGETS[1]} 
     ''')

Flow('decon','gainline filt',
     '''
     decon filt=${SOURCES[1]} | bandpass flo=8 fhi=60
     ''')
Flow('specdecon','decon','spectra all=y')

Plot('specdecon',
     '''
     graph title="Averege Spectrum After Decon"
     font=2 labelsz=10 titlesz=16 labelfat=2 titlefat=4
     min1=0 max1=120 unit2="" label2=""
     ''')

Result('specs','spec specdecon','SideBySideAniso')

Flow('autocrdecon','decon',
     '''
     fft1 | math output="input*conj(input)" |
     fft1 inv=y | stack 
     ''')

Plot('autocrdecon',
     '''
     wiggle max1=.1 title="ACF After Decon" transp=y
     seemean=y yreverse=y verb=y pclip=100 label2='' unit2=''
     font=2 labelsz=10 titlesz=16 labelfat=2 titlefat=4
     ''')

Result('acfs','acf autocrdecon','SideBySideAniso')

Flow('shotstat2','gainline',
     '''
     put n3=55 o3=0 n2=96 d2=110 d3=440 label2=Offset unit2=ft 
     ''')

Flow('cmp2','shotstat2',
     '''
     shot2cmp half=n |
     put n2=12 d2=880 o2=-5225 n3=535 d3=55 o3=-2612.5 
     ''')

Flow('semb2','cmp2',
     '''
     window f3=50 j3=20 n3=23 |
     sfvscan half=n semblance=y v0=5000 nv=251 dv=50
     ''')

Flow('pick2','semb2',
     '''
     mutter x0=10000 abs=n half=n inner=n slope0=0.00075 | 
     mutter x0=7500  abs=n half=n inner=y slope0=0.0015 |
     pick rect1=40 rect2=3 vel0=6000
     ''')

Flow('shotstat3','decon',
     '''
     put n3=55 o3=0 n2=96 d2=110 d3=440 label2=Offset unit2=ft 
     ''')

Flow('cmp3','shotstat3',
     '''
     shot2cmp half=n |
     put n2=12 d2=880 o2=-5225 n3=535 d3=55 o3=-2612.5
     ''')

Flow('semb3','cmp3',
     '''
     window f3=50 j3=20 n3=23 |
     sfvscan half=n semblance=y v0=5000 nv=251 dv=50
     ''')

Flow('pick3','semb3',
     '''
     mutter x0=10000 abs=n half=n inner=n slope0=0.00075 | 
     mutter x0=7500  abs=n half=n inner=y slope0=0.0015 |
     pick rect1=40 rect2=3 vel0=6000
     ''')

Flow('vel3','pick3',
     '''
     transp | spline n1=535 d1=55 o1=-2612.5 |
     transp |
     put n2=535 d2=55 o2=-2612.5 
     ''')

Result('vel3',
       '''
       window n2=450 f2=50 |
       grey allpos=y bias=8000 color=j scalebar=y pclip=100
       font=2 labelsz=10 titlesz=16 labelfat=2 titlefat=4
       title="Velocity" unit2="ft"
       ''')

#############
# NMO
#############

Flow('nmo',['cmp3','vel3'],'nmo velocity=${SOURCES[1]} half=n')

End()
