#!/bin/sh

warning()
{
    echo -en "\E[1m" # bold
    echo -n $1
    echo -e "\E[0m" # end highlighting
}

fatal_error()
{
    echo -en "\E[41m\E[93m " # yellow on red background
    echo -n $1
    echo -e " \E[0m" # end highlighting
}

findprog ()
{
    sifs=$IFS
    IFS=:
    prog="no"
    for dir in $PATH; do
	if [ -x $dir/$1 -a ! -d $dir/$1 ] ; then
	    prog="$dir/$1"
	    break
	fi
    done
    IFS=$sifs
}

findprog python
python=$prog
echo "checking for Python ... $python"
if test "$python" = "no"; then
    fatal_error "Please install Python before proceeding: http://www.python.org"
    exit 1
fi
python_v=`python -V 2>&1 | awk '{print $2}'`
echo "checking Python version ... $python_v"

root=${RSFROOT}
if test ! -n "$root"; then
    root="no"
fi
echo "checking for RSFROOT ... $root"
if test "$root" = "no"; then
    root=$HOME/RSF
    if test ! -d $root; then
	mkdir $root
    fi
    warning "I am temporarily setting RSFROOT to \"$root\"."
    warning "Please adjust your shell settings to set it permanently!"
    export RSFROOT=$root
fi

# if numpy is installed in userspace, then its site-packages subdirectory
# has to be in PYTHONPATH in order for "import numpy" to work
if test -n "${PYTHONPATH}"; then
    PYTHONPATH=${PYTHONPATH}:${RSFROOT}/lib
else
    PYTHONPATH=${RSFROOT}/lib
fi
export PYTHONPATH

findprog scons
scons=$prog
echo "checking for SCons ... $scons"
if test "$scons" = "no"; then
    here=`pwd`
    cd scons
    archive=`ls scons-*.tar.gz`
    gunzip < $archive | tar xf - > /dev/null
    dir=`ls -d scons-* | grep '[^mz]$'`
    cd $dir
    python setup.py install --prefix=${RSFROOT} > /dev/null
    cd $here
    scons="${RSFROOT}/bin/scons"
    if test ! -x "$scons"; then
	scons="failed"
    fi
    echo "Installing SCons ... $scons"
    if test "$scons" = "failed"; then
	fatal_error "SCons installation failed."
	fatal_error "Please check your Python installation!"
	exit 2
    fi
fi
scons_v=`scons -v 2>&1 | awk 'NR==2 {print $2}' | sed s/,//`
echo "checking SCons version ... $scons_v"

echo "Running $scons $* config ..."
rm -rf .scon* config.py
echo "------------------------"
$scons $* config
echo "------------------------"
echo "Done with configuration."
echo "SCONS = RFSROOT=$root PYTHONPATH=$PYTHONPATH $scons" > Makefile
cat Makefile.in >> Makefile
exit 0
